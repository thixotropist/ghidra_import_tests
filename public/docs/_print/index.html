<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://thixotropist.github.io/ghidra_import_tests/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://thixotropist.github.io/ghidra_import_tests/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/ghidra_import_tests/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/ghidra_import_tests/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-192x192.png" sizes="192x192">

<title>Documentation | Ghidra Import Testing</title>
<meta name="description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins.">
<meta property="og:title" content="Documentation" />
<meta property="og:description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://thixotropist.github.io/ghidra_import_tests/docs/" />

<meta itemprop="name" content="Documentation">
<meta itemprop="description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins."><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Documentation"/>
<meta name="twitter:description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins."/>




<link rel="preload" href="/ghidra_import_tests/scss/main.min.9d0cbaa1b344b1333f0397e66235629be3ef760469c16413abd609b3ba3dc13f.css" as="style">
<link href="/ghidra_import_tests/scss/main.min.9d0cbaa1b344b1333f0397e66235629be3ef760469c16413abd609b3ba3dc13f.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/ghidra_import_tests/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">Ghidra Import Testing</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/ghidra_import_tests/about/"><span>About</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/ghidra_import_tests/docs/"><span>Docs</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/ghidra_import_tests/docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Documentation</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-6557438925ac398717df86f494c6abb8">Overview</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-2235ec8f316773700ef08dd43b19a1c0">Glossary</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-7dde6c8f3fc8a451f95a3d975d9e394a">Exemplars</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-288264c1b3d511c2f537720546ab0d1d">Whisper_cpp</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-82e1212fbf9a7e85bfc9498444b73578">Data Plane Development Kit</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-2a60af35c245c04e830a46b84717e0d9">Issues</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-16337ed380c1ee4b8561a7a5066ceb57">autovectorization</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-7612c9d2f660efb43bc65a4e871b3395">inferring semantics from code patterns</a></li>


    
  
    
    
	
<li>3.3: <a href="#pg-a3f6f27ba868f5fb91d5881a937e0e59">link time optimization</a></li>


    
  
    
    
	
<li>3.4: <a href="#pg-8771ba72e91815ca70636658c86007ad">vector intrinsics</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-1a69e41432cb45419088ee30ed903b10">Gap Analysis Example</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-8d0cf167d96ef3b8c37351518f85816c">Examples</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-7cb98d558b94d2da397f926726be0b6a">Impact</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-1b1eb1e0bd770f075bf5f7b82b390ab4">Effort</a></li>


    
  
    
    
	
<li>4.4: <a href="#pg-cd44a52f518655bfeafd82fb4d424edb">Scope</a></li>


    
  
    
    
	
<li>4.5: <a href="#pg-e4e8adc613678dce506b389b4b3e7b27">Existing Frameworks</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-e91cac96d09d03fc802701da7875ce2e">Platforms and Toolchains</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-a0dbecf86134103ffa5a995386f0f036">ISA Extensions</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-ac78dfbfa527f45d19411db0b4780c07">Instruction Patterns</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-ceb842b555df01c318aedd8973d75baf">Application Survey</a></li>


    
  
    
    
	
<li>6.2: <a href="#pg-d77850d09fb290e7cb56386d07705a81">Application Top Down Analysis</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-072688248485f33579467bee95bae159">Testbed Internals</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-f87ee424d6df97dd57d1be27296c9cc4">adding toolchains</a></li>


    
  
    
    
	
<li>7.2: <a href="#pg-8215111beadc6b00e6019d3773f2d36a">debugging toolchains</a></li>


    
  
    
    
	
<li>7.3: <a href="#pg-79ca638449e551f530dec422e6c8c022">refreshing toolchains</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-99bc04328a000750d727f1aa33ff141a">Notes</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.1: <a href="#pg-219885af892566c9bd30c77d9270a0dc">Hardware Availability</a></li>


    
  
    
    
	
<li>8.2: <a href="#pg-11f98830a63a9bc25c2bc8239212c99f">Network Appliances</a></li>


    
  
    
    
	
<li>8.3: <a href="#pg-6b7b30f5489c07a9a0381508ed048f39">A vectorization case study</a></li>


    
  
    
    
	
<li>8.4: <a href="#pg-3a91620b69f843cc0ecd1d5560adadf5">Pcode testing</a></li>


    
  
    
    
	
<li>8.5: <a href="#pg-6f0fcd5d8c6b80f713f332dab5590581">Tracking Convergence</a></li>


    
  
    
    
	
<li>8.6: <a href="#pg-f22421eca6cb396b0451315422c932fa">Deep Dive Openssl</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      

<div class="pageinfo pageinfo-primary">
<p>The material here is loosely collected into a set of notes and examples.</p>

</div>

<p>&hellip;</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-6557438925ac398717df86f494c6abb8">1 - Overview</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>We can help Ghidra import newer binaries by collecting samples of those binaries.
The scope is limited to RISCV-64 Linux-capable processors one might find in smart network appliances
or Machine Learning inference engines.</p>

</div>

<blockquote>
<p>Note: This proof-of-concept project focuses on a single processor family, RISCV.
Some results are checked against equivalent x86_64 processors, to see if pending
issues are limited in scope or likely to hit a larger community</p>
</blockquote>
<p>This project collects files that may stress - in a good way - Ghidra&rsquo;s import, disassembly, and decompilation
capabilities.
Others are doing a great job extending Ghidra&rsquo;s ability to import
and recognize C++ structures and classes, so we will focus on lower level objects
like instruction sets, relocation codes, and pending toolchain improvements.
The primary CPU family will be based on
the RISCV-64 processor.  This processor is relatively new and easily modified, so
it will likely show lots of new features early.  Not all of these new features will
make it into common use or arenas in which Ghidra is necessary, so we don&rsquo;t really
know how much effort is worth spending on any given feature.</p>
<p>The RISCV processor family being relatively new, we can expect compiler and toolchain support to be evolving more rapidly than
more established families like x86_64.  That means RISCV appliances may be more likely to be built with newer compiler
toolchains than x86_64 appliances.</p>
<p>There are two key goals here:</p>
<ol>
<li>Experiment with Ghidra import integration tests that can detect Ghidra regressions.  This involves collecting
a number of processor and toolchain binary exemplars to be imported plus analysis scripts to verify those import results
remain valid.  Example: verify that ELF relocation codes are properly handled when importing a RISCV-64 kernel
module.  These integration tests should always pass after changes to Ghidra&rsquo;s source code.</li>
<li>Collect feature-specific binary exemplars that might highlight emergent gaps in
Ghidra&rsquo;s import processes.  Ghidra will usually
fail to properly import these exemplars, allowing the Ghidra development team to triage the gap and evaluate options for closing
it.  Example: pass the RISCV instruction set extension testsuite from <code>binutils/gas</code> into Ghidra to test whether Ghidra can
recognize all of the new instructions <code>gas</code> can generate.</li>
</ol>
<p>A secondary goal developed during testing - explore the impact on Ghidra users of vector instruction set extensions as used in aggressive
compiler optimization.  The RISCV 1.0 vector instructions as generated by the gcc 14.0 optimizing compiler can turn simple loops into more
complex instruction sequences.</p>
<p>The initial scope focuses on RISCV 64 bit processors capable of running a full Linux network stack, likely implementing
the <a href="https://github.com/riscv/riscv-profiles/blob/main/rva23-profile.adoc">2023 standard profile</a>.</p>
<p>We want to track recent additions to standard RISCV-64 toolchains (like <code>binutils</code> and <code>gcc</code>) to
see how they might make life interesting for Ghidra developers.  At present, that includes
newly frozen or ratified instruction set architecture (ISA) changes and compiler autovectorization
optimizations.  Some vendor-specific instruction set extensions will be included if they are accepted into
the <code>binutils</code> main branch.</p>
<h2 id="running-integration-tests">Running integration tests</h2>
<blockquote>
<p>Note: These scripts use both <code>unittest</code> and <code>logging</code> frameworks, where the loglevel is variously set at <code>INFO</code> or <code>WARN</code>.
The exact output may vary</p>
</blockquote>
<p>The first two steps collect binary exemplars for Ghidra to import.  Large binaries are extracted from public disk images,
such as the latest Fedora RISCV-64 system disk image.  Small binaries are generated locally from minimal C or C++ source
files and gcc toolchains.</p>
<p>The large binaries are downloaded and extracted using <code>acquireExternalExemplars.py</code>.  This script is built on the python <code>unittest</code> framework
to either verify the existence of previously extracted exemplars or regenerate those if missing.</p>
<p>The small binaries are created - if not already present - with the <code>generateInternalExemplars.py</code> script</p>
<blockquote>
<p>Warning: GCC-13 and GCC-14 binary toolchains are not included in this project.  Sources should be downloaded, compiled, and
installed to something like <code>/opt/...</code> then post-processed by bundled toolchain scripts into portable, hermetic tarballs.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> ./acquireExternalExemplars.py 
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...........
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Ran 11 tests in 0.003s
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">OK
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> ./generateInternalExemplars.py 
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">.......
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Ran 7 tests in 4.092s
</span></span></span></code></pre></div><p>The exemplar binaries can now be imported into two Ghidra projects - one for RISCV64 and another for x86_64.
The import process includes pre- and post-script processing.  Pre-script processing is used for the kernel import
to fix symbol names and load address.  Post-script processing is used for the kernel module import to gather
relocation results for later regression testing.  These relocation results are saved in <code>testresults/*.json</code></p>
<p>Import processing generates a log file for each binary imported into Ghidra.  If that log file is newer than the
binary, the import process is skipped.  If you want to rerun an import for foo.o, simply delete the matching log file in
<code>.../exemplars/foo.log.</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">OK
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> ./importExemplars.py
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">.INFO:root:Current Kernel import log file found - skipping import
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">.INFO:root:Current Kernel module import log file found - skipping import
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Ran 7 tests in 0.003s
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">OK
</span></span></span></code></pre></div><p>Test results gathered during binary imports and saved in <code>testresults/*.json</code> are now compared with expected
values in the final script:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> ./integrationTest.py 
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">inspecting the R_RISCV_BRANCH relocation test
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">inspecting the R_RISCV_JAL test
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">inspecting the R_RISCV_PCREL_HI20 1/2 test
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">inspecting the R_RISCV_PCREL_HI20 2/2 test
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">inspecting the R_RISCV_PCREL_LO12_I test
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">inspecting the R_RISCV_64 test
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">inspecting the R_RISCV_RVC_BRANCH test
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">inspecting the R_ADD_32 test
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">inspecting the R_RISCV_ADD64 test
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">inspecting the R_SUB_32 test
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">inspecting the R_RISCV_ADD64 test
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">inspecting the R_RISCV_RVC_JUMP test
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">----------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Ran 1 test in 0.000s
</span></span></span></code></pre></div><h2 id="ghidra-gap-analysis">Ghidra gap analysis</h2>
<p>We are looking for processor features that may soon be commonplace but that current Ghidra releases do not support well.
One such feature involves RISCV extensions to the instruction set architecture, especially vector and bit manipulation
extensions.  For each such feature we might consider the following questions:</p>
<ol>
<li>What is a current example of this feature, especially examples that support analysis or pathologies of those features.</li>
<li>How and when might this feature impact a significant number of Ghidra analysts?</li>
<li>How much effort might it take Ghidra developers to fill the implied feature gap?</li>
<li>Is this feature specific to RISCV systems or more broadly applicable to other processor families?  Would support for that
feature be common to many processor families or vary widely by processor?</li>
<li>What are the existing frameworks within Ghidra that might most credibly be extended to support that feature?</li>
</ol>
<p>Thread Local Storage (TLS) is a fairly simple feature we can use as an example.  Addressing each of the five questions in turn
we might find:</p>
<ol>
<li>TLS relocation codes appear occasionally in multithreaded applications across most processor families.  They might appear a few times
within <code>libc</code>.  Ghidra often doesn&rsquo;t recognize these codes.  Existing analytics like <code>objdump</code> and <code>readelf</code> certainly do recognize
TLS codes, but do not pretend to provide semantic aid in interpreting those codes.  TLS codes have well documented C source contexts in
the form of compiler <code>attributes</code>.</li>
<li>The TLS handling gap is unlikely to affect many Ghidra users anytime soon, mostly because they appear only rarely and mostly apply
to local variables where the decompiler can provide context.</li>
<li>Experienced Ghidra developers <em>might</em> be able to implement the general TLS case easily, but would then have to add supporting
ELF import code to a broader range of processor definitions.</li>
<li>The TLS feature is common across most processor families supporting multithreading.</li>
<li>Support within Ghidra might grow out of existing memory space models and existing processor-specific ELF importers.</li>
</ol>
<p>The general design questions boil down to:</p>
<ul>
<li>how long can we defer working on this gap?</li>
<li>how long would it take to fill that gap after we got started?</li>
<li>where would we likely want to start</li>
</ul>
<p>The Ghidra design team might assign TLS support a relatively low priority, since the gap doesn&rsquo;t currently have a large impact.
If the incidence and complexity of TLS suddenly increased, the extension of existing Ghidra support could likely increase just as
rapidly.</p>
<p>Extensions to Instruction Set Architectures make up a much more complicated example.  Standardized instructions for cache management
and cryptography are likely easy enough to fold into Ghidra&rsquo;s framework, but vector instruction extensions will hit harder and sooner,
without a clear path forward for Ghidra.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2235ec8f316773700ef08dd43b19a1c0">1.1 - Glossary</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Some of the commonly used terms in this project</p>

</div>

<dl>
<dt>exemplar</dt>
<dd>An example of a binary file one might expect Ghidra to accept as input.  This might be an ELF executable, an ELF object file or library of object files, a kernel load module,
or a kernel vmlinux image.  Ideally it should be relatively small and easy to screen for hidden malware.  Not all features demonstrated by the exemplar need be supported
by the current Ghidra release.</dd>
<dt>platform</dt>
<dd>The technology base one or more exemplars are used on.  A kernel exemplar expects to be run on top of a bootloader platform.  A Linux application exemplar may consider
the Linux kernel plus system libraries as its platform.  System libraries like libc.so can then be both exemplars and platform elements.</dd>
<dt>cross-compiler</dt>
<dd>A compiler capable of generating code for a processor other than the one it is running on.  An x86_64 gcc-13 compiler configured to generate RISCV-64 object files would be a cross-compiler.
Cross-compilers run on either the local host platform or on a Continuous Integration test server platform.</dd>
<dt>linker</dt>
<dd>A tool that takes one or more object files and resolves those runtime linkages internal to those object files.  Usually <code>ld</code> on a Linux system.  Often generates an ELF file
or a kernel image.</dd>
<dt>loader</dt>
<dd>A tool - often integrated with the kernel - that loads an Elf file into RAM.  The loader finalizes runtime linkages with external objects.  The loader will often rewrite
code (aka <code>relaxation</code>) to optimize memory references and so performance.</dd>
<dt>sysroot</dt>
<dd>The system root directories provide the interface between platform (kernel and system libraries) and user code.
This can be as simple as <code>/usr/include</code> or as complicated as a <code>sysroot/lib/ldscripts</code> holding
over 250 ld scripts detailing how a linker should generate code the kernel loader can fully process.
Cross-compiler toolchains often need to import a sysroot to build for a given kernel.  This can make for a circular dependency.</dd>
<dt>toolchain</dt>
<dd>A toolchain is an assembly of cross-compiler, linker, loader, and sysroot, plus a default set of options and switches for each component.  Different toolchains might share a gcc
crosscompiler but be configured for different platforms - building a kernel image, building <code>libc.so</code>, or building an executable application.</dd>
<dt>workspace</dt>
<dd>An environment that provides mappings between platforms and toolchains.  If you want to build an executable for a given platform, just name that platform on the command line
and the build tool will select a compatible toolchain and a <em>default</em> set of options.  You can still override those options.</dd>
<dt>hermetic</dt>
<dd>Build artifacts are not affected by any local host files other than those imported with the toolchain.  A hermetic build on a Fedora platform will generate exactly the same
binary output as if built on an Ubuntu platform.  This allows remote build servers to cache build artifacts and CI/CD servers to use exactly the same build environment as a diverse
development team.</dd>
</dl>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7dde6c8f3fc8a451f95a3d975d9e394a">2 - Exemplars</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>List the current importable and buildable exemplars, their origins, and the Ghidra features they are intended to validate or stress.</p>

</div>

<h2 id="overview">Overview</h2>
<p>Exemplars suitable for Ghidra import are generally collected by platform architecture, such as <code>riscv64/exemplars</code> or <code>x86_64/exemplars</code>.
Some are imported from system disk images.  Others are locally built from small source code files and an appropriate compiler toolchain.
The initial scope includes Linux-capable RISCV 64 bit systems that might be found in network appliances or ML inference engines.  That makes for a local
bias towards privileged code, concurrency management, and performance optimization.  That scope expands slightly to x86_64 exemplars that
may help triage issues that show up first in RISCV 64 exemplars.</p>
<p>You can get decent exemplar coverage with this set of exemplars:</p>
<ul>
<li>from a general purpose RISCV-64 disk image:
<ul>
<li>kernel - a RISCV-64 kernel built with a recent Linux release</li>
<li>kernel load module - an ELF binary intended to be loaded into a running kernel</li>
<li>system library - libc.so or libssl.so copied from a generic Linux disk image</li>
<li>system application - a user application linking against system libraries and running over a Linux kernel</li>
</ul>
</li>
<li>built from source, with the development tip of the gcc toolchain and many explicit ISA extensions:
<ul>
<li>binutils assembly test suite - ISA extensions usually show up here first, along with preferred disassembly patterns</li>
<li>memcpy and other libc replacements coded with RISCV-64 ISA intrinsic extensions</li>
<li><code>libssl.so</code> and <code>libcrypt.so</code> built from source and configured for all standard and frozen crypto, vector, and bit manipulation
instruction extensions.</li>
<li>DPDK network appliance source code, <code>l3fwd</code> and <code>l2fwd</code>.</li>
</ul>
</li>
</ul>
<p>In general, visual inspection of these exemplars after importing into Ghidra should show:</p>
<ul>
<li>no failed constructors, so all instructions are recognized by Ghidra during disassembly</li>
<li>no missing pcode</li>
<li>all vector vset* instructions are unwrapped to show selected element width, multiplier, tail and mask handling</li>
</ul>
<p>Ghidra will in a few cases disassemble an instruction differently than binutils&rsquo; <code>objdump</code>.  That&rsquo;s fine, if it is due to a limitation
of Ghidra&rsquo;s SLEIGH language. If alignment to <code>objdump</code> is possible, that&rsquo;s preferable.</p>
<h2 id="imported-exemplars">Imported exemplars</h2>
<p>Most of the imported large binary exemplars are broken out of current Fedora disk images.  The top level <code>acquireExternalExemplars.py</code>
script controls this process, sometimes with some manual intervention to handle image mounting.  Selection of the imported disk image
is controlled with text like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#000">LOGLEVEL</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">logging</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">WARN</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FEDORA_RISCV_SITE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;http://fedora.riscv.rocks/kojifiles/work/tasks/6900/1466900&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FEDORA_RISCV_IMAGE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Fedora-Developer-39-20230927.n.0-sda.raw&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FEDORA_KERNEL</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;vmlinuz-6.5.4-300.0.riscv64.fc39.riscv64&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FEDORA_KERNEL_OFFSET</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">40056</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FEDORA_KERNEL_DECOMPRESSED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;vmlinux-6.5.4-300.0.riscv64.fc39.riscv64&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FEDORA_SYSMAP</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;System.map-6.5.4-300.0.riscv64.fc39.riscv64&#34;</span>
</span></span></code></pre></div><h3 id="fedora-kernel">Fedora kernel</h3>
<p>This exemplar kernel is not an ELF file, so analysis of the import process will need
help.</p>
<ul>
<li>The import process explicitly sets the processor on the command line: <code>-processor RISCV:LE:64:RV64IC</code>.
This will likely be the same as the processor determined from imported kernel load modules.</li>
<li>Ghidra recognizes three sections, one text and two data.  All three need to be moved
to the offset suggested in the associated <code>System.map</code> file.  For example, <code>.text</code> moves from
0x1000 to 0x80001000.  Test this by verifying function start addresses identified in <code>System.map</code>
look like actual RISCV-64 kernel functions.  Most begin with 16 bytes of no-op instructions
to support debugging and tracing operations.</li>
<li>Mark <code>.text</code> as code by selecting from 0x80001000 to 0x80dfffff and hitting the <code>D</code> key.</li>
</ul>
<h4 id="verification">Verification</h4>
<p>Verify that kernel code correctly references data:</p>
<ol>
<li>locate the address of <code>panic</code> in <code>System.map</code>: ffffffff80b6b188</li>
<li>go to 0x80b6b188 in Ghidra and verify that this is a function</li>
<li>display references to <code>panic</code> and examine the decompiler window.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s_Fatal_exception_in_interrupt_813f84f8</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h4 id="notes">Notes</h4>
<p>This kernel includes 149 strings including <code>sifive</code>, most of which appear in <code>System.map</code>.  It&rsquo;s not immediately clear whether these
indicate kernel mods by SiFive or an SiFive SDK kernel module compiled into the kernel.</p>
<p>The kernel currently includes a few RISCV instruction set extensions not handled by Ghidra, and possibly not even by <code>binutils</code> and the <code>gas</code>
RISCV assembler.  Current Linux kernels can bypass the standard assembler to insert custom or obscure privileged instructions.</p>
<p>This Linux kernel explicitly includes ISA extension code for processors that support those extensions.  For example, if the kernel boots
up on a processor supporting the <code>_zbb</code> bit manipulation instruction extensions, then the vanilla <code>strlen</code>, <code>strcmp</code>, and <code>strncmp</code> kernel
functions are patched out to invoke <code>strlen_zbb</code>, <code>strcmp_zbb</code>, and <code>strncmp_zbb</code> respectively.</p>
<p>This kernel can support up to 64 discrete ISA extensions, of which about 30 are currently defined.  It has some support for hybrid processors,
where each of the hardware threads (aka &lsquo;harts&rsquo;) can support a different mix of ISA extensions.</p>
<blockquote>
<p>Note: The combination of instruction set extensions and self-modifying privileged code makes for a fertile ground for Ghidra research.
We can expect vector variants of <code>memcpy</code> inline expansion sometime in 2024, significantly complicating cyberanalysis of
even the simplest programs.</p>
</blockquote>
<h3 id="fedora-kernel-modules">Fedora kernel modules</h3>
<p>Kernel modules are typically ELF files compiled as Position Independent Code, often using more varied Elf relocation types
for dynamically loading and linking into kernel memory space.  This study looks at the <code>igc.ko</code> kernel module for a type
of Intel network interface device.  Network device drivers can have some of the most time-critical and race-condition-rich
behavior, making this class of driver a good exemplar.</p>
<p>RISCV relocation types found in this exemplar include:</p>
<p>R_RISCV_64(2), R_RISCV_BRANCH(16), R_RISCV_JAL(17), R_RISCV_CALL(18), R_RISCV_PCREL_HI20(23), R_RISCV_PCREL_LO12_I(24),
R_RISCV_ADD32(35), R_RISCV_ADD64(36), R_RISCV_SUB32(39), R_RISCV_SUB64(40), R_RISCV_RVC_BRANCH(44), and R_RISCV_RVC_JUMP(45)</p>
<h4 id="verification-1">Verification</h4>
<p>Open Ghidra&rsquo;s Relocation Table window and verify that all relocations were applied.</p>
<p>Go to <code>igc_poll</code>, open a decompiler window, and export the function as <code>igc_poll.c</code>.  Compare this file with the
provided <code>igc_poll_decompiled.c</code> in the visual difftool of your choice (e.g. <code>meld</code>) and check for the presence of lines
like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">netdev_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">_LC7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">lVar33</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">),</span><span style="color:#4e9a06">&#34;Unknown Tx buffer type</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>This statement generates - and provides tests for - at least four relocation types.</p>
<h4 id="notes-1">Notes</h4>
<p>The decompiler translates <em>all</em> fence instructions as <code>fence()</code>.  This kernel module uses 8 distinct <code>fence</code> instructions
to request memory barriers.  The sleigh files should probably be extended to show either <code>fence(1,5)</code> or the Linux macro names
given in <code>linux/arch/riscv/include/asm/barrier.h</code>.</p>
<h3 id="fedora-system-libraries">Fedora system libraries</h3>
<p>System libraries like <code>libc.so</code> and <code>libssl.so</code> typically link to versioned shareable object libraries like <code>libc.so.6</code> and <code>libssl.so.3.0.5</code>.  Ghidra imports
RISCV system libraries well.</p>
<p>Relocation types observed include:</p>
<p>R_RISCV_64(2), R_RISCV_RELATIVE(3), R_RISCV_JUMP_SLOT(5), and R_RISCV_TLS_TPREL64(11)</p>
<p>R_RISCV_TLS_TPREL64 is currently unsupported by Ghidra, appearing in the <code>libc.so.6</code> .got section about 15 times.  This relocation type does not appear
in <code>libssl.so.3.0.5</code>.  It appears in multithreaded applications that use thread-local storage.</p>
<h3 id="fedora-system-executables">Fedora system executables</h3>
<p>The <code>ssh</code> utility imports cleanly into Ghidra.</p>
<p>Relocation types observed include:</p>
<p>R_RISCV_64(2), R_RISCV_RELATIVE(3), R_RISCV_JUMP_SLOT(5)</p>
<p>Function thunks referencing external library functions do not automatically get the name of the external function propagated into the name of the thunk.</p>
<h2 id="locally-built-exemplars">Locally built exemplars</h2>
<p>Imported binaries are generally locked into a single platform and a single toolchain.  The imported binaries above are built for an SiFive
development board, a 64 bit RISCV processor with support for Integer and Compressed instruction sets, and a gcc-13 toolchain.  If we want some
variation on that, say to look ahead at challenges a gcc-14 toolchain might throw our way, we need to build our own exemplars.</p>
<p>Open source test suites can be a good source for feature-focused importable exemplars.  If we want to test Ghidra&rsquo;s ability to import RISCV instruction
set extensions, we want to import many of the files from <a href="https://sourceware.org/git?p=binutils-gdb.git;a=tree;f=gas/testsuite/gas/riscv;hb=HEAD">binutils-gdb/gas/testsuite/gas/riscv</a>.</p>
<p>For example, most of the ratified set of RISCV vector instructions are used in <code>vector-insns.s</code>.
If we assemble this with a <code>gas</code> assembler compatible with the <code>-march=rv32ifv</code> architecture
we get an importable binary exemplar for those instructions.
Even better, we can disassemble that exemplar with a compatible <code>objdump</code> and get the reference disassembly to compare against Ghidra&rsquo;s disassembly.
This gives us three kinds of insights into Ghidra&rsquo;s import capabilities:</p>
<ol>
<li>When new instructions appear in the <code>binutils</code> <code>gas</code> main branch, they are good candidates for implementation in Ghidra within the next 12 months.
This currently includes vector, bit manipulation, cache management, and crypto approved extensions plus about a dozen vendor-specific extensions
from AliBaba&rsquo;s THead RISCV server initiative.</li>
<li>These exemplars drive extension of Ghidra&rsquo;s RISCV sleigh files, both as new instruction definitions and as pcode semantics for display in the decompiler window.</li>
<li>Disassembly of those exemplars with a current <code>binutils</code> <code>objdump</code> utility gives us a reference disassembly to compare with Ghidra&rsquo;s.
We can minimize arbitrary or erroneous Ghidra disassembly by comparing the two disassembler views.
Ghidra and <code>objdump</code> have different goals, so we don&rsquo;t need strict alignment of Ghidra with <code>objdump</code>.</li>
</ol>
<p>Most exemplars appear as four related files.  We can use the <code>vector</code> exemplar as an example.</p>
<ul>
<li>The source file is <code>riscv64/toolchain/assemblySamples/vector.S</code>, copied from <code>binutils-gdb/gas/testsuite/gas/riscv/vector-insns.s</code>.</li>
<li><code>vector.S</code> is assembled into <code>riscv64/exemplars/vector.o</code></li>
<li>That assembly run generates the assembly output listing <code>riscv64/exemplars/vector.log</code>.</li>
<li><code>riscv64/exemplars/vector.o</code> is finally processed by <code>binutils</code> <code>objdump</code> to generate the reference disassembly <code>riscv64/exemplars/vector.objdump</code>.</li>
</ul>
<p>The <code>riscv64/exemplars/vector.o</code> is then imported into the Ghidra <code>exemplars</code> project, where we can evaluate the import and disassembly results.</p>
<p>Assembly language exemplars usually don&rsquo;t have any sensible decompilation.  C or C++ language exemplars usually do, so that gives the test analyst more to work with.</p>
<p>Another example shows Ghidra&rsquo;s difficulty with vector optimized code.  Compile this C code for the <code>rv64gcv</code> architecture (RISCV-64 with vector extensions), using the
gcc-14 toolchain due for mid 2024 release.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1320</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;\0&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Ghidra&rsquo;s 11.0 release decompiles this into:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>/* WARNING: Control flow encountered unimplemented instructions */
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void main(void)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  gp = &amp;__global_pointer$;
</span></span><span style="display:flex;"><span>                    /* WARNING: Unimplemented instruction - Truncating control flow here */
</span></span><span style="display:flex;"><span>  halt_unimplemented();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Try the import again with the <code>isa_ext</code> experimental branch of Ghidra:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>undefined8 main(void)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  undefined auVar1 [64];
</span></span><span style="display:flex;"><span>  undefined8 uVar2;
</span></span><span style="display:flex;"><span>  undefined (*pauVar3) [64];
</span></span><span style="display:flex;"><span>  long lVar4;
</span></span><span style="display:flex;"><span>  long lVar5;
</span></span><span style="display:flex;"><span>  undefined auVar6 [256];
</span></span><span style="display:flex;"><span>  undefined auVar7 [256];
</span></span><span style="display:flex;"><span>  char local_540 [1319];
</span></span><span style="display:flex;"><span>  undefined uStack_19;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  gp = &amp;__global_pointer$;
</span></span><span style="display:flex;"><span>  pauVar3 = (undefined (*) [64])local_540;
</span></span><span style="display:flex;"><span>  lVar4 = 0x527;
</span></span><span style="display:flex;"><span>  vsetvli_e32m1tama(0);
</span></span><span style="display:flex;"><span>  auVar7 = vid_v();
</span></span><span style="display:flex;"><span>  do {
</span></span><span style="display:flex;"><span>    lVar5 = vsetvli(lVar4,0xcf);
</span></span><span style="display:flex;"><span>    auVar6 = vmv1r_v(auVar7);
</span></span><span style="display:flex;"><span>    lVar4 = lVar4 - lVar5;
</span></span><span style="display:flex;"><span>    auVar6 = vncvt_xxw(auVar6);
</span></span><span style="display:flex;"><span>    vsetvli(0,0xc6);
</span></span><span style="display:flex;"><span>    auVar6 = vncvt_xxw(auVar6);
</span></span><span style="display:flex;"><span>    auVar6 = vadd_vi(auVar6,1);
</span></span><span style="display:flex;"><span>    auVar1 = vse8_v(auVar6);
</span></span><span style="display:flex;"><span>    *pauVar3 = auVar1;
</span></span><span style="display:flex;"><span>    uVar2 = vsetvli_e32m1tama(0);
</span></span><span style="display:flex;"><span>    pauVar3 = (undefined (*) [64])(*pauVar3 + lVar5);
</span></span><span style="display:flex;"><span>    auVar6 = vmv_v_x(lVar5);
</span></span><span style="display:flex;"><span>    auVar7 = vadd_vv(auVar7,auVar6);
</span></span><span style="display:flex;"><span>  } while (lVar4 != 0);
</span></span><span style="display:flex;"><span>  uStack_19 = 0;
</span></span><span style="display:flex;"><span>  printf(local_540,uVar2);
</span></span><span style="display:flex;"><span>  return 0;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>That Ghidra branch decompiles, but the decompilation listing only resembles the C source code if you are familiar with RISCV vector extension instructions.</p>
<p>Repeat the example, this time building with a gcc-13 toolchain.  Ghidra 11.0 does a fine job of decompiling this.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">undefined8</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">acStack_541</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1320</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">uStack_19</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">acStack_541</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">lVar1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">char</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar1</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar1</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0x528</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uStack_19</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">acStack_541</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="x86_64-exemplars">x86_64 exemplars</h3>
<p>A few x86_64 exemplars exist to explore the scope of issues raised by RISCV exemplars.  The <code>x86_64/exemplars</code> directory
shows how optimizing gcc-14 compilations handle simple loops and built-ins like <code>memcpy</code> for various microarchitectures.</p>
<p>Intel microarchitectures can be grouped into common profiles like <code>x86-64-v2</code>, <code>x86-64-v3</code>, and <code>x86-64-v4</code>.  Each has its own set of
instruction set extensions, so an optimizing compiler like gcc-14 will autovectorize loops and built-ins differently for each microarchitecture.</p>
<p>The <code>memcpy</code> exemplar set includes source code and three executables compiled from that source code with <code>-march=x86-64-v2</code>, <code>-march=x86-64-v3</code>, and
<code>-march=x86-64-v4</code>.  The binutils-2.41 <code>objdump</code> disassembly is provided for each executable, for comparison with Ghidra&rsquo;s disassembly window.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">x86_64/exemplars$ ls memcpy*
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">memcpy.c  memcpy_x86-64-v2  memcpy_x86-64-v2.objdump  memcpy_x86-64-v3  memcpy_x86-64-v3.objdump  memcpy_x86-64-v4  memcpy_x86-64-v4.objdump
</span></span></span></code></pre></div><p>These exemplars suggest several Ghidra issues:</p>
<ul>
<li>Ghidra&rsquo;s disassembler is generally unable to recognize many vector instructions generated by gcc-14 with <code>-march=x86-64-v4</code> and <code>-O3</code>.</li>
<li>Ghidra&rsquo;s decompiler provides the user little help in recognizing the semantics of <code>memcpy</code> or many simple loops with <code>-march=x86-64-v2</code> or <code>-march=x86-64-v3</code>.</li>
<li>Ghidra users should be prepared for wide variety in vector optimized instruction sequences.  Pattern recognition will be difficult.</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-288264c1b3d511c2f537720546ab0d1d">2.1 - Whisper_cpp</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Explore analysis of a machine learning application built with large language model techniques.  What Ghidra gaps does such an analysis reveal?</p>

</div>

<p>How might we inspect a machine-learning application for malware? For example, suppose someone altered the automatic speech recognition library <a href="https://github.com/ggerganov/whisper.cpp">whisper.cpp</a>.  Would Ghidra be able to cope with the instruction set extensions used to accelerate ML inference engines?  What might be added to Ghidra to help the human analyst in this kind of inspection?</p>
<p>Components for this exercise:</p>
<ul>
<li>A Linux x86_64 Fedora 39 base system</li>
<li>Ghidra 11.0 public</li>
<li>Ghidra 11.1-DEV with the <code>isa_ext</code> branch for RISCV-64 support</li>
<li>A stripped target binary <code>whisper_cpp_vendor</code> built with RISCV-64 gcc-14 toolchain and the whisper.cpp 1.5.4 release.
<ul>
<li>RISCV-64 vector and other approved extensions are enabled for this build</li>
<li>published binutils-2.41 vendor-specific extensions are enabled for this build</li>
<li>whisper library components are statically linked, while system libraries are dynamically linked</li>
</ul>
</li>
<li>Reference binaries <code>whisper_cpp_*</code> built locally with other RISCV-64 gcc toolchains</li>
<li>Ghidra&rsquo;s BSIM binary similarities plugins and analytics</li>
</ul>
<p>Questions to address:</p>
<ul>
<li>does the presence of vector and other ISA extensions in <code>whisper_cpp_vendor</code> materially hurt Ghidra 11.0 analysis?</li>
<li>can BSIM analytics still find similarities between <code>whisper_cpp_vendor</code> and the non-vector build <code>whisper_cpp_default</code></li>
<li>are there recurring vector instruction patterns present in <code>whisper_cpp_vendor</code> that Ghidra users should be able to recognize?</li>
<li>are there additional instructions or instruction-semantics that we should add to the <code>isa_ext</code> branch?</li>
<li>if the vendor adds Link Time Optimization to their <code>whisper_cpp_vendor</code> build, does this materially hurt Ghidra 11.0 analysis?</li>
</ul>
<p>There are a lot of variables in this exercise.  Some are important, most are not.</p>
<h2 id="baseline-ghidra-analysis">Baseline Ghidra analysis</h2>
<p>Starting with the baseline Ghidra 11.0, examine a locally built <code>whisper_cpp_default</code>, an ELF 64-bit LSB executable built with gcc-13.2.1.
Import and perform standard analyses to get these statistics:</p>
<ul>
<li>186558 instructions recognized</li>
<li>text segment size 0x8678a</li>
<li>12 bad instruction errors, all of which appear to be the <code>fence.tso</code> instruction extension</li>
</ul>
<p>Now examine <code>whisper_cpp_vendor</code> (built with gcc 14 rather than gcc 13) with the baseline Ghidra 11.0:</p>
<ul>
<li>100521 instructions recognized</li>
<li>text segment size 0xb93cc</li>
<li>4299 bad instruction errors</li>
</ul>
<p>Examine <code>whisper_cpp_vendor</code> with the <code>isa_ext</code> branch of 11.1-DEV:</p>
<ul>
<li>169813 instructions recognized</li>
<li>text segment size 0xb93cc</li>
<li>17 bad instruction errors, all of which appear to be the <code>fence.tso</code> instruction extension</li>
</ul>
<p>Next apply a manual correction to <code>whisper_cpp_vendor</code>, selecting the entire <code>.text</code> segment and
forcing disassembly, then clearing any unreachable 0x00 bytes.</p>
<ul>
<li>190311 instructions recognized</li>
<li>17 bad instruction errors</li>
<li>4138 <code>vset*</code> instructions usually found in vector code</li>
<li>946 <code>gather</code> instructions</li>
<li>3562 <code>custom</code> instructions</li>
</ul>
<p>Finally, reset the &rsquo;language&rsquo; of <code>whisper_cpp_vendor</code> to match the vendor (THead, for this exercise).</p>
<p>The 3562 custom instructions resolve to:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Instruction</th>
<th style="text-align:right">Count</th>
<th style="text-align:left">Semantics</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">th.ext*</td>
<td style="text-align:right">151</td>
<td style="text-align:left">Sign extract and extend</td>
</tr>
<tr>
<td style="text-align:left">th.ldd</td>
<td style="text-align:right">1719</td>
<td style="text-align:left">Load 2 doublewords</td>
</tr>
<tr>
<td style="text-align:left">th.lwd</td>
<td style="text-align:right">10</td>
<td style="text-align:left">Load 2 words</td>
</tr>
<tr>
<td style="text-align:left">th.sdd</td>
<td style="text-align:right">1033</td>
<td style="text-align:left">store 2 doublewords</td>
</tr>
<tr>
<td style="text-align:left">th.swd</td>
<td style="text-align:right">16</td>
<td style="text-align:left">store 2 words</td>
</tr>
<tr>
<td style="text-align:left">th.mula</td>
<td style="text-align:right">284</td>
<td style="text-align:left">Multiply-add</td>
</tr>
<tr>
<td style="text-align:left">th.muls</td>
<td style="text-align:right">67</td>
<td style="text-align:left">Multiply-subtract</td>
</tr>
<tr>
<td style="text-align:left">th.mveqz</td>
<td style="text-align:right">127</td>
<td style="text-align:left">Move if == 0</td>
</tr>
<tr>
<td style="text-align:left">th.mvneqz</td>
<td style="text-align:right">154</td>
<td style="text-align:left">Move if != 0</td>
</tr>
</tbody>
</table>
<p>This leads to some tentative next steps:</p>
<ol>
<li>Adding <code>fence.tso</code> to Ghidra looks like a simple small win, and a perfect place to start.</li>
<li>The THead vendor-specific extensions look like simple peep-hole optimizations.  The semantics could
easily be added to Ghidra as compositions of two original instruction semantics.  Slightly less than 2% of the total instructions are THead vendor customizations.</li>
<li>The baseline Ghidra 11.0 stalls out very quickly on the vector instructions, making an early switch
to the <code>isa_ext</code> branch necessary.</li>
<li>The vector <code>gather</code> instructions are unexpectedly prevalent.</li>
<li>Manual inspection and sampling of the 4138 <code>vset*</code> instruction blocks may reveal some key patterns to
recognize first.</li>
</ol>
<blockquote>
<p>Note: <code>fence.tso</code> is now recognized in the Ghidra 11.1-DEV branch <code>isa_ext</code>,
clearing the <code>bad instruction errors</code>.</p>
</blockquote>
<h2 id="a-top-down-assessment">A top-down assessment</h2>
<p>At the highest level, what features of <code>whisper.cpp</code> generate vector instructions?</p>
<ul>
<li>There are about 400 invocations of RISCV vector intrinsic within <code>ggml-quants.c</code>.  In these cases the developer
has explicitly managed the vectorization.</li>
<li>There are an unknown number of automatic loop vectorizations, where gcc-14 has replaced simple scalar loops with
vector-based loops.  This vectorization will generally reduce the number of loop iterations, but may not always reduce
the number of instructions executed.</li>
<li>Gcc expansions of <code>memcpy</code> or structure copies into vector load-store loops.</li>
</ul>
<p>Much of <code>whisper.cpp</code> involves vector, matrix, or tensor math using <code>ggml</code> math functions.  This is also where most
of the explicit RISCV vector intrinsic C functions appear, and likely the code the developer believes is most in need
of vector performance enhancements.</p>
<h3 id="example-dot-product">Example: dot product</h3>
<p><code>ggml_vec_dot_f32(n, sum, x, y)</code> generates the vector dot product of two vectors x and y of length n with the result
stored to <code>*sum</code>.  In the absence of vector or SIMD support the source code is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// scalar
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">sumf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sumf</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sumf</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>GCC-14 will autovectorize this into something Ghidra decompiles like this (comments added after <code>//</code>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">ggml_vec_dot_f32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">step</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">dVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar2</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v2</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar3</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e64m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>                  <span style="color:#8f5902;font-style:italic">// v2 = 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">step</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x97</span><span style="color:#000;font-weight:bold">);</span>          <span style="color:#8f5902;font-style:italic">// vsetvli a5,a0,e32,mf2,tu,ma
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">step</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">);</span>             <span style="color:#8f5902;font-style:italic">// v3 = *x (slice of size step)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">);</span>             <span style="color:#8f5902;font-style:italic">// v1 = *y (slice of size step)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">sh2add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">step</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">);</span>      <span style="color:#8f5902;font-style:italic">// x = x + step
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar3</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// v1 = v1 * v3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">sh2add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">step</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">);</span>      <span style="color:#8f5902;font-style:italic">// y = y + step
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">in_v2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfwadd_wv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// v2 = v1 + v2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e64m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmv_sf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>                 <span style="color:#8f5902;font-style:italic">// v1[0] = 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfredusum_vs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// v1[0] = sum(v2)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">dVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">vfmv_fs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">);</span>     <span style="color:#8f5902;font-style:italic">// dvar1 = v1[0]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">dVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Inspecting this disassembly and decompilation suggests several top down issues:</p>
<ul>
<li>The semantics for <code>shadd2</code> are simple and should be explicit <code>sh2add(a, b) = a&gt;&gt;2 + b</code>
<ul>
<li>This is now implemented in Ghidra 11.1-DEV isa_ext.</li>
</ul>
</li>
<li>The <code>vsetvli(n,0x97)</code> instruction should be expanded to show semantics as <code>vsetvli_e32m2ftuma</code>
<ul>
<li>Running the binary through a RISCV objdump program gives us this formal expansion.  This instruction
says that the selected element width is 32 bits with a LMUL multiplication factor of 1/2.  This means that only
half of the vector register is used to allow for 64 bit arithmetic output.</li>
<li>This is now implemented in Ghidra 11.1-DEV isa_ext.</li>
</ul>
</li>
<li>The semantics for vector results need clarification</li>
<li>The loop accumulates 64 bit double values with 32 bit input values.  If the vector length is 256 bits, that means
the step size is 4 not 8</li>
<li>A capability to generate processor-specific inline hints or comments in the decompiler may be useful, especially if
there were a typographic way to distinguish vector and scalar objects.</li>
<li>If vector registers were infinitely long the loop might become <code>v2 = x * y</code> and the reduction <code>dvar1 = reduce(+, v2)</code></li>
</ul>
<p>The path forward may be to manually analyze several examples from <code>whisper.cpp</code>, extending and revising Ghidra&rsquo;s semantics
and decompiler to add a bit of clarity each time.</p>
<h3 id="example-auto-vectorization-makes-the-simple-complicated">Example: auto-vectorization makes the simple complicated</h3>
<p>Autovectorization can generate complicated code when the compiler has no knowledge of the number of elements in
a vector or the number of elements that can fit within single vector register.</p>
<p>A good example is from:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">ggml_tensor</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ggml_new_tensor_impl</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ggml_context</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">enum</span>   <span style="color:#000">ggml_type</span>      <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span>                   <span style="color:#000">n_dims</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int64_t</span>       <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ne</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ggml_tensor</span>  <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">view_src</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">size_t</span>                <span style="color:#000">view_offs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ggml_row_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ne</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n_dims</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">*=</span> <span style="color:#000">ne</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The <code>ne</code> vector typically has up to 4 elements, so this loop will be executed at most once.  The compiler doesn&rsquo;t know this so it
autovectorizes the loop into something more complex:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">undefined4</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ggml_new_tensor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ggml_context</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">undefined8</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">ndims</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">int64_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ne</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ggml_row_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ne</span><span style="color:#000;font-weight:bold">);</span>              <span style="color:#8f5902;font-style:italic">// get the first dimension ne[0]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">lVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">ndims</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">uVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ndims</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ndims</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">2U</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>                      <span style="color:#8f5902;font-style:italic">// if ndims &gt; 3 process two at a time
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">piVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ne</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>                              <span style="color:#8f5902;font-style:italic">// starting with ne[1] and ne[2]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">piVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">piVar7</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">uVar2</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetivli_e64m1tamu</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>                        <span style="color:#8f5902;font-style:italic">//vector length = 2, 64 bit element, tail agnostic mask unchanged
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>                             <span style="color:#8f5902;font-style:italic">// v1 = (1,1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle64_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">piVar7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">piVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">piVar7</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">in_v1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>              <span style="color:#8f5902;font-style:italic">// v1 = v1 * ne[slice]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">piVar4</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">piVar7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vid_v</span><span style="color:#000;font-weight:bold">();</span>                             <span style="color:#8f5902;font-style:italic">// v2 = (0,1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>                              <span style="color:#8f5902;font-style:italic">// v4 = (0,0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vadd_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>                  <span style="color:#8f5902;font-style:italic">// v2 = v2 + 1 = (1,2)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vmsgtu_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>                <span style="color:#8f5902;font-style:italic">// v0 = (v2 &gt; 1) = (0, 1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">vrgather_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>                    <span style="color:#8f5902;font-style:italic">// v3 = gather(v1, v2) =&gt; v3=v1[v2] = (v1[1], 0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vadd_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xfffffffffffffffe</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// v2 = v2 - 2 = (-1,0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vrgather_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// v3 = gather_masked(v4,v2,v0.t) = (v3[0], v4[0])
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">);</span>              <span style="color:#8f5902;font-style:italic">// v3 = v3 * v1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">vmv_x_s</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v14</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>                       <span style="color:#8f5902;font-style:italic">// a4 = v3[0]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">piVar4</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">// data_size = data_size * a4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">uVar2</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">LAB_00074a80</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">lVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#000">uVar2</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xfffffffe</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">plVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">sh3add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">ne</span><span style="color:#000;font-weight:bold">);</span>               <span style="color:#8f5902;font-style:italic">// multiply by one or two 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">plVar5</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">// 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar6</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">ndims</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">plVar5</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>That&rsquo;s a very confusing way to multiply at most four integers.  If ne has 1, 2, or 3 elements then no vector instructions are processed at all.
If it has 4 elements then the first and last one or two are handled with scalar math while pairs of elements are accumulated in the loop.
The gather instructions are used together to generate a mask and then multiply the two elements of vector v1, leaving the result in the first
element slot of vector v4.</p>
<p>This particular loop vectorization is likely to change a lot in future releases.  The performance impact is negligible either way.  The analyst may
look at code like this and decide to ignore the ndims&gt;3 case along with <em>all</em> of the vector instructions used within it.  Alternatively, we could
look at the gcc vectorization code handling the general vector reduction meta operation, then see if this pattern is a macro of some sort within it.</p>
<p>Take a step back and look at the gcc RISCV autovectorization code.  It&rsquo;s changing quite frequently, so it&rsquo;s probably premature to try and abstract out
loop reduction models that we can get Ghidra to recognize.  When that happens we might draw source exemplars from
<code>gcc/gcc/testsuite/gcc.target/riscv/rvv/autovec</code> and build a catalog of source pattern to instruction pattern expansions.</p>
<h3 id="example-source-code-use-of-riscv-vector-intrinsics">Example: source code use of RISCV vector intrinsics</h3>
<p>The previous example showed an overly aggressive autovectorization of a simple loop.  Here we look at source code that the developer has decided is important enough
to directly code in RISCV intrinsic C functions.  The function <code>ggml_vec_dot_q5_0_q8_0</code> is one such function, with separate implementations for <code>ARM_NEON</code>, <code>wasm_simd128</code>,
<code>AVX2</code>, <code>AVX</code>, and <code>riscv_v_intrinsic</code>.  If none of those accelerators are available a scalar implementation is used instead:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">ggml_vec_dot_q5_0_q8_0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">vx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">qk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">qk</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">qk</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">qk</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">QK5_0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">block_q5_0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vx</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// scalar
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">sumf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nb</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">uint32_t</span> <span style="color:#000">qh</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">qh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">qh</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sumi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">qk</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">uint8_t</span> <span style="color:#000">xh_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">qh</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1u</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">)))</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">uint8_t</span> <span style="color:#000">xh_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">qh</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1u</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)))</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int32_t</span> <span style="color:#000">x0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x0F</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">xh_0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int32_t</span> <span style="color:#000">x1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span>   <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">xh_1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">sumi</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">x0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">x1</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">qk</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sumf</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">GGML_FP16_TO_FP32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">GGML_FP16_TO_FP32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">sumi</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sumf</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The RISCV intrinsic source is:</p>
<blockquote>
<p>Note: added comments are flagged with <code>///</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">ggml_vec_dot_q5_0_q8_0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">vx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">qk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">/// QK8_0 = 32
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">qk</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">qk</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">qk</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">QK5_0</span><span style="color:#000;font-weight:bold">);</span>   <span style="color:#8f5902;font-style:italic">/// QK5_0 = 32
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">block_q5_0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vx</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">sumf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">uint32_t</span> <span style="color:#000">qh</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">vl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsetvl_e8m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">qk</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// These temporary registers are for masking and shift operations
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">vt_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vid_v_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">vt_2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsll_vv_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__riscv_vmv_v_x_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">vt_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">vt_3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsll_vx_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vt_2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">vt_4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vadd_vx_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vt_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nb</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">qh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">uint32_t</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// ((qh &amp; (1u &lt;&lt; (j + 0 ))) &gt;&gt; (j + 0 )) &lt;&lt; 4;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">xha_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vand_vx_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vt_2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">qh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">xhr_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsrl_vv_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xha_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vt_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">xhl_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsll_vx_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xhr_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// ((qh &amp; (1u &lt;&lt; (j + 16))) &gt;&gt; (j + 12));
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">xha_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vand_vx_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vt_3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">qh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">xhl_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsrl_vv_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xha_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vt_4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// narrowing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vuint16m1_t</span> <span style="color:#000">xhc_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vncvt_x_x_w_u16m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xhl_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">xh_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vncvt_x_x_w_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xhc_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint16m1_t</span> <span style="color:#000">xhc_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vncvt_x_x_w_u16m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xhl_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">xh_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vncvt_x_x_w_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xhc_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// load
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">tx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vle8_v_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8mf2_t</span> <span style="color:#000">y0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vle8_v_i8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8mf2_t</span> <span style="color:#000">y1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vle8_v_i8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">x_at</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vand_vx_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x0F</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">x_lt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsrl_vx_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x04</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">x_a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vor_vv_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_at</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xh_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">x_l</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vor_vv_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_lt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xh_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8mf2_t</span> <span style="color:#000">x_ai</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vreinterpret_v_u8mf2_i8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_a</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8mf2_t</span> <span style="color:#000">x_li</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vreinterpret_v_u8mf2_i8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_l</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8mf2_t</span> <span style="color:#000">v0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsub_vx_i8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_ai</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8mf2_t</span> <span style="color:#000">v1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsub_vx_i8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_li</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint16m1_t</span> <span style="color:#000">vec_mul1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vwmul_vv_i16m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint16m1_t</span> <span style="color:#000">vec_mul2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vwmul_vv_i16m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint32m1_t</span> <span style="color:#000">vec_zero</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vmv_v_x_i32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint32m1_t</span> <span style="color:#000">vs1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vwredsum_vs_i16m1_i32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vec_mul1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vec_zero</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint32m1_t</span> <span style="color:#000">vs2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vwredsum_vs_i16m1_i32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vec_mul2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vs1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sumi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vmv_x_s_i32m1_i32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vs2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sumf</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">GGML_FP16_TO_FP32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">GGML_FP16_TO_FP32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">sumi</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sumf</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Ghidra&rsquo;s 11.1 isa_ext rendering of this is (after minor parameter name propagation):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">ggml_vec_dot_q5_0_q8_0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">vx</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">vy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ushort</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">puVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar6</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">fVar7</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar8</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar9</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar10</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar11</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v7</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v8</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar12</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar13</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar14</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar15</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar16</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iStack_4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsetivli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xc0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar13</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vid_v</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar15</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vadd_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xc</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar12</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsll_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsll_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x1f</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar6</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">vx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">vy</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetivli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xc6</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">iStack_4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">puVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ushort</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vand_vx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iStack_4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsrl_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vand_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsll_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsrl_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar16</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vand_vx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iStack_4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vor_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsrl_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar15</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vadd_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xfffffffffffffff0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vwmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar16</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">lVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vwredsum_vs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">in_v7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vor_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vadd_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xfffffffffffffff0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vwmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vwredsum_vs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetivli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vmv_x_s</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar15</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x22</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">fVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ggml_table_f32_f16</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">puVar1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ggml_table_f32_f16</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ushort</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)]</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar5</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">fVar7</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x16</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(((</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1f</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fVar7</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>It looks like the developer unrolled an inner loop and used the LMUL multiplier to help reduce the loop iterations.  The immediate action item for us may be to
add more explicit decodings for <code>vsetvli</code> and <code>vsetivli</code>, or look for existing processor-specific decoders in the Ghidra decompiler.</p>
<h3 id="x86_64-whisper">x86_64 whisper</h3>
<p>Let&rsquo;s take a glance at the x86_64 build of <code>whisper</code>.  First copy <code>whisper-cpp.BUILD</code> into the x86_64 workspace then build the executable with two architectures:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:x86_64_default --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-march=x86-64-v3&#34;</span> @whisper_cpp//:main
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> cp bazel-bin/external/whisper_cpp/main ../exemplars/whisper_cpp_x86-64-v3
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> bazel build --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:x86_64_default --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-march=x86-64-v4&#34;</span> @whisper_cpp//:main
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> cp bazel-bin/external/whisper_cpp/main ../exemplars/whisper_cpp_x86-64-v4
</span></span></code></pre></div><p>Load these into Ghidra 11.1-DEV.  The <code>x86-64-v4</code> build is useless in Ghidra, since a different class of x86_64 vector extensions is used in that newer microarchitecture
and Ghidra doesn&rsquo;t recognize it.  The <code>x86-64-v3</code> build looks accessible.</p>
<p>Try an x86_64 build with the local compiler (Fedora 39 default compiler) and Link Time Optimization enabled:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build  --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-march=x86-64-v3&#34;</span> --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-flto&#34;</span>  --linkopt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-Wl,-flto&#34;</span> @whisper_cpp//:main
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> cp bazel-bin/external/whisper_cpp/main ../exemplars/whisper_cpp_x86-64-v3-lto
</span></span></code></pre></div><p>We&rsquo;ll leave the differential analysis of link time optimization for another day.  A couple of quick notes are worthwhile here:</p>
<ul>
<li>The function <code>ggml_new_tensor</code> no longer exists in the binary.  Instead we get <code>ggml_new_tensor_impl.constprop.0</code>
<code>ggml_new_tensor_impl.constprop.0</code>, <code>ggml_new_tensor_impl.constprop.2</code>, and <code>ggml_new_tensor_impl.constprop.3</code>.
This suggests BSIM could get confused with intermediate functions if trying to connect binaries built with and without LTO.</li>
<li><em>None</em> of the hermetic toolchains appear to work when link time optimization is requested.  There appears to be at least one missing
LTO plugin from the gcc-14 toolchain packaging.  We&rsquo;ll try and find such for the next snapshot of gcc-14.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-82e1212fbf9a7e85bfc9498444b73578">2.2 - Data Plane Development Kit</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Intel&rsquo;s DPDK framework supports some Intel and Arm Neon vector instructions.  What does it for RISCV extensions?
Are ISA extensions materially useful to a network appliance?</p>

</div>

<p>Check out DPDK from GitHub, patch the RISCV configuration with <code>riscv64/toolchains/dpdk/dpdk.pat</code>, and crosscompile with <code>meson</code>
and <code>ninja</code>.  Copy some of the examples into <code>riscv64/exemplars</code> and examine them in Ghidra.</p>
<ul>
<li>for this we use as many standard extensions as we can, excluding vendor-specific extensions.</li>
</ul>
<p>Configure a build directory:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> patch -p1 &lt; .../riscv64/toolchains/dpdk/dpdk.pat
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> meson setup build --cross-file config/riscv/riscv64_linux_gcc -Dexamples<span style="color:#ce5c00;font-weight:bold">=</span>all
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> <span style="color:#204a87">cd</span> build
</span></span></code></pre></div><p>Edit <code>build/build.ninja</code>:</p>
<ul>
<li>replace all occurrences of <code>-ldl</code> with <code>/opt/riscvx/lib/libdl.a</code> - you should see about 235 replacements</li>
</ul>
<p>Build with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> ninja -C build
</span></span></code></pre></div><p>Check the cross-compilation with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> readelf -A build/examples/dpdk-l3fwd
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Attribute Section: riscv
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">File Attributes
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_stack_align: 16-bytes
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_arch: &#34;rv64i2p1_m2p0_a2p1_f2p2_d2p2_c2p0_v1p0_zicsr2p0_zifencei2p0_zmmul1p0_zba1p0_zbb1p0_zbc1p0_zbkb1p0_zbkc1p0_zbkx1p0_zvbb1p0_zvbc1p0_zve32f1p0_zve32x1p0_zve64d1p0_zve64f1p0_zve64x1p0_zvkb1p0_zvl128b1p0_zvl32b1p0_zvl64b1p0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_priv_spec: 1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_priv_spec_minor: 11
</span></span></span></code></pre></div><p>Import into Ghidra 11.1-DEV(isa_ext), noting multiple import messages similar to:</p>
<ul>
<li>Unsupported Thread-Local Symbol not loaded</li>
<li>ELF Relocation Failure: R_RISCV_COPY (4, 0x4) at 00f0c400 (Symbol = stdout) - Runtime copy not supported</li>
</ul>
<h2 id="analysis">Analysis</h2>
<h3 id="source-code-examination">source code examination</h3>
<h4 id="explicit-vectorization">explicit vectorization</h4>
<p>The source code has explicit parallel coding for Intel and Arm/Neon architectures, for instance within
the basic layer 3 forwarding example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">acl_algorithms</span> <span style="color:#000">acl_alg</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;scalar&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_SCALAR</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;sse&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_SSE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;avx2&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_AVX2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;neon&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_NEON</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;altivec&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_ALTIVEC</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;avx512x16&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_AVX512X16</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;avx512x32&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_AVX512X32</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>If avx512x32 is selected, then basic trie search and other operations can proceed across 32 flows in parallel.
Other examples exist within the code.  For more information, search the <code>doc</code> directory for <code>SIMD</code>.  Check out <code>lib/fib/trie_avx512.c</code>
and the function <code>trie_vec_lookup_x16x2</code> for an AVX manual vectorization of a trie address to next hop lookup.</p>
<blockquote>
<p>Note: It won&rsquo;t be clear for some time which vectorization transforms actually improve performance on specific processors.  Vector
support adds a lot of local register space but vector loads and stores can saturate memory bandwidth and drive up processor
temperature.  We might see earlier adoption in contexts that tolerate higher latency, like firewalls, rather than low-latency
switches and routers.</p>
</blockquote>
<h4 id="explicit-ml-support">explicit ML support</h4>
<p>DPDK includes ML contributions from Marvell.  See <code>doc/guides/mldevs/cnxk.rst</code> for more information and references to the cnxk support.
Source code support exists under <code>drivers/ml/cnxk</code> and <code>lib/mldev</code>.  <code>lib/mldev/rte_mldev.c</code> may provide some insight into how
Marvell expects DPDK users to apply their component.
See the Marvell Octeon 10 <a href="https://www.marvell.com/content/dam/marvell/en/public-collateral/embedded-processors/marvell-octeon-10-dpu-platform-white-paper.pdf">white paper</a> for some possible applications.</p>
<h3 id="ghidra-analysis">Ghidra analysis</h3>
<p>The DPDK exemplars stress test Ghidra in multiple ways:</p>
<ul>
<li>When compiled with RISCV-64 vector and bit manipulation extension support you get a good mix of autovectorization instructions.</li>
<li>There are a number of unsupported thread-local relocations requested</li>
<li>ELF replication failures are reported for <code>R_RISCV_COPY</code>, claiming &ldquo;Runtime copy is not supported&rdquo;.
<ul>
<li>this relocation code apparently asks for a symbol to be copied from a shareable object into an executable.</li>
</ul>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2a60af35c245c04e830a46b84717e0d9">3 - Issues</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Summarize Ghidra import issues here to promote discussion on relative priority and possible solutions.</p>

</div>

<h2 id="thread-local-storage-class-handling">Thread local storage class handling</h2>
<p><a href="https://gcc.gnu.org/onlinedocs/gcc/Thread-Local.html">Thread local storage</a> provides one instance of the variable per extant thread.
GCC supports this feature as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">__thread</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">threadLocalString</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">4096</span><span style="color:#000;font-weight:bold">];</span>
</span></span></code></pre></div><p>Binaries built with this feature will often include ELF relocation codes like <code>R_RISCV_TLS_TPREL64</code>.  This relocation code is not recognized by
Ghidra, nor is it clear how TLS storage should be handled itself within Ghidra - perhaps as a memory section akin to BSS?</p>
<p>To reproduce, import <code>libc.so.6</code> and look for lines like <code>Elf Relocation Warning: Type = R_RISCV_TLS_TPREL64</code>.
Alternatively, compile, link, and import <code>riscv64/toolchain/userSpaceSamples/relocationTest.c</code>.</p>
<h2 id="vector-instruction-support">Vector instruction support</h2>
<p>Newer C compiler releases can replace simple loops and standard C library invocations with processor-specific vector instructions.  These vector
instructions can be handled poorly by Ghidra&rsquo;s disassembler and worse by Ghidra&rsquo;s decompiler.  See <a href="/ghidra_import_tests/docs/issues/autovectorization/">autovectorization</a>
and <a href="/ghidra_import_tests/docs/issues/vector_intrinsics/">vector_intrinsics</a> for examples.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-16337ed380c1ee4b8561a7a5066ceb57">3.1 - autovectorization</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>If a processor supports vector (aka SIMD) instructions, optimizing compilers will use them.  That means Ghidra may need to make sense of
the generated code.</p>

</div>

<h2 id="loop-autovectorization">Loop autovectorization</h2>
<p>What happens when a gcc toolchain optimizes the following code?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1320</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;\0&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This involves a simple loop filling a character array with integers.  It isn&rsquo;t a well formed C string,
so the <code>printf</code> statement is just there to keep the character array from being optimized away.</p>
<p>The elements of the loop involve incremental indexing, narrowing from 16 bit to 8 bit elements,
and storage in a 1320 element vector.</p>
<p>The result depends on the compiler version and what kind of microarchitecture gcc-14 was told to compile for.</p>
<p>Compile and link this file with a variety of compiler versions, flags, and microarchitectures to see how well
Ghidra tracks toolchain evolution.  In each case the decompiler output is manually adjusted to relabel
variables like <code>s</code> and <code>i</code> and remove extraneous declarations.</p>
<h3 id="riscv-64-gcc-13-no-optimization-no-vector-extensions">RISCV-64 gcc-13, no optimization, no vector extensions</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build -s --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_userspace  gcc_vectorization:narrowing_loop
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span></code></pre></div><p>Ghidra gives:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">s</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1319</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0x527</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">char</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#39;\x01&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>The loop consists of 17 instructions and 60 bytes.  It is executed 1319 times</p>
<h3 id="riscv-64-gcc-13-full-optimization-no-vector-extensions">RISCV-64 gcc-13, full optimization, no vector extensions</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">bazel build -s --platforms=//platforms:riscv_userspace --copt=&#34;-O3&#34; gcc_vectorization:narrowing_loop
</span></span></span></code></pre></div><p>Ghidra gives:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">s_offset_by_1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1320</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">s_offset_by_1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">char</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0x528</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uStack_19</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s_offset_by_1</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>The loop consists of 4 instructions and 14 bytes. It is executed 1319 times.</p>
<p>Note that Ghidra has reconstructed the target vector <code>s</code> a bit strangely, with the beginning
offset by one byte to help shorten the loop.</p>
<h3 id="riscv-64-gcc-13-full-optimization-with-vector-extensions">RISCV-64 gcc-13, full optimization, with vector extensions</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">bazel build -s --platforms=//platforms:riscv_userspace --copt=&#34;-O3&#34;  gcc_vectorization:narrowing_loop_vector
</span></span></span></code></pre></div><p>The Ghidra import is essentially unchanged - updating the target architecture from <code>rv64igc</code> to <code>rv64igcv</code> makes no difference
when building with gcc-13.</p>
<h3 id="riscv-64-gcc-14-no-optimization-no-vector-extensions">RISCV-64 gcc-14, no optimization, no vector extensions</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">bazel build -s --platforms=//platforms:riscv_vector gcc_vectorization:narrowing_loop
</span></span></span></code></pre></div><p>The Ghidra import is essentially unchanged - updating gcc from gcc-13 to gcc-14 makes no difference without optimization.</p>
<h3 id="riscv-64-gcc-14-full-optimization-no-vector-extensions">RISCV-64 gcc-14, full optimization, no vector extensions</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">bazel build -s --platforms=//platforms:riscv_vector --copt=&#34;-O3&#34; gcc_vectorization:narrowing_loop
</span></span></span></code></pre></div><p>The Ghidra import is essentially unchanged - updating gcc from gcc-13 to gcc-14 makes no difference - when using the default
target architecture without vector extensions.</p>
<h3 id="riscv-64-gcc-14-full-optimization-with-vector-extensions">RISCV-64 gcc-14, full optimization, with vector extensions</h3>
<p>Build with <code>-march=rv64gcv</code> to tell the compiler to assume the processor supports RISCV vector extensions.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">bazel build -s --platforms=//platforms:riscv_vector --copt=&#34;-O3&#34;  gcc_vectorization:narrowing_loop_vector
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>                    <span style="color:#8f5902;font-style:italic">/* WARNING: Unimplemented instruction - Truncating control flow here */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">halt_unimplemented</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>The disassembly window shows that the loop consists of 13 instructions and 46 bytes.
Many of these are vector extension instructions for which Ghidra 11.0 has no semantics.
Different RISCV processors will take a different number of iterations to finish the loop.
If the processor VLEN=128, then each vector register will hold 4 32 bit integers and the
loop will take 330 iterations.  If the processor VLEN=1024 then the loop will take 83 iterations.</p>
<p>Either way, Ghidra 11.0 will fail to decompile any such autovectorized loop, and fail to decompile
the remainder of any function which contains such an autovectorized loop.</p>
<h3 id="x86-64-gcc-14-full-optimization-with-sapphirerapids">x86-64 gcc-14, full optimization, with sapphirerapids</h3>
<blockquote>
<p>Note: Intel&rsquo;s Saphire Rapids includes high end server processors like the Xeon Max family.
A more general choice for x86_64 exemplars would be <code>-march=x86-64-v3</code> with <code>-O2</code> optimization.
We can expect full Red Hat Linux distributions soon built with those options.  The <code>x86-64-v4</code>
microarchitecture is a generalization of Saphire Rapids microarchitecture, and would more likely be found
in servers specialized for numerical analysis or possibly ML applications.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build -s --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:x86_64_default --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-O3&#34;</span> --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-march=sapphirerapids&#34;</span> gcc_vectorization:narrowing_loop
</span></span></code></pre></div><p>Ghidra 11.0 disassembler and decompiler fail immediately on hitting the first vector instruction <code>vpbroadcastd</code>, an older avx2 vector extension.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* WARNING: Bad instruction - Truncating control flow here */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">halt_baddata</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><h2 id="builtin-autovectorization">builtin autovectorization</h2>
<p>GCC can replace calls to some functions like <code>memcpy</code>, replacing those calls with inline - and potentially vectorized - instructions.</p>
<p>This source file shows different ways memcopy can be compiled.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">include</span> <span style="color:#4e9a06">&#34;common.h&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;string.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">127</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">uint32_t</span> <span style="color:#000">seed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0xdeadbeef</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">srand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">seed</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// data gen
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">A</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">gen_rand_1d</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">A</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">N</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// compute
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">copy</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">A</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">A</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// prevent optimization from removing result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%f</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">copy</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="riscv-64-builds">RISCV-64 builds</h3>
<p>Build with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-O3&#34;</span> gcc_vectorization:memcpy_vector
</span></span></code></pre></div><p>Ghidra 11 gives:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">undefined8</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">puVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pauVar3</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar6</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">local_820</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uStack_818</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auStack_420</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1032</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000">srand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xdeadbeef</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">puVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">auStack_420</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">gen_rand_1d</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auStack_420</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x7f</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pauVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">])</span><span style="color:#000">local_820</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x3f8</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsetvli_e8m8tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">puVar2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">lVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar6</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pauVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">auVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">puVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">puVar2</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">lVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pauVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">])(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pauVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">lVar5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%f</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">uStack_818</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>What would we like the decompiler to show instead?  The <code>memcpy</code> pattern should be fairly general and stable.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#000">src</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">auStack_420</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">gen_rand_1d</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auStack_420</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x7f</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">dest</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">])</span><span style="color:#000">local_820</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/* char* dest, src;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    dest[0..n] ≔ src[0..n]; */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x3f8</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsetvli_e8m8tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">auVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">src</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">src</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dest</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">64</span><span style="color:#000;font-weight:bold">])(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>More generally, we want a precomment showing the memcpy in vector terms immediately before
the loop.  The type definition of <code>dest</code> is a red herring to be dealt with.</p>
<h3 id="x86-64-builds">x86-64 builds</h3>
<p>Build with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build -s --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:x86_64_default --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-O3&#34;</span> --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-march=sapphirerapids&#34;</span> gcc_vectorization:memcpy_sapphirerapids
</span></span></code></pre></div><p>Ghidra 11.0&rsquo;s disassembler and decompiler bail out when they reach the inline replacement for <code>memcpy</code> - gcc-14 has replaced the call with
vector instructions like <code>vmovdqu64</code>, which is unrecognized by Ghidra.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auStack_428</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1016</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uStack_30</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000">uStack_30</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x4010ad</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">srand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xdeadbeef</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">gen_rand_1d</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auStack_428</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x7f</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#8f5902;font-style:italic">/* WARNING: Bad instruction - Truncating control flow here */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">halt_baddata</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7612c9d2f660efb43bc65a4e871b3395">3.2 - inferring semantics from code patterns</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>How can we do a better job of recognizing semantic patterns in
optimized code?  Instruction set extensions make that more challenging.</p>

</div>

<p>Ghidra users want to understand the intent of binary code. The semantics
and intent of the <code>memcpy(dest,src,nbytes)</code> operation are pretty clear.
If the compiler converts this into a call to a named external function,
that&rsquo;s easy to recognize.  If it converts it into a simple inline loop of load and
store instructions, that should be recognizable too.</p>
<p>Optimizing compilers like gcc can generate many different instruction sequences from
a simple concept like <code>memcpy</code> or <code>strnlen</code>, especially if the processor for which the code is intended
supports advanced vector or bit manipulation instructions. We can examine the compiler
testsuite to see what those patterns can be, enabling either human or machine translation of
those sequences into the higher level semantics of memory movement or finding the first null
byte in a string.</p>
<p>Gcc semantics recognizes memory copy operations via the operation <code>cpymem</code>.  Calls to
the standard library <code>memcpy</code> and various kinds of struct copies are translated into this RTL (Register Transfer Logic)
<code>cpymem</code> token.  The processor-specific gcc back-end then expands <code>cpymem</code> into a half-dozen or so instruction patterns,
depending on size, alignment, and instruction set extensions of the target processor.</p>
<p>In the ideal world, Ghidra would recognize all of those RTL operations as pcode operations, and further recognize
all of the common back end expansions for all processor variants.  It might rewrite the decompiler window or simply
add comments indicating a likely <code>cpymem</code> pcode expansion.</p>
<p>It&rsquo;s enough for now to show how to gather the more common patterns to help human Ghidra operators untangle these
optimizations and understand the simpler semantics they encode.</p>
<blockquote>
<p>Note: This example uses RISCV vector optimization - many other optimizations are supported by gcc too.</p>
</blockquote>
<h2 id="patterns-in-gcc-vectorization-source-code">Patterns in gcc vectorization source code</h2>
<p>Maybe the best reference on gcc vectorization is the gcc source code itself.</p>
<ul>
<li>What intrinsics are likely to be replaced with vector code?</li>
<li>What patterns of vector assembly instructions are likely to be generated?</li>
<li>How does the gcc test suite search for those patterns to verify intrinsic replacement is correct?</li>
</ul>
<p>Start with:</p>
<ul>
<li><code>gcc/config/riscv/riscv-vector-builtins.cc</code></li>
<li><code>gcc/config/riscv/riscv-vector-strings.cc</code></li>
<li><code>gcc/config/riscv/autovec.md</code></li>
<li><code>gcc/config/riscv/riscv-string.cc</code></li>
</ul>
<p>Ghidra semantics use <code>pcode</code> operations.  GCC uses something similar in RTL (Register Transfer Language).  These
are described in <code>gcc/doc/md.texi</code>.  These include:</p>
<ul>
<li><code>cpymem</code></li>
<li><code>setmem</code></li>
<li><code>strlen</code></li>
<li><code>rawmemchr</code></li>
<li><code>cmpstrn</code></li>
<li><code>cmpstr</code></li>
</ul>
<p>The <code>cpymem</code> op covers inline calls to memcpy and structure copies.  Trace this out:</p>
<p><code>riscv.md</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">define_expand</span> <span style="color:#4e9a06">&#34;cpymem&lt;mode&gt;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">[</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">parallel</span> <span style="color:#000">[</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">set</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">match_operand:BLK</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#4e9a06">&#34;general_operand&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#000;font-weight:bold">(</span><span style="color:#000">match_operand:BLK</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#4e9a06">&#34;general_operand&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000;font-weight:bold">(</span><span style="color:#000">use</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">match_operand:P</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000;font-weight:bold">(</span><span style="color:#000">use</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">match_operand:SI</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#4e9a06">&#34;const_int_operand&#34;</span><span style="color:#000;font-weight:bold">))</span><span style="color:#000">]</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">riscv_expand_block_move</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">operands[0],</span> <span style="color:#000">operands[1],</span> <span style="color:#000">operands[2]</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">DONE</span><span style="color:#8f5902;font-style:italic">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">FAIL</span><span style="color:#8f5902;font-style:italic">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">}</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>riscv_expand_block_move</code> is also mentioned in <code>riscv-protos.h</code> and <code>riscv-string.cc</code>.</p>
<p>Look into <code>riscv-string.cc</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* This function delegates block-move expansion to either the vector
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">   implementation or the scalar one.  Return TRUE if successful or FALSE
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">   otherwise.  */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000">riscv_expand_block_move</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rtx</span> <span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rtx</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rtx</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">TARGET_VECTOR</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">stringop_strategy</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">STRATEGY_VECTOR</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">riscv_vector</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">expand_block_move</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ok</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">true</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">stringop_strategy</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">STRATEGY_SCALAR</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">riscv_expand_block_move_scalar</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#ce5c00;font-weight:bold">---</span> <span style="color:#000">Vector</span> <span style="color:#000">expanders</span> <span style="color:#ce5c00;font-weight:bold">---</span> <span style="color:#a40000">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">namespace</span> <span style="color:#000">riscv_vector</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* Used by cpymemsi in riscv.md .  */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000">expand_block_move</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rtx</span> <span style="color:#000">dst_in</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rtx</span> <span style="color:#000">src_in</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rtx</span> <span style="color:#000">length_in</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    memcpy:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        mv a3, a0                       # Copy destination
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">    loop:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        vsetvli t0, a2, e8, m8, ta, ma  # Vectors of 8b
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        vle8.v v0, (a1)                 # Load bytes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        add a1, a1, t0                  # Bump pointer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        sub a2, a2, t0                  # Decrement count
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        vse8.v v0, (a3)                 # Store bytes
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        add a3, a3, t0                  # Bump pointer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        bnez a2, loop                   # Any more?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">        ret                             # Return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Note that the RISCV assembly instructions in the comment are just an example, and that the C++ implementation
handles many different variants.  The <code>ret</code> instruction is not part of the expansion, just copied into the source
code from the testsuite.</p>
<p>The testsuite (<code>gcc/testsuite/gcc.target/riscv</code>) shows which variants are common enough to test against.</p>
<h3 id="a-minimalist-call-to-memcpy">a minimalist call to memcpy</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">f1</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__SIZE_TYPE__</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memcpy</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>** f1:
</span></span><span style="display:flex;"><span>XX      \.L\d+: # local label is ignored
</span></span><span style="display:flex;"><span>**      vsetvli\s+[ta][0-7],a2,e8,m8,ta,ma
</span></span><span style="display:flex;"><span>**      vle8\.v\s+v\d+,0\(a1\)
</span></span><span style="display:flex;"><span>**      vse8\.v\s+v\d+,0\(a0\)
</span></span><span style="display:flex;"><span>**      add\s+a1,a1,[ta][0-7]
</span></span><span style="display:flex;"><span>**      add\s+a0,a0,[ta][0-7]
</span></span><span style="display:flex;"><span>**      sub\s+a2,a2,[ta][0-7]
</span></span><span style="display:flex;"><span>**      bne\s+a2,zero,\.L\d+
</span></span><span style="display:flex;"><span>**      ret
</span></span><span style="display:flex;"><span>*/
</span></span></code></pre></div><h3 id="a-typed-call-to-memcpy">a typed call to memcpy</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">f2</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">__INT32_TYPE__</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__INT32_TYPE__</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memcpy</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Additional type information doesn&rsquo;t appear to affect the inline code</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>** f2:
</span></span><span style="display:flex;"><span>XX      \.L\d+: # local label is ignored
</span></span><span style="display:flex;"><span>**      vsetvli\s+[ta][0-7],a2,e8,m8,ta,ma
</span></span><span style="display:flex;"><span>**      vle8\.v\s+v\d+,0\(a1\)
</span></span><span style="display:flex;"><span>**      vse8\.v\s+v\d+,0\(a0\)
</span></span><span style="display:flex;"><span>**      add\s+a1,a1,[ta][0-7]
</span></span><span style="display:flex;"><span>**      add\s+a0,a0,[ta][0-7]
</span></span><span style="display:flex;"><span>**      sub\s+a2,a2,[ta][0-7]
</span></span><span style="display:flex;"><span>**      bne\s+a2,zero,\.L\d+
</span></span><span style="display:flex;"><span>**      ret
</span></span></code></pre></div><h3 id="memcpy-with-aligned-elements-and-known-size">memcpy with aligned elements and known size</h3>
<p>In this case arguments are aligned and 512 bytes in length.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">extern</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">__INT32_TYPE__</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">a_a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a_b</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">f3</span> <span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memcpy</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a_a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a_b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span> <span style="color:#000">a_a</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The generated sequence varies depending on how much the compiler knows about the target architecture.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>** f3: { target { { any-opts &#34;-mcmodel=medlow&#34; } &amp;&amp; { no-opts &#34;-march=rv64gcv_zvl512b&#34; &#34;-march=rv64gcv_zvl1024b&#34; &#34;--param=riscv-autovec-lmul=dynamic&#34; &#34;--param=riscv-autovec-lmul=m2&#34; &#34;--param=riscv-autovec-lmul=m4&#34; &#34;-
</span></span><span style="display:flex;"><span>-param=riscv-autovec-lmul=m8&#34; &#34;--param=riscv-autovec-preference=fixed-vlmax&#34; } } }
</span></span><span style="display:flex;"><span>**        lui\s+[ta][0-7],%hi\(a_a\)
</span></span><span style="display:flex;"><span>**        addi\s+[ta][0-7],[ta][0-7],%lo\(a_a\)
</span></span><span style="display:flex;"><span>**        lui\s+[ta][0-7],%hi\(a_b\)
</span></span><span style="display:flex;"><span>**        addi\s+a4,[ta][0-7],%lo\(a_b\)
</span></span><span style="display:flex;"><span>**        vsetivli\s+zero,16,e32,m8,ta,ma
</span></span><span style="display:flex;"><span>**        vle32.v\s+v\d+,0\([ta][0-7]\)
</span></span><span style="display:flex;"><span>**        vse32\.v\s+v\d+,0\([ta][0-7]\)
</span></span><span style="display:flex;"><span>**        ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>f3: { target { { any-opts &#34;-mcmodel=medlow --param=riscv-autovec-preference=fixed-vlmax&#34; &#34;-mcmodel=medlow -march=rv64gcv_zvl512b --param=riscv-autovec-preference=fixed-vlmax&#34; } &amp;&amp; { no-opts &#34;-march=rv64gcv_zvl1024b&#34; } } }
</span></span><span style="display:flex;"><span>**        lui\s+[ta][0-7],%hi\(a_a\)
</span></span><span style="display:flex;"><span>**        lui\s+[ta][0-7],%hi\(a_b\)
</span></span><span style="display:flex;"><span>**        addi\s+[ta][0-7],[ta][0-7],%lo\(a_a\)
</span></span><span style="display:flex;"><span>**        addi\s+a4,[ta][0-7],%lo\(a_b\)
</span></span><span style="display:flex;"><span>**        vl(1|4|2)re32\.v\s+v\d+,0\([ta][0-7]\)
</span></span><span style="display:flex;"><span>**        vs(1|4|2)r\.v\s+v\d+,0\([ta][0-7]\)
</span></span><span style="display:flex;"><span>**        ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>** f3: { target { { any-opts &#34;-mcmodel=medlow -march=rv64gcv_zvl1024b&#34; &#34;-mcmodel=medlow -march=rv64gcv_zvl512b&#34; } &amp;&amp; { no-opts &#34;--param=riscv-autovec-preference=fixed-vlmax&#34; } } }
</span></span><span style="display:flex;"><span>**        lui\s+[ta][0-7],%hi\(a_a\)
</span></span><span style="display:flex;"><span>**        lui\s+[ta][0-7],%hi\(a_b\)
</span></span><span style="display:flex;"><span>**        addi\s+a4,[ta][0-7],%lo\(a_b\)
</span></span><span style="display:flex;"><span>**        vsetivli\s+zero,16,e32,(m1|m4|mf2),ta,ma
</span></span><span style="display:flex;"><span>**        vle32.v\s+v\d+,0\([ta][0-7]\)
</span></span><span style="display:flex;"><span>**        addi\s+[ta][0-7],[ta][0-7],%lo\(a_a\)
</span></span><span style="display:flex;"><span>**        vse32\.v\s+v\d+,0\([ta][0-7]\)
</span></span><span style="display:flex;"><span>**        ret
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>** f3: { target { { any-opts &#34;-mcmodel=medany&#34; } &amp;&amp; { no-opts &#34;-march=rv64gcv_zvl512b&#34; &#34;-march=rv64gcv_zvl256b&#34; &#34;-march=rv64gcv_zvl1024b&#34; &#34;--param=riscv-autovec-lmul=dynamic&#34; &#34;--param=riscv-autovec-lmul=m8&#34; &#34;--param=riscv-autovec-lmul=m4&#34; &#34;--param=riscv-autovec-preference=fixed-vlmax&#34; } } }
</span></span><span style="display:flex;"><span>**        lla\s+[ta][0-7],a_a
</span></span><span style="display:flex;"><span>**        lla\s+[ta][0-7],a_b
</span></span><span style="display:flex;"><span>**        vsetivli\s+zero,16,e32,m8,ta,ma
</span></span><span style="display:flex;"><span>**        vle32.v\s+v\d+,0\([ta][0-7]\)
</span></span><span style="display:flex;"><span>**        vse32\.v\s+v\d+,0\([ta][0-7]\)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>** f3: { target { { any-opts &#34;-mcmodel=medany&#34;  } &amp;&amp; { no-opts &#34;-march=rv64gcv_zvl512b&#34; &#34;-march=rv64gcv_zvl256b&#34; &#34;-march=rv64gcv&#34; &#34;-march=rv64gc_zve64d&#34; &#34;-march=rv64gc_zve32f&#34; } } }
</span></span><span style="display:flex;"><span>**        lla\s+[ta][0-7],a_b
</span></span><span style="display:flex;"><span>**        vsetivli\s+zero,16,e32,m(f2|1|4),ta,ma
</span></span><span style="display:flex;"><span>**        vle32.v\s+v\d+,0\([ta][0-7]\)
</span></span><span style="display:flex;"><span>**        lla\s+[ta][0-7],a_a
</span></span><span style="display:flex;"><span>**        vse32\.v\s+v\d+,0\([ta][0-7]\)
</span></span><span style="display:flex;"><span>**        ret
</span></span><span style="display:flex;"><span>*/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>** f3: { target { { any-opts &#34;-mcmodel=medany --param=riscv-autovec-preference=fixed-vlmax&#34; } &amp;&amp; { no-opts &#34;-march=rv64gcv_zvl1024b&#34; } } }
</span></span><span style="display:flex;"><span>**        lla\s+[ta][0-7],a_a
</span></span><span style="display:flex;"><span>**        lla\s+[ta][0-7],a_b
</span></span><span style="display:flex;"><span>**        vl(1|2|4)re32\.v\s+v\d+,0\([ta][0-7]\)
</span></span><span style="display:flex;"><span>**        vs(1|2|4)r\.v\s+v\d+,0\([ta][0-7]\)
</span></span><span style="display:flex;"><span>**        ret
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a3f6f27ba868f5fb91d5881a937e0e59">3.3 - link time optimization</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Link Time Optimization</p>

</div>

<p>Link Time Optimization (LTO) is a relatively new form of toolchain optimization that can produce
smaller and faster binaries.  It can also mutate control flows in those binaries making
Ghidra analysis trickier, especially if one is using BSIM to look for control flow
similarities.</p>
<p>Can we generate importable exemplars using LTO to show what such optimization steps look like in Ghidra?</p>
<p>LTO needs a command line parameter added for both compilation and linking.  With bazel, that means
<code>--copt=&quot;-flto&quot; --linkopt=&quot;-Wl,-flto&quot;</code> is enough to request LTO optimization on a build.  These <code>lto</code> flags
can also be defaulted into the toolchain definition or individual build files.</p>
<p>Let&rsquo;s try this with a progressively more complicated series of exemplars</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">#</span> Build helloworld without LTO as a control
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build -s --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-O2&#34;</span> --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector userSpaceSamples:helloworld
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> ls -l bazel-bin/userSpaceSamples/helloworld
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">-r-xr-xr-x. 1 --- --- 8624 Jan 31 10:44 bazel-bin/userSpaceSamples/helloworld
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">#</span> The helloworld exemplar doesn<span style="color:#a40000">&#39;</span>t benefit much from link <span style="color:#204a87">time</span> optimization
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build -s  --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-O2&#34;</span>  --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-flto&#34;</span> --linkopt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-Wl,-flto&#34;</span> --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector userSpaceSamples:helloworld
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> ls -l bazel-bin/userSpaceSamples/helloworld
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">-r-xr-xr-x. 1 --- --- 8608 Jan 31 10:46 bazel-bin/userSpaceSamples/helloworld
</span></span></span></code></pre></div><p>The <code>memcpy</code> source exemplar can be built three ways:</p>
<ul>
<li>without vector extensions and without LTO - build target <code>gcc_vectorization:memcpy</code></li>
<li>with vector extensions and without LTO - build target <code>gcc_vectorization:memcpy_vector</code></li>
<li>with vector extensions and with LTO - build target <code>gcc_vectorization:memcpy_lto</code></li>
</ul>
<p>In this case the LTO options are configured into <code>gcc_vectorization/BUILD</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build -s --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector gcc_vectorization:memcpy
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Build completed successfully ...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> ls -l bazel-bin/gcc_vectorization/memcpy
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">-r-xr-xr-x. 1 --- --- 13488 Jan 31 11:16 bazel-bin/gcc_vectorization/memcpy
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> bazel build -s  --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector gcc_vectorization:memcpy_vector
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Build completed successfully ...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> ls -l bazel-bin/gcc_vectorization/memcpy_vector
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">-r-xr-xr-x. 1 --- --- 13728 Jan 31 11:18 bazel-bin/gcc_vectorization/memcpy_vector
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> bazel build -s  --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector gcc_vectorization:memcpy_lto
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">ERROR: ...: Linking gcc_vectorization/memcpy_lto failed: (Exit 1): gcc failed: error executing CppLink command (from target //gcc_vectorization:memcpy_lto) ...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">lto1: internal compiler error: in riscv_hard_regno_nregs, at config/riscv/riscv.cc:8058
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Please submit a full bug report, with preprocessed source (by using -freport-bug).
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">See &lt;https://gcc.gnu.org/bugs/&gt; for instructions.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">lto-wrapper: fatal error: external/gcc-14-riscv64-toolchains/bin/riscv64-unknown-linux-gnu-gcc returned 1 exit status
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">compilation terminated.
</span></span></span></code></pre></div><p>So it looks like LTO has problems with RISCV vector instructions.  We&rsquo;ll keep testing this as more gcc 14 snapshots become available,
but as a lower priority exercise.  LTO does not seem like a popular optimization.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8771ba72e91815ca70636658c86007ad">3.4 - vector intrinsics</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Invoking RISCV vector instructions from C.</p>

</div>

<p>RISCV <a href="https://github.com/riscv-non-isa/rvv-intrinsic-doc/tree/v1.0.x">vector intrinsic functions</a> can be coded into C or C++.</p>
<p>That document includes examples of code that might be found shortly in libc:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">memcpy_vec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">destination</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">source</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dst</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">destination</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">source</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// copy data byte by byte
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">src</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">dst</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsetvl_e8m8</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">vuint8m8_t</span> <span style="color:#000">vec_src</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vle8_v_u8m8</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">__riscv_vse8_v_u8m8</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dst</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vec_src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">destination</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p>Note: GCC-14 autovectorization will often convert normal calls to <code>memcpy</code> into something very similar to the <code>memcpy_vec</code> code above, then assemble it down to RISCV vector instructions.</p>
</blockquote>
<p>As another example, here is a snippet of code from the <a href="https://github.com/ggerganov/whisper.cpp.git">whisper.cc</a> voice to text open source project:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#ifdef __riscv_v_intrinsic
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;riscv_vector.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000">elif</span> <span style="color:#000">defined</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__riscv_v_intrinsic</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">vl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsetvl_e32m4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nb</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// load elements
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vfloat32m4_t</span> <span style="color:#000">v_x</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vle32_v_f32m4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vfloat32m4_t</span> <span style="color:#000">vfabs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfabs_v_f32m4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v_x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vfloat32m1_t</span> <span style="color:#000">tmp</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfmv_v_f_f32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0.0f</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vfloat32m1_t</span> <span style="color:#000">vmax</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfredmax_vs_f32m4_f32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vfabs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">amax</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfmv_f_s_f32m1_f32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vmax</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Normally you would expect to see functions like <code>__riscv_vfabs_v_f32m4</code> defined in the include file <code>riscv_vector.h</code>, where Ghidra could process it and help identify calls to
these intrinsics.  The vector intrinsic functions are instead autogenerated directly into GCC&rsquo;s internal compiled header format when the compiler is built - there are just too many variants
to cope with.  The PDF listing of all intrinsic functions is currently over 4000 pages long.  For example, the signature for <code>__riscv_vfredmax_vs_f32m4_f32m1</code> is given on page 734 under
<code>Vector Reduction Operations</code> as</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">vfloat32m1_t</span> <span style="color:#000">__riscv_vfredmax_vs_f32m4_f32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">vfloat32m4_t</span> <span style="color:#000">vs2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">vfloat32m1_t</span> <span style="color:#000">vs1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>There aren&rsquo;t all that many vector instruction genotypes, but there are an enormous number of contextual variations the compiler and assembler know about.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1a69e41432cb45419088ee30ed903b10">4 - Gap Analysis Example</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>What gaps in Ghidra&rsquo;s import processes need the most long term attention?</p>

</div>

<p>Some features are easy or quick to add to Ghidra&rsquo;s import processes.  Other features
might be nice to have but just aren&rsquo;t worth the effort.  How do we approach features
that are probably going to be important in the long term but would require a lot of effort to address?</p>
<p>This section considers RISCV-64 code optimization by vector instruction insertion as an example.  Either the compiler or
the coder can choose to replace sequences of simple instructions with sequences of vector instructions.  Those vector
sequences often do not have a clean C representation in Ghidra&rsquo;s decompiler view, making it difficult for Ghidra users to
understand what the code is doing and to look for malware or other pathologies.</p>
<p>The overview introduced an approach to this sort of challenge:</p>
<ol>
<li>What is a current example of this feature, especially examples that support analysis or pathologies of those features.
<ul>
<li>⇒see <a href="/ghidra_import_tests/docs/gap_analysis/examples/">Examples</a></li>
</ul>
</li>
<li>How and when might this feature impact a significant number of Ghidra analysts?
<ul>
<li>⇒see <a href="/ghidra_import_tests/docs/gap_analysis/impact/">Impact</a></li>
</ul>
</li>
<li>How much effort might it take Ghidra developers to fill the implied feature gap?  Do we fill it by extending the core of Ghidra, by
generating new plugin scripts or tools, or by educating Ghidra users on how to recognize semantic patterns from raw instructions?
<ul>
<li>⇒see <a href="/ghidra_import_tests/docs/gap_analysis/effort/">Effort</a></li>
</ul>
</li>
<li>Is this feature specific to RISCV systems or more broadly applicable to other processor families?  Would support for that
feature be common to many processor families or vary widely by processor?
<ul>
<li>⇒see <a href="/ghidra_import_tests/docs/gap_analysis/scope/">Scope</a></li>
</ul>
</li>
<li>What are the existing frameworks within Ghidra that might most credibly be extended to support that feature?
<ul>
<li>⇒see <a href="/ghidra_import_tests/docs/gap_analysis/existing_frameworks/">Existing Frameworks</a></li>
</ul>
</li>
</ol>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8d0cf167d96ef3b8c37351518f85816c">4.1 - Examples</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Where does this gap appear?</p>

</div>

<h2 id="memory-copy">memory copy</h2>
<ul>
<li>alignment issues</li>
<li>obfuscated memcpy and strcpy inline code</li>
</ul>
<h2 id="other-pcode-or-rtl-expansions">other pcode or RTL expansions</h2>
<h2 id="loop-optimization">loop optimization</h2>
<h2 id="vector-intrinsics">vector intrinsics</h2>
<h2 id="ml-and-ai-subsystems">ML and AI subsystems</h2>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7cb98d558b94d2da397f926726be0b6a">4.2 - Impact</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>What is the impact of this gap?</p>

</div>

<h2 id="how">How</h2>
<p>Ghidra&rsquo;s current limits in handling RISCV-64 vector instructions will impact users in phases, where the initial impacts are modest and fairly easy to deal
with while later impacts will take significant design work to address.</p>
<p>The most immediate impact involves Ghidra disassembly and decompilation failure when encountering unrecognized instructions.  The Fedora 39 exemplar kernel
contains several extension instructions that Ghidra 11 can&rsquo;t recognize.  These are limited in number and don&rsquo;t have a material impact on someone examining
RISCV kernel code.  The voice-to-text app whisper.cpp shows more serious limits - roughly one third of the app&rsquo;s instructions are unprocessed by Ghidra 11
because of vector and other extension instructions.</p>
<p>That impact can be addressed by simply defining the missing instructions, as in Ghidra&rsquo;s <code>isa_ext</code> experimental branch.  This will allow the disassembler and
decompiler to process all instructions in the app.  This is necessary but not sufficient, since many or most of the vector extension instructions do not have
a clean pcode representation.  Obvious calls to <code>memcpy</code> will be replaced with one of a half-dozen inline vector instruction sequences.  Simple or nested
loops will be &lsquo;vectorized&rsquo; with fewer iterations but much more complex instruction opcode sequences.  Optimizing compilers can handle those complexities, while
Ghidra users searching for malware will have a harder time of it.</p>
<p>The general challenge for Ghidra is that of reconstructing the context from sequences of vector extension instructions.</p>
<h2 id="when">When</h2>
<blockquote>
<p>Note: Some material comes as-is from <a href="https://www.reddit.com/r/RISCV">https://www.reddit.com/r/RISCV</a></p>
</blockquote>
<p>The first generally available 64 bit RISCV vector systems development kit has just become available (January 2024), based on the relatively modest
THead C908 core.  This SDK appears tuned for video processing, perhaps video surveillance applications aggregating multiple cameras into a common video feed.
We are probably several years from seeing server-class systems built on SiFive P870 cores, and fabricated on the fastest available fab lines.  Memory bandwidth
is poor at present, while energy efficiency is potentially better than x86_64 designs.</p>
<p>Judging from internet hype, we can expect to see RISCV vector code appearing in replacements of ARM systems (automotive and possibly cell phone) and as the extensible
basis of AI applications.</p>
<ul>
<li>Cores announced
<ul>
<li>SiFive
<ul>
<li><a href="https://www.sifive.com/cores/performance-p650-670">P670</a> 2 x 128 bit vector units, up to 16 cores</li>
<li><a href="https://www.sifive.com/cores/performance-p870-p870a">P870</a> 2 x 128 bit vector units, vector crypto, up to 16 cores</li>
</ul>
</li>
<li>Alibaba XuanTie THead
<ul>
<li><a href="https://riscv.org/blog/2022/11/xuantie-c908-high-performance-risc-v-processor-catered-to-aiot-industry-chang-liu-alibaba-cloud/">C908</a>
with RVV 1.0 support, 128 bit VLEN; announced 2022</li>
</ul>
</li>
<li>StarFive
<ul>
<li><a href="https://www.starfivetech.com/en/site/riscv-core-ip">Starfive</a> does not appear to offer a vector RISCV core</li>
</ul>
</li>
</ul>
</li>
<li>SDKs available
<ul>
<li><a href="https://www.youyeetoo.com/products/canmv-k230-kendryte-k230-risc-v64-board?VariantsId=11596">CanMV-K230</a>,
dual C908 cores, triple video camera inputs, $40; one core supports RVV 1.0 at 1.6 GHz; 512 MB RAM; announced 2023</li>
<li>Sophgo <a href="https://forum.sophgo.com/t/about-the-sg2380-oasis-category/359">SG2380</a> due Q3 2024 with 16 core SiFive P670
and 8 core SiFiveX280</li>
</ul>
</li>
</ul>
<h2 id="who-is-working-this">Who is working this</h2>
<p>January 2024 saw a flurry of open source toolchain and framework contributions from several sources.</p>
<ul>
<li>binutils contributors
<ul>
<li>multiple recent contributors from Alibaba, mostly in support of THead extensions</li>
</ul>
</li>
<li>gcc contributors
<ul>
<li>intel, alibaba, rivai (ref XCVsimd extension), embecosm, sifive, eswincomputing, ventanamicro, andestech all contributed to the riscv testsuite in the last two weeks.</li>
</ul>
</li>
<li>glibc contributions
<ul>
<li>some references to Alibaba riscv extensions</li>
</ul>
</li>
<li>ML framework contributors
<ul>
<li>riscv intrinsics appeared in whisper.cpp in November 2023, sync&rsquo;d from <a href="https://github.com/ggerganov/llama.cpp/commit/79f34abddb72ac5ddbf118f3d87520b611a10a7d">llama</a>,
originally contributed by <a href="https://pk.linkedin.com/in/ahmad-tameem">https://pk.linkedin.com/in/ahmad-tameem</a></li>
</ul>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1b1eb1e0bd770f075bf5f7b82b390ab4">4.3 - Effort</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>How much effort might it take to fill the gap?</p>

</div>


</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cd44a52f518655bfeafd82fb4d424edb">4.4 - Scope</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Does the scope of this gap extend to other processors?</p>

</div>

<ul>
<li>x86_64 comparison</li>
<li>alignment</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e4e8adc613678dce506b389b4b3e7b27">4.5 - Existing Frameworks</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Which Ghidra frameworks might be extended to fill the gap?</p>

</div>

<h2 id="outline">Outline</h2>
<ul>
<li>What can we add to sleigh <code>.sinc</code> files?
<ul>
<li>add all extension instructions</li>
<li>add translation of Elf file attributes into vendor-specific processor selection</li>
<li>flesh out extension mnemonics to convey vector context, especially <code>vset*</code> instructions</li>
<li>add comments or metadata that is accessible to the decompiler</li>
</ul>
</li>
<li>What can we add to pcode semantics?
<ul>
<li>gcc built-ins like __builtin_memcpy or popcount</li>
<li>cross platform vector notation</li>
<li>processor dependent decompiler plugins</li>
</ul>
</li>
<li>What can we add to disassembler
<ul>
<li>generalized instruction information on common use patterns</li>
</ul>
</li>
<li>What can we add to decompiler
<ul>
<li>reconstruct gcc RTL built-ins</li>
</ul>
</li>
<li>What plugins can we add?
<ul>
<li>reconstruct gcc RTL built-ins</li>
</ul>
</li>
<li>What external tools can we leverage?
<ul>
<li>generate .sinc updates based on objdump mnemonics</li>
<li>known source exemplar builds to correlate RTL expressions with instruction sequences</li>
<li>apply general ML translation to undo pcode expansion into vector instructions</li>
</ul>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e91cac96d09d03fc802701da7875ce2e">5 - Platforms and Toolchains</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Code is built by a toolchain (compiler, linker) to run on a platform (e.g., a pixel 7a cellphone).</p>

</div>

<p>This project adopts the Bazel framework for building importable exemplars.  <a href="https://bazel.build/extending/platforms">Platforms</a>
describe the foundation on which code will run.  <a href="https://bazel.build/extending/toolchains">Toolchains</a> compile and link code for different
platforms.  Bazel builds are <a href="https://bazel.build/basics/hermeticity">hermetic</a>, which for our purposes means that platforms and toolchains
are all versioned and importable, so build results are the same no matter where the build host may be.</p>
<h2 id="example-of-riscv-64-platforms-and-toolchains">Example of RISCV-64 platforms and toolchains</h2>
<p>The directory RISCV64/toolchain defines these platforms:</p>
<ul>
<li><code>//platforms:riscv_userspace</code> for a generic RISCV-64 Linux appliance with the usual libc and libstdio APIs</li>
<li><code>//platforms:riscv_vector</code> for a more specialized RISCV-64 Linux appliance with vector extensions supported</li>
<li><code>//platforms:riscv_custom</code> for a highly specialized RISCV-64 Linux appliance with vector and vendor-specific extensions supported</li>
<li><code>//platforms:riscv_local</code> for toolchain debugging, using a local file system toolchain under <code>/opt/riscvx</code></li>
</ul>
<blockquote>
<p>Note: The current binutils and gcc show more vendor-specific instruction set extensions from THead, so we will arbitrarily use that
as the exemplar custom platform.</p>
</blockquote>
<p>This directory defines these toolchains:</p>
<ul>
<li><code>//toolchains:riscv64-default</code> - a gcc-13 stable RISCV compiler, linker, loader, and sysroot of related include files and libraries</li>
<li><code>//toolchains:riscv64-next</code> - a gcc-14 unreleased but feature-frozen RISCV compiler, linker, loader, and sysroot of related include files
and libraries</li>
<li><code>//toolchains:riscv64-custom</code> - a variant of  <code>//toolchains:riscv64-next</code> with multiple standard and vendor-specific ISA extensions enabled
by default</li>
<li><code>//toolchains:riscv64-local</code> - a toolchain executing out of <code>/opt/riscvx</code> instead of a portable tarball.  Generally useful only when
debugging the generation of a fully portable and hermetic toolchain tarball.</li>
</ul>
<p>Exemplars are built by naming the platform for each build.  Bazel then finds a compatible toolchain to complete the build.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">#</span> compile <span style="color:#204a87;font-weight:bold">for</span> the riscv_userspace platform, automatically selecting the riscv64-default toolchain with gcc-13.
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">bazel build -s --platforms=//platforms:riscv_userspace gcc_vectorization:helloworld_challenge
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">#</span> compile <span style="color:#204a87;font-weight:bold">for</span> the riscv_vector platform, automatically selecting the riscv64-next toolchain with gcc-14.
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">bazel build -s --platforms=//platforms:riscv_vector gcc_vectorization:helloworld_challenge
</span></span></span></code></pre></div><p>This table shows relationships between platforms, constraints, toolchains, and default options:</p>
<table>
<thead>
<tr>
<th>platform</th>
<th>cpu constraint</th>
<th>toolchain</th>
<th>default options</th>
<th>added optimized options</th>
</tr>
</thead>
<tbody>
<tr>
<td>//platforms:riscv_userspace</td>
<td>//toolchains:riscv64</td>
<td>//toolchains:riscv64-default</td>
<td></td>
<td>-O3</td>
</tr>
<tr>
<td>//platforms:riscv_vector</td>
<td>//toolchains:riscv64-v</td>
<td>//toolchains:riscv64-next</td>
<td>-march=rv64gcv</td>
<td>-O3</td>
</tr>
<tr>
<td>//platforms:riscv_custom</td>
<td>//toolchains:riscv64-c</td>
<td>//toolchains:riscv64-custom</td>
<td>-march=rv64gcv_zba_zbb_zbc_zbkb_zbkc_zbkx_zvbc_xtheadba_xtheadbb_xtheadbs_xtheadcmo_xtheadcondmov_xtheadmac_xtheadfmemidx_xtheadmempair_xtheadsync</td>
<td>-O3</td>
</tr>
<tr>
<td>//platforms:riscv_local</td>
<td>//toolchains:riscv64-l</td>
<td>//toolchains:riscv64-local</td>
<td></td>
<td>-O3</td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ul>
<li>The <code>-O3</code> option is likely too aggressive. The <code>-O2</code> option would be more common in broadly released software.</li>
<li><code>//toolchains:riscv64-default</code> currently uses a gcc-13 toolchain suite</li>
<li>the other toolchains use various developmental snapshots of the gcc-14 toolchain suite</li>
<li>vector extensions version 1.0 are default on <code>//toolchains:riscv64-next</code> and <code>//toolchains:riscv64-custom</code></li>
<li><code>//toolchains:riscv64-custom</code> adds bit manipulation and many of the THead extensions supported by binutils.</li>
</ul>
<blockquote>
<p>Warning: C options can be added by the toolchain, within a BUILD file, and on the command line.  For options like <code>-O</code> and <code>-march</code>, only
the last instance of the option affects the build.</p>
</blockquote>
<h2 id="toolchain-details">Toolchain details</h2>
<p>Toolchains generally include several components that can affect the generated binaries:</p>
<ul>
<li>the gcc compiler, built from source and configured for a specific target architecture and language set</li>
<li>binutils utilities, including a <code>gas</code> assembler with support for various instruction set extensions
and disassembler tools like <code>objdump</code> that provide reference handling of newer instructions.</li>
<li>linker and linker scripts</li>
<li>a <code>sysroot</code> holding files the above subsystems would normally expect to find under <code>/usr</code>, for instance
<code>/usr/include</code> files supplied by the kernel and standard libraries</li>
<li>libc, libstdc++, etc.</li>
<li>default compiler options and include directories</li>
</ul>
<p>The toolchain prepared for building a kernel module won&rsquo;t be the same as a toolchain built for userspace programs,
even if the compilers are identical.</p>
<p>See <a href="/ghidra_import_tests/docs/testbed_internals/adding_toolchains/">adding toolchains</a> for an example of adding a new toolchain to this project.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a0dbecf86134103ffa5a995386f0f036">5.1 - ISA Extensions</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Extensions to a processor family&rsquo;s Instruction Set Architecture add capability and complexity.</p>

</div>

<p>The RISCV community has a rich set of extensions to the base Instruction Set Architecture.  That means a diverse set
of new binary import targets to test against.  This work-in-progress is collected in the <code>riscv64/toolchain/assemblySamples</code> directory.
The basic idea is to compare current Ghidra disassembly with current binutils <code>objdump</code> disassembly, using object files
assembled from the binutils <code>gas</code> testsuite.  For example:</p>
<ul>
<li><code>riscv64/toolchain/assemblySamples/h-ext-64.S</code> was copied from the binutils gas testsuite.  It contains unit test instructions for
hypervisor support extensions like <code>hfence.vvma</code> and <code>hlv.w</code>.</li>
<li><code>riscv64/exemplars/h-ext-64.o</code> is the object file produced by a <em>current snapshot</em> of the binutils 2-41 assembler.  The associated listing
is <code>riscv64/exemplars/h-ext-64.list</code>.</li>
<li><code>riscv64/exemplars/h-ext-64.objdump</code> is the output from disassembling <code>riscv64/exemplars/h-ext-64.o</code> using the current snapshot of the binutils 2-41
<code>objdump</code>.</li>
</ul>
<p>So we want to open Ghidra, import <code>riscv64/exemplars/h-ext-64.o</code>, and compare the disassembly window to <code>riscv64/exemplars/h-ext-64.objdump</code>, then triage
any variances.</p>
<p>Some variances are trivial.  The <code>h-ext-64.S</code> tests include instructions that assemble into a single 4 byte sequence.  Disassembly will only give a single
instruction, perhaps the simplest one of the given aliases.</p>
<p>Other variances are harder - it looks like Ghidra expects to see an earlier and deprecated set of vector instructions than one currently approved set.</p>
<p><code>riscv64/toolchain/assemblySamples/TODO.md</code> collects some of the variances noted so far.</p>
<p>One big question is what kind of pcode should Ghidra generate for some of these instructions - and how many Ghidra users will care about that pcode.
The short term answer is to treat extension instructions as pcode function calls.  The longer term answer may be to wait until GCC14 comes out with support for
vector extensions, then see what kind of C source is conventionally used when invoking those extensions.  The <code>memcpy</code> inline function from <code>libc</code> is a likely
place to find early use of vector instructions.</p>
<p>Also, what can we safely ignore for now?  The proposed vendor-specific T-Head extension instruction
<a href="https://github.com/T-head-Semi/thead-extension-spec/blob/master/xtheadcmo/l2cache_iall.adoc"><code>th.l2cache.iall</code></a> won&rsquo;t be seen by most Ghidra users.
On the other hand, the encoding rules published with those T-Head extensions look like a good example to follow.</p>
<p>The Fedora 39 kernel includes virtual machine cache management instructions that are not necessarily supported by binutils - they are &lsquo;assembled&rsquo; with gcc macros
before reaching the binutils assembler.  We will ignore those instruction extensions for now, and only consider instruction extensions supported by binutils.</p>
<h2 id="determining-the-isa-extensions-required-by-a-binary">Determining the ISA extensions required by a binary</h2>
<p>Some newer compilers annotate executable binaries by adding the ISA extensions used during the build.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> /opt/riscvx/bin/riscv64-unknown-linux-gnu-readelf -A riscv64/exemplars/whisper_cpp_default
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Attribute Section: riscv
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">File Attributes
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_stack_align: 16-bytes
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_arch: &#34;rv64i2p1_m2p0_a2p1_f2p2_d2p2_c2p0_zicsr2p0_zmmul1p0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> /opt/riscvx/bin/riscv64-unknown-linux-gnu-readelf -A riscv64/exemplars/whisper_cpp_vector
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Attribute Section: riscv
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">File Attributes
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_stack_align: 16-bytes
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_arch: &#34;rv64i2p1_m2p0_a2p1_f2p2_d2p2_c2p0_v1p0_zicsr2p0_zifencei2p0_zmmul1p0_zve32f1p0_zve32x1p0_zve64d1p0_zve64f1p0_zve64x1p0_zvl128b1p0_zvl32b1p0_zvl64b1p0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_priv_spec: 1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_priv_spec_minor: 11
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> /opt/riscvx/bin/riscv64-unknown-linux-gnu-readelf -A riscv64/exemplars/whisper_cpp_vendor
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Attribute Section: riscv
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">File Attributes
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_stack_align: 16-bytes
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_arch: &#34;rv64i2p1_m2p0_a2p1_f2p2_d2p2_c2p0_v1p0_zicsr2p0_zifencei2p0_zmmul1p0_zba1p0_zbb1p0_zbc1p0_zbkb1p0_zbkc1p0_zbkx1p0_zvbc1p0_zve32f1p0_zve32x1p0_zve64d1p0_zve64f1p0_zve64x1p0_zvl128b1p0_zvl32b1p0_zvl64b1p0_xtheadba1p0_xtheadbb1p0_xtheadbs1p0_xtheadcmo1p0_xtheadcondmov1p0_xtheadfmemidx1p0_xtheadmac1p0_xtheadmempair1p0_xtheadsync1p0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_priv_spec: 1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_priv_spec_minor: 11
</span></span></span></code></pre></div><p>If <code>Tag_RISCV_arch</code> contains the substring <code>v1p0</code>, then the associated binary was built assuming RV Vector 1.0 extension instructions are present on the executing CPU hardware thread.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ac78dfbfa527f45d19411db0b4780c07">6 - Instruction Patterns</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Common instruction patterns one might see with vectorized code generation</p>

</div>

<p>This page collects architecture-dependent gcc-14 <em>expansions</em>, where simple C sequences are translated into
optimized code.</p>
<p>Our baseline is a gcc-14 compiler with <code>-O2</code> optimization and a base machine architecture of <code>-march=rv64gc</code>.  That&rsquo;s a basic 64 bit RISCV
processor (or a <code>hart</code> core of that processor) with support for compressed instructions.</p>
<p>Variant machine architectures considered here are:</p>
<table>
<thead>
<tr>
<th>march</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>rv64gc</td>
<td>baseline</td>
</tr>
<tr>
<td>rv64gcv</td>
<td>baseline + vector extension (dynamic vector length)</td>
</tr>
<tr>
<td>rv64gcv_zvl128b</td>
<td>baseline + vector (minimum 128 bit vectors)</td>
</tr>
<tr>
<td>rv64gcv_zvl512b</td>
<td>baseline + vector (minimum 512 bit vectors)</td>
</tr>
<tr>
<td>rv64gcv_zvl1024b</td>
<td>baseline + vector (minimum 1024 bit vectors)</td>
</tr>
<tr>
<td>rv64gc_xtheadbb</td>
<td>baseline + THead bit manipulation extension (no vector)</td>
</tr>
</tbody>
</table>
<h2 id="memory-copy-operations">Memory copy operations</h2>
<blockquote>
<p>Note: memory copy operations require non-overlapping source
and destination.  memory move operations allow overlap
but are much more complicated and are not currently
optimized.</p>
</blockquote>
<p>Optimizing compilers are good at turning simple memory copy operations into confusing - but fast - instruction sequences.
GCC can recognize memory copy operations as calls to <code>memcpy</code> or as structure assignments like <code>*a = *c</code>.</p>
<p>The current reference C file is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">extern</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">__restrict</span> <span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">__restrict</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__SIZE_TYPE__</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">extern</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">memmov</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dest</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__SIZE_TYPE__</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* invoke memcpy with dynamic size */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_1</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__SIZE_TYPE__</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memcpy</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* invoke memcpy with known size and aligned pointers */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">extern</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">__INT32_TYPE__</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">a_a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a_b</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_2</span> <span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memcpy</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a_a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a_b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span> <span style="color:#000">a_a</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">c16</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">c32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">short</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">30</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">s16</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* copy fixed 128 bits of memory */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_3</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c16</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c16</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* copy fixed 256 bits of memory */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_4</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c32</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c32</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* copy fixed 256 bits of memory */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_5</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s16</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s16</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* memmov allows overlap - don&#39;t vectorize or inline */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">movmem_1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">__SIZE_TYPE__</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memmov</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="baseline-no-vector">Baseline (no vector)</h3>
<p>Ghidra 11 with the <code>isa_ext</code> branch decompiler gives us something simple after fixing the signature of the <code>memcpy</code> thunk.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a_a</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a_b</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x40</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_5</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="rv64gcv---vector-extensions">rv64gcv - vector extensions</h3>
<p>If the compiler knows the target hart can process vector extensions, but is not told
explicitly the size of each vector register, it optimizes all of these calls.  Ghidra 11 gives us
the following, with binutils&rsquo; objdump instruction listings added as comments:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">cpymem_1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar2</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsetvli_e8m8tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// vsetvli a5,a2,e8,m8,ta,ma
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">);</span>           <span style="color:#8f5902;font-style:italic">// vle8.v  v8,(a1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">param_3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param_3</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">lVar1</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">// sub     a2,a2,a5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">);</span>             <span style="color:#8f5902;font-style:italic">// vse8.v  v8,(a0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">param_2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param_2</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">lVar1</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">// add     a1,a1,a5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">param_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param_1</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">lVar1</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">// add     a0,a0,a5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_3</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>               <span style="color:#8f5902;font-style:italic">// bnez    a2,8a8 &lt;cpymem_1&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#8f5902;font-style:italic">// ld      a4,1922(a4) # 2040 &lt;a_b@Base&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                                        <span style="color:#8f5902;font-style:italic">// ld      a5,1938(a5) # 2058 &lt;a_a@Base&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd3</span><span style="color:#000;font-weight:bold">);</span>                  <span style="color:#8f5902;font-style:italic">// vsetivli        zero,16,e32,m8,ta,ma
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">auVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a_b</span><span style="color:#000;font-weight:bold">);</span>               <span style="color:#8f5902;font-style:italic">// vle32.v v8,(a4)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">vse32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a_a</span><span style="color:#000;font-weight:bold">);</span>                 <span style="color:#8f5902;font-style:italic">// vse32.v v8,(a5)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined8</span> <span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">undefined8</span> <span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xc0</span><span style="color:#000;font-weight:bold">);</span>                   <span style="color:#8f5902;font-style:italic">// vsetivli        zero,16,e8,m1,ta,ma
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">auVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">);</span>              <span style="color:#8f5902;font-style:italic">// vle8.v  v1,(a1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">);</span>                <span style="color:#8f5902;font-style:italic">// vse8.v  v1,(a0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined8</span> <span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">undefined8</span> <span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>                <span style="color:#8f5902;font-style:italic">// li      a5,32
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">vsetvli_e8m8tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">);</span>                <span style="color:#8f5902;font-style:italic">// vsetvli        zero,a5,e8,m8,ta,ma
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">auVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">);</span>              <span style="color:#8f5902;font-style:italic">// vle8.v  v8,(a1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">);</span>                <span style="color:#8f5902;font-style:italic">// vse8.v  v8,(a0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">cpymem_5</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined8</span> <span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">undefined8</span> <span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xcb</span><span style="color:#000;font-weight:bold">);</span>                   <span style="color:#8f5902;font-style:italic">// vsetivli        zero,16,e16,m8,ta,ma
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">auVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle16_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">);</span>             <span style="color:#8f5902;font-style:italic">// vle16.v v8,(a1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">vse16_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">);</span>               <span style="color:#8f5902;font-style:italic">// vse16.v v8,(a0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The variation in the <code>vset*</code> instructions is a bit puzzling.  This <em>may</em> be due to
alignment issues - trying to copy a <code>short int</code> into a misaligned odd address generates
an exception at the store instruction, so perhaps the vector optimization is supposed
to throw an exception there too.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ceb842b555df01c318aedd8973d75baf">6.1 - Application Survey</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Survey a voice-to-text app for common vector instruction patterns</p>

</div>

<p>Take an exemplar RISCV-64 binary like <code>whisper.cpp</code>, with its many vector instructions.
Which vector patterns are easy to recognize, either for a human Ghidra user or for a hypothetical Ghidra plugin?</p>
<p>Some of the most common patterns correspond to <code>memcpy</code> or <code>memset</code> invocations where the number of bytes is known at
compile time as is the alignment of operands.</p>
<p>ML apps like <code>whisper.cpp</code> often work with parameters of less than 8 bits, so there can be a lot of demarshalling, unpacking,
and repacking operations.  That means lots of vector bit manipulation and width conversion operations.</p>
<p>ML apps also do a lot of vector, matrix, and tensor arithmetic, so we can expect to find vectorized arithmetic operations
mixed in with vector parameter conversion operations.</p>
<blockquote>
<p>Note: This page is likely to change rapidly as we get a better handle on the problem and develop better analytic tools
to guide the process.</p>
</blockquote>
<h2 id="survey-for-vector-instruction-blocks">Survey for vector instruction blocks</h2>
<p>Most vector instructions come in groups started with a <code>vsetvli</code> or <code>vsetivli</code> instruction to set up the vector context.
If the number of vector elements is known at compile time and less than 32, then the <code>vsetivli</code> instruction is often used.
Otherwise the <code>vsetvli</code> instruction is used.</p>
<p>Scanning for these instructions showed 673 <code>vsetvli</code> and 888 <code>vsetivli</code> instructions within <code>whisper.cpp</code>.</p>
<p>The most common <code>vsetvli</code> instruction (343 out of 673) is type 0xc3 or <code>e8,m8,ta,ma</code>.  That expands to:</p>
<ul>
<li>element width = 8 bits - no alignment checks are needed, 16 elements per vector register if VLEN=128</li>
<li>multiplier = 8 - up to 8 vector registers are processed in parallel</li>
<li>tail agnostic - we don&rsquo;t care about preserving unassigned vector register bits</li>
<li>mask agnostic - we don&rsquo;t care about preserving unmasked vector register bits</li>
</ul>
<p>The most common <code>vsetivli</code> instruction (565 out of 888) is type 0xd8 or <code>e64,m1,ta,ma</code>.  That expands to:</p>
<ul>
<li>element width = 64 bits - all memory operations should be 64 bit aligned, 2 elements per vector register if VLEN=128</li>
<li>multiplier = 1 - only the named vector register is used</li>
<li>tail agnostic - we don&rsquo;t care about preserving unassigned vector register bits</li>
<li>mask agnostic - we don&rsquo;t care about preserving unmasked vector register bits</li>
</ul>
<p>A similar common <code>vsetivli</code> instruction (102 out of 888) is type 0xdb or <code>e64,m8,ta,ma</code>.  That expands to:</p>
<ul>
<li>element width = 64 bits - all memory operations should be 64 bit aligned, 2 elements per vector register if VLEN=128</li>
<li>multiplier = 8 - up to 8 vector registers are processed in parallel, or 16 64 bit elements if VLEN=128</li>
<li>tail agnostic - we don&rsquo;t care about preserving unassigned vector register bits</li>
<li>mask agnostic - we don&rsquo;t care about preserving unmasked vector register bits</li>
</ul>
<p>The second most common <code>vsetivli</code> instruction (107 out of 888) is type 0xc7 or <code>e8,mf2,ta,ma</code>.  That expands to:</p>
<ul>
<li>element width = 8 bits</li>
<li>multiplier = 1/2 - vector registers are only half used, perhaps to allow element widening to 16 bits</li>
<li>tail agnostic - we don&rsquo;t care about preserving unassigned vector register bits</li>
<li>mask agnostic - we don&rsquo;t care about preserving unmasked vector register bits</li>
</ul>
<p>How many of these vector blocks can be treated as simple <code>memcpy</code> or <code>memset</code> invocations?</p>
<p>For example, this Ghidra listing snippet looks like a good candidate for <code>memcpy</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>00090bdc 57 f0 b7 cd     vsetivli                       zero,0xf,e64,m8,ta,ma
</span></span><span style="display:flex;"><span>00090be0 07 74 07 02     vle64.v                        v8,(a4)
</span></span><span style="display:flex;"><span>00090be4 27 f4 07 02     vse64.v                        v8,(a5)
</span></span></code></pre></div><p>A pcode equivalent might be <code>__builtin_memcpy(dest=(a5), src=(a4), 8 * 15)</code> with a possible context note that
vector registers v8 through v16 are changed.</p>
<p>A longer example might be a good candidate for <code>memset</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>00090b84 57 70 81 cd     vsetivli                       zero,0x2,e64,m1,ta,ma
</span></span><span style="display:flex;"><span>00090b88 93 07 07 01     addi                           a5,a4,0x10
</span></span><span style="display:flex;"><span>00090b8c d7 30 00 5e     vmv.v.i                        v1,0x0
</span></span><span style="display:flex;"><span>00090b90 a7 70 07 02     vse64.v                        v1,(a4)
</span></span><span style="display:flex;"><span>00090b94 a7 f0 07 02     vse64.v                        v1,(a5)
</span></span><span style="display:flex;"><span>00090b98 93 07 07 02     addi                           a5,a4,0x20
</span></span><span style="display:flex;"><span>00090b9c a7 f0 07 02     vse64.v                        v1,(a5)
</span></span><span style="display:flex;"><span>00090ba0 93 07 07 03     addi                           a5,a4,0x30
</span></span><span style="display:flex;"><span>00090ba4 a7 f0 07 02     vse64.v                        v1,(a5)
</span></span><span style="display:flex;"><span>00090ba8 93 07 07 04     addi                           a5,a4,0x40
</span></span><span style="display:flex;"><span>00090bac a7 f0 07 02     vse64.v                        v1,(a5)
</span></span><span style="display:flex;"><span>00090bb0 93 07 07 05     addi                           a5,a4,0x50
</span></span><span style="display:flex;"><span>00090bb4 a7 f0 07 02     vse64.v                        v1,(a5)
</span></span><span style="display:flex;"><span>00090bb8 93 07 07 06     addi                           a5,a4,0x60
</span></span><span style="display:flex;"><span>00090bbc a7 f0 07 02     vse64.v                        v1,(a5)
</span></span><span style="display:flex;"><span>00090bc0 fd 1b           c.addi                         s7,-0x1
</span></span><span style="display:flex;"><span>00090bc2 23 38 07 06     sd                             zero,0x70(a4)
</span></span></code></pre></div><p>This example is based on a minimum VLEN of 128 bits, so the vector registers can hold 2 64 bit elements.  The <code>vmv.v.i</code> instruction sets those two elements of <code>v1</code> to zero.
Seven <code>vse64.v</code> instructions then store two 64 bit zeros each to successive memory locations, with a trailing scalar double word store to handle the tail.</p>
<p>A pcode equivalent for this sequence might be <code>__builtin_memset(dest=(a4), 0, 0x78)</code>.</p>
<h2 id="top-down-scan-of-vector-blocks">top down scan of vector blocks</h2>
<p>The python script <code>objdump_analytic.py</code> provides a crude scan of a RISCV-64 binary, reporting on likely vector instruction blocks.  It doesn&rsquo;t handle blocks with more than one
<code>vsetvli</code> or <code>vsetivli</code> instruction, something common in vector narrowing or widening operations.  If we apply this script to <code>whisper_cpp_vector</code> we can collect a crude field guide to vector expansions.</p>
<p>VLEN in the following is the hart&rsquo;s vector length, determined at execution time.  It is usually something like 128 bits for a general purpose core (aka hart) and up to 1024 bits
for a dedicated accelerator hart.</p>
<h3 id="memcpy-with-known-and-limited-nbytes">memcpy with known and limited nbytes</h3>
<p>This pattern is often found when copying objects of known and limited size.  It is useful with objects as small as 4 bytes if the source alignment is
unknown and the destination object must be aligned on half-word, word, or double-word boundaries.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>;                memcpy(dest=a0, src=a3, nbytes=a4) where a4 &lt; 8 * (VLEN/8)
</span></span><span style="display:flex;"><span>1d3da:  0c377057                vsetvli zero,a4,e8,m8,ta,ma
</span></span><span style="display:flex;"><span>1d3de:  02068407                vle8.v  v8,(a3)
</span></span><span style="display:flex;"><span>1d3e2:  02050427                vse8.v  v8,(a0)
</span></span></code></pre></div><h3 id="memcpy-with-unknown-nbytes">memcpy with unknown nbytes</h3>
<p>This pattern is usually found in a simple loop, moving 8 * (VLEN/8) bytes at a time.
The a5 register holds the number of bytes processed per iteration.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>;                memcpy(dest=a6, src=a7, nbytes=a0) 
</span></span><span style="display:flex;"><span>1d868:  0c3577d7                vsetvli a5,a0,e8,m8,ta,ma
</span></span><span style="display:flex;"><span>1d86c:  02088407                vle8.v  v8,(a7)
</span></span><span style="display:flex;"><span>1d872:  02080427                vse8.v  v8,(a6)
</span></span></code></pre></div><h3 id="widening-floating-point-reduction">widening floating point reduction</h3>
<p>The next example appears to be compiled from <code>estimate_diarization_speaker</code> whose source is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">energy0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0f</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">energy1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0f</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int64_t</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">is0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">is1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">energy0</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">fabs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcmf32s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">energy1</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">fabs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pcmf32s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This is a typical reduction with widening pattern.</p>
<p>The vector instructions generated are:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>242ce:  0d8077d7                vsetvli a5,zero,e64,m1,ta,ma
</span></span><span style="display:flex;"><span>242d2:  5e0031d7                vmv.v.i v3,0
</span></span><span style="display:flex;"><span>242d6:  9e303257                vmv1r.v v4,v3
</span></span><span style="display:flex;"><span>242da:  0976f7d7                vsetvli a5,a3,e32,mf2,tu,ma
</span></span><span style="display:flex;"><span>242e4:  0205e107                vle32.v v2,(a1)
</span></span><span style="display:flex;"><span>242e8:  02066087                vle32.v v1,(a2)
</span></span><span style="display:flex;"><span>242ec:  2a211157                vfabs.v v2,v2
</span></span><span style="display:flex;"><span>242f0:  2a1090d7                vfabs.v v1,v1
</span></span><span style="display:flex;"><span>242f8:  d2411257                vfwadd.wv       v4,v4,v2
</span></span><span style="display:flex;"><span>242fc:  d23091d7                vfwadd.wv       v3,v3,v1
</span></span><span style="display:flex;"><span>24312:  0d8077d7                vsetvli a5,zero,e64,m1,ta,ma
</span></span><span style="display:flex;"><span>24316:  4207d0d7                vfmv.s.f        v1,fa5
</span></span><span style="display:flex;"><span>2431a:  063091d7                vfredusum.vs    v3,v3,v1
</span></span><span style="display:flex;"><span>2431e:  42301757                vfmv.f.s        fa4,v3
</span></span><span style="display:flex;"><span>24326:  06409257                vfredusum.vs    v4,v4,v1
</span></span><span style="display:flex;"><span>2432a:  424017d7                vfmv.f.s        fa5,v4
</span></span></code></pre></div><p>A hypothetical vectorized Ghidra might decompile these instructions (ignoring the scalar instructions not displayed here) as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">vector</span> <span style="color:#000">v3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v4</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// SEW=64 bit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f57900">v3</span> <span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vector</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// load immediate
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f57900">v4</span> <span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">v3</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">// vector copy
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">vector</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v2</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// SEW=32 bit
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">while</span><span style="color:#000;font-weight:bold">(...)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">v2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vector</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">a1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">v1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vector</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">a2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">v2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">abs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">v1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">abs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">v4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">v4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">v2</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// widening 32 to 64 bits
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">v3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">v3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// widening 32 to 64 bits
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">vector</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fa5</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// fa5 is the scalar &#39;carry-in&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">v3</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#a40000">⅀</span> <span style="color:#000">v3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// unordered vector reduction
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">fa4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">v3</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000">v4</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">v1</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#a40000">⅀</span> <span style="color:#000">v4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">fa5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">v4</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span></code></pre></div><p>The vector instruction <code>vfredusum.vs</code> provides the <em>unordered</em> reduction sum over the elements of a single vector.  That&rsquo;s likely faster than an ordered sum,
but the floating point round-off errors will not be deterministic.</p>
<blockquote>
<p>Note: this <code>whisper.cpp</code> routine attempts to recognize which of two speakers is responsible for each word of a conversation.  A speaker-misattribution
exploit might attack functions that call this.</p>
</blockquote>
<h3 id="complex-structure-element-copy">complex structure element copy</h3>
<p>The source code includes:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">drwav_uint64</span> <span style="color:#000">drwav_read_pcm_frames_s16__msadpcm</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">drwav</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">pWav</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">drwav_uint64</span> <span style="color:#000">framesToRead</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">drwav_int16</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">pBufferOut</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bytesRemainingInBlock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">blockAlign</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">header</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predictor</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">header</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">predictor</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">header</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">delta</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">drwav__bytes_to_s16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">header</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">delta</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">drwav__bytes_to_s16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">header</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prevFrames</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">drwav_int32</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">drwav__bytes_to_s16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">header</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prevFrames</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">drwav_int32</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">drwav__bytes_to_s16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">header</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prevFrames</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">drwav_int32</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">drwav__bytes_to_s16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">header</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prevFrames</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">drwav_int32</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">drwav__bytes_to_s16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">header</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedFrames</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prevFrames</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedFrames</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prevFrames</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedFrames</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prevFrames</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedFrames</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">prevFrames</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pWav</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">msadpcm</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cachedFrameCount</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This gets vectorized into sequences containing:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>2c6ce:  ccf27057                vsetivli        zero,4,e16,mf2,ta,ma ; vl=4, SEW=16
</span></span><span style="display:flex;"><span>2c6d2:  5e06c0d7                vmv.v.x v1,a3              ; v1[0..3] = a3
</span></span><span style="display:flex;"><span>2c6d6:  3e1860d7                vslide1down.vx  v1,v1,a6   ; v1 = v1[1:3], a6
</span></span><span style="display:flex;"><span>2c6da:  3e1760d7                vslide1down.vx  v1,v1,a4   ; v1 = v1[1:3], a4
</span></span><span style="display:flex;"><span>2c6de:  3e1560d7                vslide1down.vx  v1,v1,a0   ; v1 = (a3,a6,a4,a0)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2c6e2:  0d007057                vsetvli zero,zero,e32,m1,ta,ma ; keep existing vl (=4), SEW=32
</span></span><span style="display:flex;"><span>2c6e6:  4a13a157                vsext.vf2       v2,v1      ; v2 = vector sext(v1) // widening sign extend
</span></span><span style="display:flex;"><span>2c6ea:  0207e127                vse32.v v2,(a5)            ; memcpy(a5, v2, 4 * 4)
</span></span><span style="display:flex;"><span>2c6f2:  0a07d087                vlse16.v        v1,(a5),zero ; v1 = a5[]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2c6fa:  0cf07057                vsetvli zero,zero,e16,mf2,ta,ma
</span></span><span style="display:flex;"><span>2c702:  3e1660d7                vslide1down.vx  v1,v1,a2   ; v1 = v1[1:3], a2
</span></span><span style="display:flex;"><span>2c70a:  3e16e0d7                vslide1down.vx  v1,v1,a3   ; v1 = v1[1:3], a3
</span></span><span style="display:flex;"><span>2c70e:  3e1760d7                vslide1down.vx  v1,v1,a4   ; v1 = v1[1:3], a4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2c712:  0d007057                vsetvli zero,zero,e32,m1,ta,ma
</span></span><span style="display:flex;"><span>2c716:  4a13a157                vsext.vf2       v2,v1
</span></span><span style="display:flex;"><span>2c71a:  0205e127                vse32.v v2,(a1)
</span></span></code></pre></div><p>That&rsquo;s the kind of messy code you could analyze if you had to.  Hopefully not.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d77850d09fb290e7cb56386d07705a81">6.2 - Application Top Down Analysis</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>How much complexity do vector instructions add to a top down analysis?</p>

</div>

<p>We know that whisper.cpp contains lots of vector instructions.  Now we want to understand how few vector instruction blocks we really need to understand.</p>
<p>For this analysis we will assume a specific goal - inspect the final text output phase to see if an adversary has modified the generated text.</p>
<p>First we want to understand the unmodified behavior using a simple demo case.  One of the whisper.cpp examples works well. It was built for the x86-64-v3 platform, not the riscv-64 gcv platform,
but that&rsquo;s fine - we just want to understand the rough sequencing and get a handle on the strings we might find in or near the top level main routine.</p>
<h2 id="what-is-the-expected-behavior">what is the expected behavior?</h2>
<blockquote>
<p>Note: added comments are flagged with <code>//</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">/opt/whisper_cpp$ ./main -f samples/jfk.wav
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_init_from_file_with_params_no_state: loading model from &#39;models/ggml-base.en.bin&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: loading model
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: n_vocab       = 51864
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: n_audio_ctx   = 1500
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: n_audio_state = 512
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: n_audio_head  = 8
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: n_audio_layer = 6
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: n_text_ctx    = 448
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: n_text_state  = 512
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: n_text_head   = 8
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: n_text_layer  = 6
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: n_mels        = 80
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: ftype         = 1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: qntvr         = 0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: type          = 2 (base)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: adding 1607 extra tokens
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: n_langs       = 99
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load:      CPU total size =   147.46 MB (1 buffers)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_model_load: model size    =  147.37 MB
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_init_state: kv self size  =   16.52 MB
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_init_state: kv cross size =   18.43 MB
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_init_state: compute buffer (conv)   =   14.86 MB
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_init_state: compute buffer (encode) =   85.99 MB
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_init_state: compute buffer (cross)  =    4.78 MB
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_init_state: compute buffer (decode) =   96.48 MB
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">system_info: n_threads = 4 / 16 | AVX = 1 | AVX2 = 1 | AVX512 = 0 | FMA = 1 | NEON = 0 | ARM_FMA = 0 | METAL = 0 | F16C = 1 | FP16_VA = 0 | WASM_SIMD = 0 | BLAS = 0 | SSE3 = 1 | SSSE3 = 1 | VSX = 0 | CUDA = 0 | COREML = 0 | OPENVINO = 0 | 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">// done with initialization, lets run speach-to-text
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">main: processing &#39;samples/jfk.wav&#39; (176000 samples, 11.0 sec), 4 threads, 1 processors, 5 beams + best of 5, lang = en, task = transcribe, timestamps = 1 ...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">// this is the reference line our adversary wants to modify:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[00:00:00.000 --&gt; 00:00:11.000]   And so my fellow Americans, ask not what your country can do for you, ask what you can do for your country.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">// display statistics
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_print_timings:     load time =   183.72 ms
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_print_timings:     fallbacks =   0 p /   0 h
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_print_timings:      mel time =    10.30 ms
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_print_timings:   sample time =    33.90 ms /   131 runs (    0.26 ms per run)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_print_timings:   encode time =   718.87 ms /     1 runs (  718.87 ms per run)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_print_timings:   decode time =     8.35 ms /     2 runs (    4.17 ms per run)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_print_timings:   batchd time =   150.96 ms /   125 runs (    1.21 ms per run)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_print_timings:   prompt time =     0.00 ms /     1 runs (    0.00 ms per run)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">whisper_print_timings:    total time =  1110.87 ms
</span></span></span></code></pre></div><p>The adversary wants to change the text output from &ldquo;&hellip; ask not what you can do for your country.&rdquo; to &ldquo;&hellip; ask not what you can do for your enemy.&rdquo;
They likely drop a string substitution into the code between the output of <code>main: processing</code> and <code>whisper_print_timings:</code>, probably very close to
code printing timestamp intervals like <code>[00:00:00.000 --&gt; 00:00:11.000]</code>.</p>
<h2 id="what-function-names-and-strings-look-relevant">what function names and strings look relevant?</h2>
<p>Our RISCV-64 binary retains some function names and lots of relevant strings.  We want to accumulate strings that occur in the demo printout,
then glance at the functions that reference those strings.</p>
<p>For this example we will use a binary that includes some debugging type information.  Ghidra can determine names of structure types but not necessarily
the size or field names of those structures.</p>
<h3 id="strings">strings</h3>
<ul>
<li><code>%s: processing '%s' (%d samples, %.1f sec), %d threads, %d processors, %d beams + best of %d, lang = %s, task = %s, %stimestamps = %d ...</code> is referenced
near the middle of <code>main</code></li>
<li><code>[%s --&gt; %s]</code> is referenced by <code>whisper_print_segment_callback</code></li>
<li><code>[%s --&gt; %s]  %s\n</code> is referenced by <code>whisper_full_with_state</code></li>
<li><code>segment</code> occurs in several places, suggesting that the word refers to a segment of text generated from speech between two timestamps.</li>
<li><code>ctx</code> occurs 33 times, suggesting that a context structure is used - and occasionally displayed with field names</li>
<li><code>error: failed to initialize whisper context\n</code> is referenced within <code>main</code>.  It may help in understanding internal data organization.</li>
</ul>
<h3 id="functions">functions</h3>
<ul>
<li><code>main</code> - Ghidra decompiles this as ~1000 C statements, including many vector statements</li>
<li><code>whisper_print_timings</code> - referenced directly in main near the end</li>
<li><code>whisper_full_with_state</code> - referenced indirectly from main via <code>whisper_full_parallel</code> and <code>whisper_full</code></li>
<li><code>output_txt</code> - referenced directly in main, invokes I/O routines like <code>std::__ostream_insert&lt;&gt;</code>.  There are
other output routines like <code>output_json</code>.  The specific output routine can be selected as a command line parameter
to <code>main</code>.</li>
</ul>
<h3 id="types-and-structs">types and structs</h3>
<p>Ghidra knows that these exist as names, but the details are left to us to unravel.</p>
<ul>
<li><code>gpt_params</code> and <code>gpt_vocab</code> - these look promising, at a lower ML level</li>
<li><code>whisper_context</code> - this likely holds most of the top-level data</li>
<li><code>whisper_full_params</code> and <code>whisper_params</code> - likely structures related to the optional parameters
revealed with the <code>--help</code> command line option.</li>
<li><code>whisper_segment</code> - possibly a segment of digitized audio to be converted as speech.</li>
<li><code>whisper_vocab</code> - possible holding the text words known to the training data.</li>
</ul>
<h3 id="notes">notes</h3>
<p>Now we have enough context to narrow the search.  We want to know:</p>
<ul>
<li>how does <code>main</code> call either <code>whisper_print_segment_callback</code> or <code>whisper_full_with_state</code>.
<ul>
<li><code>whisper_full</code> is called directly by <code>main</code>.  Ghidra reports this to be about 3000 lines of C.  The Ghidra
call tree suggests that this function does most of the text-to-speech tensor math and other ML heavy lifting.</li>
<li><code>whisper_print_segment_callback</code> appears to be inserted into a C++ object vtable as a function pointer.  The object itself
appears to be built on <code>main</code>&rsquo;s stack, so we don&rsquo;t immediately know its size or use.  <code>whisper_print_segment_callback</code> is less than a tenth the size of
<code>whisper_full_with_state</code>.</li>
</ul>
</li>
<li>how does the JFK output text get appended to the string <code>[%s --&gt; %s]</code>?</li>
<li>from what structures is the output text retrieved?</li>
<li>where are those structures initialized?  How large are they, and are any of their fields named
in diagnostic output?</li>
<li>are there any diagnostic routines displaying the contents of such structures?</li>
</ul>
<h2 id="next-steps">next steps</h2>
<p>A simple but tedious technique involves a mix of top-down and bottom-up analysis.  We work upwards from strings and function references, and down
from the <code>main</code> routine towards the functions associated with our target text string.  Trial and error with lots of backtracking are common here, so
switching back and forth between top-down and bottom-up exploration can provide fresh insights.</p>
<p>Remember that we don&rsquo;t want to understand any more of <code>whisper.cpp</code> than we have to.  The adversary we are chasing only wants to understand where
the generated text comes within reach.  Neither they nor we need to understand all of the ways the C++ standard library might use vector instructions
during I/O subsystem initialization.</p>
<p>On the other hand, they and we may need to recognize basic I/O and string handling operations, since the target text is likely to exist as either a
standard string or a standard vector of strings.</p>
<blockquote>
<p>Note: This isn&rsquo;t a tutorial on how to approach a C++ reverse engineering challenge - it&rsquo;s an
evaluation of how vectorization might make that more difficult and an exploration of
what additional tools Ghidra or Ghidra users may find useful when faced with vectorization.
That means we&rsquo;ll skip most of the non-vector analysis.</p>
</blockquote>
<h2 id="vectorization-obscures-initialization">vectorization obscures initialization</h2>
<p>This sequence from <code>main</code> affects initialization and obscures a possible exploit vector.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e8m8tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x17</span><span style="color:#000;font-weight:bold">);</span>         <span style="color:#8f5902;font-style:italic">// memcpy(puStack_110, &#34;models/ggml-base.en.bin&#34;, 0x17)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">auVar27</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xa6650</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e8m8tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xf</span><span style="color:#000;font-weight:bold">);</span>          <span style="color:#8f5902;font-style:italic">// memcpy(puStack_f0, &#34;&#34; [SPEAKER_TURN]&#34;, 0xf)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">auVar26</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xa6668</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">puStack_f0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">auStack_e0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e8m8tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x17</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar27</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">puStack_110</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e8m8tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar26</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">puStack_f0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">puStack_d0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">uStack_c0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e64m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>           <span style="color:#8f5902;font-style:italic">// memset(lStack_b0, 0, 16)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar25</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vse64_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar25</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">lStack_b0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">puStack_110</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x17</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;\0&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>If the hypothetical adversary wanted to replace the training model <code>ggml-base.en.bin</code> with a less benign model, changing the
memory reference within <code>vle8_v(0xa6650)</code> would be a good place to do it.  Note that the compiler has interleaved instructions
generated from the two memcpy expansions, at the cost of two extra <code>vsetivli</code> instructions.  This allows more time for the
vector load instructions to complete.</p>
<h2 id="focus-on-output_txt">Focus on <code>output_txt</code></h2>
<p>Some browsing in Ghidra suggests that the following section of <code>main</code> is close to where we need to focus.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#000">lVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">whisper_full_parallel</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">pFVar18</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">pvStack_348</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">lStack_340</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">pvStack_348</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">pvVar20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar11</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">putchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pFVar18</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">do_output_txt</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/* try { // try from 0001dce8 to 0001dceb has its CatchHandler @ 0001e252 */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">operator</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">full_params</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#000">undefined8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">pFStack_2e0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">pFStack_2d8</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#000">undefined8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#4e9a06">&#34;.txt&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">pvVar20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar13</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">full_params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_0_8_</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/* try { // try from 0001dcfc to 0001dcfd has its CatchHandler @ 0001e2ec */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;::</span><span style="color:#000">vector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unaff_s3</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">unaff_s5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">/* try { // try from 0001dd06 to 0001dd09 has its CatchHandler @ 0001e2f0 */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">output_txt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar13</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#000">vector</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">unaff_s3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;::~</span><span style="color:#000">vector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unaff_s3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">__cxx11</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">basic_string</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;::</span><span style="color:#000">_M_dispose</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">basic_string</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">full_params</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Looking into <code>output_txt</code> Ghidra gives us:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">output_txt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">whisper_context</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">output_file_path</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">whisper_params</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">vector</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">param_4</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_stderr</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;%s: saving output to </span><span style="color:#4e9a06">\&#39;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\&#39;\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#4e9a06">&#34;output_txt&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">output_file_path</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">max_index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">whisper_full_n_segments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">max_index</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">__s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">whisper_full_get_segment_text</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">strlen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__s</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">__ostream_insert</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">basic_ostream</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">plVar7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">__s</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">sVar8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">max_index</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Finally, <code>whisper_full_get_segment_text</code> is decompiled into:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">undefined8</span> <span style="color:#000">whisper_full_get_segment_text</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">whisper_context</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">index</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">0x50</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">ctx</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">state</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0xa5f8</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Now the adversary has enough information to try rewriting the generated text from an arbitrary segment of speech.
The text is found in an array linked into the <code>ctx</code> context variable, probably during the call to <code>whisper_full_parallel</code>.</p>
<h2 id="added-complexity-of-vectorization">added complexity of vectorization</h2>
<p>Our key goal is to understand how much effort to put into Ghidra&rsquo;s decompiler processing of RISCV-64 vector instructions.
The metric for measuring that effort is relative to the effort needed to understand the other instructions produced by a C++
optimizing compiler implementing libstdc++ containers like vectors.</p>
<p>Take a closer look at the call to <code>output_txt</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;::</span><span style="color:#000">vector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unaff_s3</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">unaff_s5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">output_txt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar13</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#000">vector</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">unaff_s3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;::~</span><span style="color:#000">vector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unaff_s3</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>The <code>unaff_s3</code> parameter to <code>output_txt</code> might be important.  Maybe we should examine the constructor and destructor for
this object to probe its internal structure.</p>
<p>In fact <code>unaff_s3</code> is only used when passing stereo audio into <code>output_txt</code>, so it is more of a red herring
slowing down the analysis than a true roadblock.  Its internal structure is a C++ standard vector of C++ standard vectors
of float, so it&rsquo;s a decent example of what happens when RISCV-64 vector instructions are used implementing vectors
(and two dimensional matrices) at a higher abstraction level.</p>
<p>A little analysis shows us that <code>std::vector&lt;&gt;::vector</code> is actually a copy constructor for a class generated from
a vector template.  The true type of <code>unaff_s3</code> and <code>unaff_s5</code> is roughly <code>std::vector&lt;std::vector&lt;float&gt;&gt;</code>.</p>
<blockquote>
<p>Comment: the copy constructor and the associated destructor are likely present only because the programmer didn&rsquo;t mark
the parameter as a <code>const</code> reference.</p>
</blockquote>
<p>The destructor <code>std::vector&lt;&gt;::~vector(unaff_s3)</code> listing shows no vector instructions are used.  The inner vectors
are deleted and their memory reclaimed, then the outer containing vector is deleted.</p>
<p>The constructor <code>std::vector&lt;&gt;::vector</code> is different.  Vector instructions are used often, but in very simple contexts.</p>
<ul>
<li>The only <code>vset</code> mode used is <code>vsetivli_e64m1tama(2)</code>, asking for no more than two 64 bit elements in a vector register</li>
<li>The most common vector pattern stores 0 into two adjacent 64 bit pointers</li>
<li>In one case a 64 bit value is stored into two adjacent 64 bit pointers.</li>
</ul>
<h2 id="summary">Summary</h2>
<p>If whisper.cpp is representative of a broader class of ML programs compiled for RISCV-64 vector-enabled hardware, then:</p>
<ol>
<li>Ghidra&rsquo;s sleigh subsystem needs to recognize at least those vector instructions found in the rvv 1.0 release.</li>
<li>The decompiler view should have access to pcodeops for all of those vector instructions.</li>
<li>The 20 to 50 most common <code>vset*</code> configurations (e.g., <code>e64m1tama</code>) should be explicitly recognized at the pcodeop layer
and displayed in the decompiler view.</li>
<li>Ghidra users should have documentation on common RISCV-64 vector instruction patterns generated during compilation.
These patterns should include common loop patterns and builtin expansions for <code>memcpy</code> and <code>memset</code>, plus examples showing
the common source code patterns resulting in vector reduction, width conversion, slideup/down, and gather/scatter instructions.</li>
</ol>
<p>Other Ghidra extensions would be nice to have but likely deliver diminishing bang-for-the-buck relative to multiplatform
C++ analytics:</p>
<ol>
<li>Extend sleigh <code>*.sinc</code> file syntax to convey comments or hints to be visible in the decompiler view, either as pop-ups,
instruction info, or comment blocks.</li>
<li>Take advantage of the open source nature of RISCV ISA to display links to open source documents on vector instructions
when clicking on a given instruction.</li>
<li>Treat pcodeops as function calls within the decompiler view, enabling signature overrides and type assignment to the
arguments.</li>
<li>Create a decompiler plugin framework that can scan the decompiled source and translate vector instruction patterns back
into calls to <code>__builtin_memcpy(...)</code> calls.</li>
<li>Create a decompiler plugin framework that can scan the decompiled source and generate inline comments in a sensible
vector notation.</li>
</ol>
<p>The toughest challenges might be:</p>
<ol>
<li>Find a Ghidra micro-architecture-independent approach to untangling vector instruction generation.</li>
<li>Use ML translation techniques to match C, C++, and Rust source patterns to generated vector instruction sequences
for known architectures, compilers, and compiler optimization settings.</li>
</ol>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-072688248485f33579467bee95bae159">7 - Testbed Internals</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>This testbed uses several open source components that need descriptions and reference links.</p>

</div>

<h2 id="ghidra-development-sources">Ghidra development sources</h2>
<p>We track the <a href="https://github.com/NationalSecurityAgency/ghidra">Ghidra repository</a> for released Ghidra packages, currently Ghidra 11.0.
A <a href="https://github.com/thixotropist/ghidra/tree/isa_ext">Ghidra fork</a> is also used here which adds proposed RISCV instruction set
extension support.
The host environment for this project is currently a Fedora 39 workstation with an AMD Ryzen 9 5900HX and 32 GB of RAM.</p>
<h2 id="toolchain-sources">Toolchain sources</h2>
<h3 id="binutils">binutils</h3>
<ul>
<li>source repo: <a href="https://sourceware.org/git/binutils-gdb.git">https://sourceware.org/git/binutils-gdb.git</a></li>
<li>commit 2c73aeb8d2e02de7b69cbcb13361cfbca9d76a4e (HEAD, tag: binutils-2_41), 30 July 2023.</li>
<li>local source directory <code>/home2/vendor/binutils-gdb</code></li>
</ul>
<h3 id="gcc-stdlib">gcc, stdlib</h3>
<ul>
<li>source repo: git://gcc.gnu.org/git/gcc.git</li>
<li>commit ac9c81dd76cfc34ed53402049021689a61c6d6e7 (HEAD -&gt; master, origin/trunk, origin/master, origin/HEAD),
Date:   Mon Dec 18 21:40:00 2023 +0800</li>
<li>local source directory <code>/home2/vendor/gcc</code></li>
</ul>
<h3 id="glibc">glibc</h3>
<ul>
<li>source repo: <a href="mailto:git@github.com">git@github.com</a>:bminor/glibc.git</li>
<li>commit e957308723ac2e55dad360d602298632980bbd38 (HEAD -&gt; master, origin/master, origin/HEAD)
Date:   Fri Dec 15 12:04:05 2023 -0800</li>
<li>local source directory <code>/home2/vendor/glibc</code></li>
</ul>
<h3 id="bazel">Bazel</h3>
<ul>
<li>release repo <a href="https://github.com/bazelbuild/bazel">https://github.com/bazelbuild/bazel</a></li>
<li>release 7.0 currently used</li>
</ul>
<h2 id="website-sources">website sources</h2>
<ul>
<li>hugo v0.120.4, installed as a Fedora snap package</li>
<li>docsy v0.8.0</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f87ee424d6df97dd57d1be27296c9cc4">7.1 - adding toolchains</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Adding a new toolchain takes lots of little steps, and some trial and error.</p>

</div>

<h2 id="overview">Overview</h2>
<p>We want x86_64 exemplars built with the same next generation of gcc, libc, and libstdc++ as
we use for RISCV exemplars.  This will give us some hints about how common new issues may
be and how global new solutions may need to be.</p>
<p>We will generate this x86_64 gcc-14 toolchain about the same way as our existing RISCV-64 gcc-14 toolchain.</p>
<p>This example uses the latest released version of binutils and the development head of gcc and glibc.</p>
<p>If we were building a toolchain for an actual product we would start by configuring and building
a specialized kernel, which would prepopulate the system root.  We aren&rsquo;t doing that here, so
we will use placeholders from the Fedora 39 x86_64 kernel.</p>
<h2 id="binutils-and-the-first-gcc-pass">binutils and the first gcc pass</h2>
<p>We want binutils installed first.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> <span style="color:#204a87">cd</span> /home2/vendor/binutils-gdb
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> git log
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">commit 2c73aeb8d2e02de7b69cbcb13361cfbca9d76a4e (HEAD, tag: binutils-2_41)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Author: Nick Clifton &lt;nickc@redhat.com&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Date:   Sun Jul 30 14:55:52 2023 +0100
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    The 2.41 release!
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> <span style="color:#204a87">cd</span> /home2/build_x86/binutils
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">.../vendor/binutils-gdb/configure --prefix=/opt/gcc14 --disable-multilib --enable-languages=c,c++,rust,lto
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> make
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make install
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span></code></pre></div><p>The gcc suite and the glibc standard library have a circular dependency.  We build and install
the basic gcc capability first, then glibc, and then finish with the rest of gcc.  During this process
we likely need to add system files to the new sysroot directory.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> <span style="color:#204a87">cd</span> /home2/vendor/gcc
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> git log
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">commit ac9c81dd76cfc34ed53402049021689a61c6d6e7 (HEAD -&gt; master, origin/trunk, origin/master, origin/HEAD)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Author: Pan Li &lt;pan2.li@intel.com&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Date:   Mon Dec 18 21:40:00 2023 +0800
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    RISC-V: Rename the rvv test case.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> <span style="color:#204a87">cd</span> /home2/build_x86/gcc
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">/home2/vendor/gcc/configure --prefix=/opt/gcc14 --disable-multilib --enable-languages=c,c++,rust,lto
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> make
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> make install
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span></code></pre></div><p>The <code>make</code> and <code>make install</code> may throw errors after completing the basic compiler.  If so, we can
complete the build after we get glibc installed.</p>
<h2 id="glibc">glibc</h2>
<p>We should have enough of gcc-14 built to configure and build the 64 bit glibc package.  This pending release of glibc
has lots of changes, so we can expect some tinkering to get it to work for us.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> <span style="color:#204a87">cd</span> /home2/vendor/glibc
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> git log
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">commit e957308723ac2e55dad360d602298632980bbd38 (HEAD -&gt; master, origin/master, origin/HEAD)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Author: Matthew Sterrett &lt;matthew.sterrett@intel.com&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Date:   Fri Dec 15 12:04:05 2023 -0800
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    x86: Unifies &#39;strlen-evex&#39; and &#39;strlen-evex512&#39; implementations.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> mkdir -p /home2/build_x86/glibc
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> <span style="color:#204a87">cd</span> /home2/build_x86/glibc
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> /home2/vendor/glibc/configure <span style="color:#000">CC</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/opt/gcc14/bin/gcc&#34;</span> --prefix<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/usr&#34;</span> <span style="color:#000">install_root</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/gcc14/sysroot --disable-werror --enable-shared --disable-multilib
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make <span style="color:#000">install_root</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/gcc14/sysroot install
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> du -hs /opt/gcc14/sysroot
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">105M	/opt/gcc14/sysroot
</span></span></span></code></pre></div><h2 id="gcc-finish">gcc finish</h2>
<p>If the <code>gcc</code> installation errored out before completion, try it again after glibc is installed.  This time it should complete without error.</p>
<h2 id="testing-the-local-toolchain">testing the local toolchain</h2>
<p>Next we want to exercise the toolchain by compiling a very simple C program:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1320</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;\0&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>We&rsquo;ll build it with three sets of options and import all three into Ghidra 11</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">/opt/gcc14/bin/gcc gcc_vectorization/helloworld_challenge.c -o a_unoptimized.out
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">/opt/gcc14/bin/gcc -O3 gcc_vectorization/helloworld_challenge.c -o a_host_optimized.out
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">/opt/gcc14/bin/gcc -march=rocketlake -O3 gcc_vectorization/helloworld_challenge.c -o a_rocketlake_optimized.out
</span></span></span></code></pre></div><blockquote>
<p>Note: Rocket Lake is Intel&rsquo;s codename for its 11th generation Core microprocessors</p>
</blockquote>
<p>Ghidra 11 gives us:</p>
<ul>
<li><code>a_unoptimized.out</code> imports and decompiles cleanly, with recognizable disassembly and decompiler output of 5 lines of code.</li>
<li><code>a_host_optimized.out</code> imports cleanly and decompiles into about 150 lines of hard-to-interpret C code.  The loop has been
autovectorized using instructions like <code>PUNPCKHWD</code>, <code>PUNPCKLWD</code>, and <code>PADDD</code>.  These appear to be AVX-512 vector extensions.</li>
<li><code>a_rocketlake_optimized.out</code> fails to disassemble <em>or</em> decompile when it hits AVX2 instructions like <code>vpbroadcastd</code>.
Binutils 2.41&rsquo;s <code>objdump</code> appears to recognize these instructions.</li>
</ul>
<p>As a stretch goal, what does the gcc-14 Rust compiler give us?</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">/opt/gcc14/bin/gccrs -frust-incomplete-and-experimental-compiler-do-not-use src/main.rs
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">src/main.rs:25:5: error: unknown macro: [log::info]
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">   25 |     log::info!(
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">      |     ^~~
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">src/main.rs:29:5: error: unknown macro: [log::info]
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">   29 |     log::info!(
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">      |     ^~~
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span></code></pre></div><p>If gccrs can&rsquo;t handle basic rust macros, it isn&rsquo;t very useful for generating exemplars.  We won&rsquo;t include it in our portable toolchain.</p>
<h2 id="packaging-the-toolchain">packaging the toolchain</h2>
<p>Now we need to make the toolchain hermetic, portable, and ready for Bazel workspaces.</p>
<p>Hermeticity means that nothing under <code>/opt/gcc14</code> makes a hidden reference to local host files under <code>/usr</code>.  Any such reference needs to
be changed into a relative reference.  These are common in short shareable object files that link to one or more true shareable object libraries.</p>
<p>You can often identify possible troublemakers by searching for smallish regular files with a <code>.so</code> extension.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> find /opt/gcc14 -name <span style="color:#4e9a06">\*</span>.so -type f -size -1000c -ls
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">/opt/gcc14$ find /opt/gcc14 -name \*.so -type f -size -1000c -ls
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">... 273 Dec 27 12:41 /opt/gcc14/lib/libc.so
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">... 126 Dec 27 12:42 /opt/gcc14/lib/libm.so
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">... 132 Dec 27 11:42 /opt/gcc14/lib64/libgcc_s.so
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> cat /opt/gcc14/lib/libc.so
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">/* GNU ld script
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">   Use the shared library, but some functions are only in
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">   the static library, so try that secondarily.  */
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">OUTPUT_FORMAT(elf64-x86-64)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GROUP ( /opt/gcc14/lib/libc.so.6 /opt/gcc14/lib/libc_nonshared.a  AS_NEEDED ( /opt/gcc14/lib/ld-linux-x86-64.so.2 ) )
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> cat /opt/gcc14/lib/libm.so
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">/* GNU ld script
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">*/
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">OUTPUT_FORMAT(elf64-x86-64)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GROUP ( /opt/gcc14/lib/libm.so.6  AS_NEEDED ( /opt/gcc14/lib/libmvec.so.1 ) )
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> cat /opt/gcc14/lib/libm.so
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">/* GNU ld script
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">*/
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">OUTPUT_FORMAT(elf64-x86-64)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GROUP ( /opt/gcc14/lib/libm.so.6  AS_NEEDED ( /opt/gcc14/lib/libmvec.so.1 ) )
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">thixotropist@mini:/opt/gcc14$ cat /opt/gcc14/lib64/libgcc_s.so
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">/* GNU ld script
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">   Use the shared library, but some functions are only in
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">   the static library.  */
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GROUP ( libgcc_s.so.1 -lgcc )
</span></span></span></code></pre></div><p>So two of the three files need patching: replacing <code>/opt/gcc14/lib</code> with <code>.</code>.  Any text editor will do.</p>
<p>Next we need to identify all dynamic host dependencies of binaries under <code>/opt/gcc14</code>.
The <code>ldd</code> command will identify these local system files,
which should be collected into a separate tarball.  This tarball can be shared with other cross-compilers
built at the same time, and is generally portable across similar Linux kernels and distributions.</p>
<p>At this point we can <code>strip</code> the executable files within the toolchain and identify the ones we want to keep in the portable toolchain tarball.
Scripts under <code>toolchain/toolchains/gcc-14-*/scripts</code> will help with that.</p>
<p><code>generate.sh</code> uses rsync to copy selected files from <code>/opt/gcc14</code> into <code>/tmp/export</code>, stripping the known binaries, and creating the portable tarball.
It then collects relevant dynamic libraries from the host and creates a second portable tarball.</p>
<p>These two tarballs can then be copied to other computers and imported into a project by adding stanzas to the project WORKSPACE file.</p>
<h2 id="installing-the-toolchain">installing the toolchain</h2>
<p>The toolchain tarball is currently in <code>/opt/bazel``.  We need its full path and sha256sum to make it accessible within our workspace. Edit </code>WORKSPACE` to include:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;@bazel_tools//tools/build_defs/repo:http.bzl&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;http_archive&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># gcc-14 x86_64 toolchain from snapshot gcc-14 and glibc development heads</span>
</span></span><span style="display:flex;"><span><span style="color:#000">http_archive</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;gcc-14-x86_64-toolchains&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">urls</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;file:///opt/bazel/x86_64_linux_gnu-14.tar.xz&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">build_file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;//:gcc-14-x86_64-toolchains.BUILD&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sha256</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;40cc4664a11b8da56478393c7c8b823b54f250192bdc1e1181c9e4f8ac15e3be&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># system libraries used by toolchain build system</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># We built the custom toolchain on a fedora x86_64 platform, so we need some</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># fedora x86_64 sharable system libraries to execute.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">http_archive</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;fedora39-system-libs&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">urls</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;file:///opt/bazel/fedora39_system_libs.tar.xz&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">build_file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;//:fedora39-system-libs.BUILD&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sha256</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;fe91415b05bb902964f05f7986683b84c70338bf484f23d05f7e8d4096949d1b&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>Bazel will unpack this tarball into an external project directory, something like <code>/run/user/1000/bazel/execroot/_main/external/gcc-14-x86_64-toolchains/</code>.
Individual files and filegroups within that directory are defined in <code>x86_64/toolchain/gcc-14-x86_64-toolchains.BUILD</code>.
The filegroup <code>compiler_files</code> is probably the most important, as it collects everything that might be used in anything launched from gcc or g++.
The full Bazel name for this filegroup is <code>@gcc-14-x86_64-toolchains//:compiler_files</code>.</p>
<p>Each custom toolchain is defined within the <code>x86_64/toolchain/toolchains/BUILD</code> file.  This associates filegroups from a (possibly shared) toolchain tarball like
<code>gcc-14-x86_64-toolchains</code> with a set of default compiler and linker options and standard libraries.  We might want multiple gcc-14 toolchains, for building kernels,
kernel modules, and userspace applications respectively.</p>
<p>Most of the configuration exists within stanzas like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">toolchain</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;x86_64_default&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">target_compatible_with</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;:x86_64&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">toolchain</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:x86_64-default-gcc&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">toolchain_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;@bazel_tools//tools/cpp:toolchain_type&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cc_toolchain</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;x86_64-default-gcc&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">all_files</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:all_files&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ar_files</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:gcc_14_compiler_files&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">as_files</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:empty&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">compiler_files</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:gcc_14_compiler_files&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dwp_files</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:empty&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">linker_files</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:gcc_14_compiler_files&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">objcopy_files</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:empty&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">strip_files</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:empty&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">supports_param_files</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">toolchain_config</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:x86_64-default-gcc-config&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">toolchain_identifier</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;x86_64-default-gcc&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cc_toolchain_config</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;x86_64-default-gcc-config&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">abi_libc_version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:empty&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">abi_version</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:empty&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">compile_flags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># take the isystem ordering from the output of gcc -xc++ -E -v -</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;--sysroot&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;external/gcc-14-x86_64-toolchains/sysroot/&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-Wall&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">compiler</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;gcc&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">coverage_compile_flags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;--coverage&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">coverage_link_flags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;--coverage&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cpu</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;x86_64&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># we really want the following to be constructed from $(output_base) or $(location ...)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cxx_builtin_include_directories</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">OUTPUT_BASE</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;/external/gcc-14-x86_64-toolchains/sysroot/usr/include&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">OUTPUT_BASE</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;/external/gcc-14-x86_64-toolchains/x86_64-pc-linux-gnu/include/c++/14.0.0&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">OUTPUT_BASE</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;/external/gcc-14-x86_64-toolchains/lib/gcc/x86_64-pc-linux-gnu/14.0.0/include&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000">OUTPUT_BASE</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;/external/gcc-14-x86_64-toolchains/lib/gcc/x86_64-pc-linux-gnu/14.0.0/include-fixed&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>       <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cxx_flags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-std=c++20&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-fno-rtti&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dbg_compile_flags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;-g&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">host_system_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:empty&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">link_flags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;--sysroot&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;external/gcc-14-x86_64-toolchains/sysroot/&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">link_libs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;-lstdc++&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;-lm&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">opt_compile_flags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-g0&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-Os&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-DNDEBUG&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-ffunction-sections&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-fdata-sections&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">opt_link_flags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;-Wl,--gc-sections&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">supports_start_end_lib</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">target_libc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:empty&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">target_system_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;:empty&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">tool_paths</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;ar&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;gcc-14-x86_64/imported/ar&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;ld&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;gcc-14-x86_64/imported/ld&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;cpp&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;gcc-14-x86_64/imported/cpp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;gcc&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;gcc-14-x86_64/imported/gcc&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;dwp&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;:empty&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;gcov&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;:empty&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;nm&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;gcc-14-x86_64/imported/nm&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;objcopy&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;gcc-14-x86_64/imported/objcopy&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;objdump&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;gcc-14-x86_64/imported/objdump&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;strip&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;gcc-14-x86_64/imported/strip&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">toolchain_identifier</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;gcc-14-x86_64&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">unfiltered_compile_flags</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-fno-canonical-system-headers&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-Wno-builtin-macro-redefined&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-D__DATE__=</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">redacted</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-D__TIMESTAMP__=</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">redacted</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;-D__TIME__=</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">redacted</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>The <code>tool_paths</code> element points to small bash scripts needed to launch compiler components like <code>gcc</code> and <code>ar</code> and <code>strip</code>.
These give us the chance to use imported system shareable object libraries rather than the host&rsquo;s shareable object libraries.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">set</span> -euo pipefail
</span></span><span style="display:flex;"><span><span style="color:#000">PATH</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">`</span><span style="color:#204a87">pwd</span><span style="color:#4e9a06">`</span>/toolchains/gcc-14-x86_64/imported <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span><span style="color:#000">LD_LIBRARY_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span>external/fedora39-system-libs <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>  external/gcc-14-x86_64-toolchains/bin/gcc <span style="color:#4e9a06">&#34;</span><span style="color:#000">$@</span><span style="color:#4e9a06">&#34;</span>
</span></span></code></pre></div><h2 id="finding-the-hidden-toolchain-dependencies">finding the hidden toolchain dependencies</h2>
<p>Compiling and linking source files takes many dependent files from <code>/opt/gcc14</code>.  The next step is tedious and iterative - we need to prove
that the portable toolchain tarball derived from <code>/opt/gcc14</code> never references any file in that directory, or any local host file under <code>/usr</code>.
Bazel can do that for us, at the cost of identifying every file or file &lsquo;glob&rsquo; that may be called for each of the toolchain primitives.
It runs the toolchain in a sandbox, forcing an exception on all references not previously declared as dependencies.</p>
<p>This kind of exception looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">ERROR: /home/XXX/projects/github/ghidra_import_tests/x86_64/toolchain/userSpaceSamples/BUILD:3:10: Compiling userSpaceSamples/helloworld.c failed: absolute path inclusion(s) found in rule &#39;//userSpaceSamples:helloworld&#39;:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">the source file &#39;userSpaceSamples/helloworld.c&#39; includes the following non-builtin files with absolute paths (if these are builtin files, make sure these paths are in your toolchain):
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  &#39;/usr/include/stdc-predef.h&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  &#39;/usr/include/stdio.h&#39;
</span></span></span></code></pre></div><p>If you see this check:</p>
<ul>
<li>whether <code>stdio.h</code> was installed in the right directory under <code>/opt/gcc14</code>.</li>
<li>whether <code>stdio.h</code> was copied into <code>/tmp/export</code> when building the tarball</li>
<li>whether the instances of <code>stdio.h</code> appeared in the appropriate compiler file groups defined in <code>gcc-14-x86_64-toolchains.BUILD</code></li>
<li>whether those filegroups were properly imported into the Bazel sandbox for your build</li>
<li>whether the compile_flags for your toolchain tell gcc-14 to search the sandbox for the directories containing <code>stdio.h</code>
<pre tabindex="0"><code>&#34;-isystem&#34;, &#34;external/gcc-14-x86_64-toolchains/sysroot/usr/include&#34;,
</code></pre></li>
<li>whether the link_flags for your toolchain tell gcc-14 to search the sandbox for the directories containing <code>crt1.o</code> and <code>crti.o</code></li>
</ul>
<h2 id="using-the-toolchain">using the toolchain</h2>
<p>We can test our new toolchain with a build of <code>helloworld</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">x86_64/toolchain$ bazel clean
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Starting clean (this may take a while). Consider using --async if the clean takes more than several minutes.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">x86_64/toolchain$ bazel run -s --platforms=//platforms:x86_64_default userSpaceSamples:helloworld
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Analyzed target //userSpaceSamples:helloworld (69 packages loaded, 1538 targets configured).
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">SUBCOMMAND: # //userSpaceSamples:helloworld [action &#39;Compiling userSpaceSamples/helloworld.c&#39;, configuration: 672d6d72a34879952e2365b9bc032c10f7e50fda380c4b7c8e86b49faa982e8b, execution platform: @@local_config_platform//:host, mnemonic: CppCompile]
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">(cd /run/user/1000/bazel/execroot/_main &amp;&amp; \
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  exec env - \
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    PATH=/home/thixotropist/.local/bin:/home/thixotropist/bin:/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/var/lib/snapd/snap/bin:/home/thixotropist/.local/bin:/home/thixotropist/bin:/opt/ghidra_10.3.2_PUBLIC/:/home/thixotropist/.cargo/bin::/usr/lib/jvm/jdk-17-oracle-x64/bin:/opt/gradle-7.6.2/bin \
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    PWD=/proc/self/cwd \
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  toolchains/gcc-14-x86_64/imported/gcc -U_FORTIFY_SOURCE --sysroot external/gcc-14-x86_64-toolchains/sysroot/ -Wall -MD -MF bazel-out/k8-fastbuild/bin/userSpaceSamples/_objs/helloworld/helloworld.pic.d &#39;-frandom-seed=bazel-out/k8-fastbuild/bin/userSpaceSamples/_objs/helloworld/helloworld.pic.o&#39; -fPIC -iquote . -iquote bazel-out/k8-fastbuild/bin -iquote external/bazel_tools -iquote bazel-out/k8-fastbuild/bin/external/bazel_tools -fno-canonical-system-headers -Wno-builtin-macro-redefined &#39;-D__DATE__=&#34;redacted&#34;&#39; &#39;-D__TIMESTAMP__=&#34;redacted&#34;&#39; &#39;-D__TIME__=&#34;redacted&#34;&#39; -c userSpaceSamples/helloworld.c -o bazel-out/k8-fastbuild/bin/userSpaceSamples/_objs/helloworld/helloworld.pic.o)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">#</span> Configuration: 672d6d72a34879952e2365b9bc032c10f7e50fda380c4b7c8e86b49faa982e8b
</span></span><span style="display:flex;"><span><span style="color:#8f5902">#</span> Execution platform: @@local_config_platform//:host
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">SUBCOMMAND: # //userSpaceSamples:helloworld [action &#39;Linking userSpaceSamples/helloworld&#39;, configuration: 672d6d72a34879952e2365b9bc032c10f7e50fda380c4b7c8e86b49faa982e8b, execution platform: @@local_config_platform//:host, mnemonic: CppLink]
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">(cd /run/user/1000/bazel/execroot/_main &amp;&amp; \
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  exec env - \
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    PATH=/home/thixotropist/.local/bin:/home/thixotropist/bin:/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/var/lib/snapd/snap/bin:/home/thixotropist/.local/bin:/home/thixotropist/bin:/opt/ghidra_10.3.2_PUBLIC/:/home/thixotropist/.cargo/bin::/usr/lib/jvm/jdk-17-oracle-x64/bin:/opt/gradle-7.6.2/bin \
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    PWD=/proc/self/cwd \
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  toolchains/gcc-14-x86_64/imported/gcc -o bazel-out/k8-fastbuild/bin/userSpaceSamples/helloworld -Wl,-S --sysroot external/gcc-14-x86_64-toolchains/sysroot/ bazel-out/k8-fastbuild/bin/userSpaceSamples/_objs/helloworld/helloworld.pic.o -lstdc++ -lm)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">#</span> Configuration: 672d6d72a34879952e2365b9bc032c10f7e50fda380c4b7c8e86b49faa982e8b
</span></span><span style="display:flex;"><span><span style="color:#8f5902">#</span> Execution platform: @@local_config_platform//:host
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Found 1 target...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Target //userSpaceSamples:helloworld up-to-date:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  bazel-bin/userSpaceSamples/helloworld
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Elapsed time: 0.289s, Critical Path: 0.10s
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: 6 processes: 4 internal, 2 linux-sandbox.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Build completed successfully, 6 total actions
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Running command line: bazel-bin/userSpaceSamples/helloworld
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Hello World!
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> strings bazel-bin/userSpaceSamples/helloworld<span style="color:#000;font-weight:bold">|</span>grep -i gcc
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GCC: (GNU) 14.0.0 20231218 (experimental)
</span></span></span></code></pre></div><p>Things to note:</p>
<ul>
<li>The command line includes <code>--platforms=//platforms:x86_64_default</code> to show we are <em>not</em> building for the local host</li>
<li><code>toolchains/gcc-14-x86_64/imported/gcc</code> is invoked twice, once to compile and once to link</li>
<li><code>--sysroot external/gcc-14-x86_64-toolchains/sysroot</code> is used twice, to avoid including host files under <code>/usr</code></li>
<li>The <code>helloworld</code> executable happens to execute on the host machine.</li>
<li>The <code>helloworld</code> executable contains no references to gcc-13, the native toolchain on the host machine.</li>
</ul>
<p>Now try a C++ build:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel run -s --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:x86_64_default userSpaceSamples:helloworld++
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Target //userSpaceSamples:helloworld++ up-to-date:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  bazel-bin/userSpaceSamples/helloworld++
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Elapsed time: 0.589s, Critical Path: 0.51s
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: 3 processes: 1 internal, 2 linux-sandbox.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Build completed successfully, 3 total actions
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Running command line: bazel-bin/userSpaceSamples/helloworld++
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Hello World!
</span></span></span></code></pre></div><h2 id="cleanup">cleanup</h2>
<p>We&rsquo;ve got a working toolchain, but with many dangling links, duplicate files, and unused definitions.
The toolchain files normally provided by a kernel were copied in as needed from the host, with the understanding that we never
really needed unable applications.</p>
<p>If this were a production environment we would be a lot more careful.  It&rsquo;s not, so we will just summarize some of the areas
that might benefit from such a cleanup.</p>
<h2 id="toolchain-directories">toolchain directories</h2>
<p>Adding and testing a toolchain involves lots of similar-looking directories.</p>
<h3 id="optgcc14">/opt/gcc14</h3>
<p>This directory is the install target for our binutils, gcc, and glibc builds.  It is not itself used by the Bazel build
framework, and need not be present on any host machine running the toolchain.</p>
<ul>
<li>The overall size is reported as 3.1 GB, inflated somewhat by multiple hard links</li>
<li><code>fdupes</code> reports 2446 duplicate files (in 2136 sets), occupying 200.2 megabytes</li>
<li>There are six files over 150 MB in size</li>
</ul>
<h3 id="tmpexport">/tmp/export</h3>
<p>This directory holds a subset of <code>/opt/gcc14</code>, with many binaries stripped.  The hard links
of `/opt/gcc14`` are lost.  It may be discarded after the portable tarball is generated.</p>
<ul>
<li>the overall size is 731 MB</li>
<li><code>fdupes</code> reports 1010 duplicate files (in 983 sets), occupying 69.0 megabytes</li>
<li>There are 16 files over 10 MB in size</li>
</ul>
<h3 id="optbazelx86_64_linux_gnu-14tarxz">/opt/bazel/x86_64_linux_gnu-14.tar.xz</h3>
<p>The compressed portable tarball size is 171M.  It expands into a locally cached equivalent of <code>/tmp/export</code>.
This file must be accessible to Bazel during a cross-compilation, either as a file reference or as a remote http or
https URL.</p>
<h3 id="runuser1000bazelexecroot_mainexternalx86_64_linux_gnu-14">/run/user/1000/bazel/execroot/_main/external/x86_64_linux_gnu-14</h3>
<p>Bazel agents will decompress the tarball if and when needed into a local cache directory.  In this case, it is unpacked
into a RAM file system for speed.</p>
<h3 id="runuser1000bazelsandboxlinux-sandbox2execroot_mainexternalx86_64_linux_gnu-14">/run/user/1000/bazel/sandbox/linux-sandbox/2/execroot/_main/external/x86_64_linux_gnu-14</h3>
<p>Temporary sandboxes like this are created when individual compiler and linker steps are executed.  They implement whatever subset of the
cached toolchain tarball are explicitly named as dependencies for that step.  Toolchain references outside of the sandbox are often flagged
as hermeticity errors and abort the build.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8215111beadc6b00e6019d3773f2d36a">7.2 - debugging toolchains</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Debugging toolchains can be tedious</p>

</div>

<p>Suppose you wanted to build a gcc-14 toolchain with the latest glibc standard libraries, and you were using a Linux host with gcc-13 and reasonably
current glibc standard libraries.  How would you guarantee that none of your older host files were accidentally used where you expected
the newer gcc and glibc files to be used?</p>
<p>Bazel enforces this <em>hermeticity</em> by running all toolchain steps in a sandbox, where only declared dependencies of the toolchain components
are visible.  That means nothing under /usr or $HOME is generally available, and any attempt to access files there will abort the build.</p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">ERROR: /home/XXX/projects/github/ghidra_import_tests/x86_64/toolchain/userSpaceSamples/BUILD:3:10: Compiling userSpaceSamples/helloworld.c failed: absolute path inclusion(s) found in rule &#39;//userSpaceSamples:helloworld&#39;:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">the source file &#39;userSpaceSamples/helloworld.c&#39; includes the following non-builtin files with absolute paths (if these are builtin files, make sure these paths are in your toolchain):
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  &#39;/usr/include/stdc-predef.h&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  &#39;/usr/include/stdio.h&#39;
</span></span></span></code></pre></div><p>In this example the toolchain tried to load host files, where it should have been loading equivalent files from the toolchain tarball.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-79ca638449e551f530dec422e6c8c022">7.3 - refreshing toolchains</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Refreshing (updating) an existing toolchain is mostly straightforward.</p>

</div>

<blockquote>
<p>Warning: This sequence uses unreleased code for binutils, gcc, and glibc.
We use this experimental toolchain to get a glimpse of future toolchains and products,
not for stable code.</p>
</blockquote>
<h2 id="update-binutils">Update binutils</h2>
<p>binutils&rsquo; latest release is 2.42.  Let&rsquo;s update our RISCV toolchain to use the current binutils head,
which is currently very close to the released version.  The git log shows relatively little change
to the RISCV assembler, other than some corrections to the THead extension encodings.</p>
<ul>
<li>Update the source directory to commit a197d5f7eb27e99c27577, January 18 2024.  RISCV updates to
the previous snapshot have landed from various alibaba contributors.</li>
<li>switch to the binutils build directory and refresh the configuration, build, and install to <code>/opt/riscvx</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> /home2/vendor/binutils-gdb/configure --prefix<span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx --target<span style="color:#ce5c00;font-weight:bold">=</span>riscv64-unknown-linux-gnu
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make install
</span></span></code></pre></div><h2 id="update-gcc">Update gcc</h2>
<ul>
<li>Update to the tip of the master branch, glancing at the log to see that alibaba, intel, rivai,
rivos, and others have contributed recent RISCV updates.</li>
<li>switch to the existing build directory, clean the old configuration, and repeat the configuration
used before.</li>
<li>make and install to <code>/opt/riscvx</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> make distclean
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> /home2/vendor/gcc/configure --prefix<span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx --enable-languages<span style="color:#ce5c00;font-weight:bold">=</span>c,c++,lto --disable-multilib --target<span style="color:#ce5c00;font-weight:bold">=</span>riscv64-unknown-linux-gnu --with-sysroot<span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx/sysroot
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make install
</span></span></code></pre></div><h2 id="update-glibc">update glibc</h2>
<p>Update the source directory to the tip of the master branch, refresh the configuration, build,
and install</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> ../../vendor/glibc/configure <span style="color:#000">CC</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx/bin/riscv64-unknown-linux-gnu-gcc  --host<span style="color:#ce5c00;font-weight:bold">=</span>riscv64-unknown-linux-gnu --target<span style="color:#ce5c00;font-weight:bold">=</span>riscv64-unknown-linux-gnu --prefix<span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx --disable-werror --enable-shared --disable-multilib
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make install
</span></span></code></pre></div><h2 id="testing-the-refreshed-toolchain">testing the refreshed toolchain</h2>
<p>The previous steps generate a new, non-portable toolchain under <code>/opt/riscvx</code>.  Before we can generate the portable tarball
(e.g., <code>risc64_linux_gcc-14.0.1.tar.xz</code>) we can exercise the newer toolchain.  If we pass <code>--platforms=//platforms:riscv_local</code>
to bazel it will use a toolchain loaded from local files under <code>/opt/riscvx</code> instead of files extracted from the portable tarball.</p>
<p>This is mostly useful in debugging the bazel &lsquo;sandbox&rsquo; - recognizing newer files required by the toolchain that have been installed
locally but not explicitly included in the portable tarball.</p>
<p>For example, suppose we are refreshing the gcc-14 toolchain from <code>14.0.0</code> to <code>14.0.1</code>.  The following sequence of builds should all succeed:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">#</span> build with an unrelated and fully released toolchain as a control experiment
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_userspace @whisper_cpp//:main
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Target @@whisper_cpp//:main up-to-date:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  bazel-bin/external/whisper_cpp/main        /// build was successful
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> strings bazel-bin/external/whisper_cpp/main<span style="color:#000;font-weight:bold">|</span>grep GCC
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GCC_3.0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GCC: (GNU) 13.2.1 20230901                   /// the released compiler only was used
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GCC: (g3f23fa7e74f) 13.2.1 20230901
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">_Unwind_Resume@GCC_3.0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">#</span> repeat with the <span style="color:#204a87">local</span> toolchain introducing 14.0.1 <span style="color:#204a87;font-weight:bold">for</span> the application build
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_local @whisper_cpp//:main
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Target @@whisper_cpp//:main up-to-date:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  bazel-bin/external/whisper_cpp/main       /// build was successful
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> strings bazel-bin/external/whisper_cpp/main<span style="color:#000;font-weight:bold">|</span>grep GCC
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GCC_3.0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GCC: (GNU) 13.2.1 20230901                  /// some system files were previously compiled
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GCC: (GNU) 14.0.1 20240130 (experimental)   /// the new toolchain was used in part
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">_Unwind_Resume@GCC_3.0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">#</span> repeat with the candidate portable tarball
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector @whisper_cpp//:main
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Target @@whisper_cpp//:main up-to-date:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  bazel-bin/external/whisper_cpp/main       /// build was successful
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> strings bazel-bin/external/whisper_cpp/main<span style="color:#000;font-weight:bold">|</span>grep GCC
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GCC_3.0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GCC: (GNU) 13.2.1 20230901
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GCC: (GNU) 14.0.1 20240130 (experimental)   /// the new toolchain was used in part
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">_Unwind_Resume@GCC_3.0
</span></span></span></code></pre></div><p>Different build options can require different files in the portable tarball, so this kind of test may
fail for some projects while succeeding in others.  That&rsquo;s easily fixed by updating the <code>generate.sh</code> <code>rsync</code> script
that builds the portable tarball.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-99bc04328a000750d727f1aa33ff141a">8 - Notes</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Put unstructured comments here until we know what to do with them.</p>

</div>

<h2 id="todo">TODO</h2>
<ul>
<li><input disabled="" type="checkbox"> Update the <code>isa_ext</code> Ghidra branch to expand <code>vsetvli</code> arguments
<ul>
<li><code>vsetvli zero,zero,0xc5</code> ⇒ <code>vsetvli	zero,zero,e8,mf8,ta,ma</code></li>
<li><code>vsetvli zero,zero,0x18</code> ⇒ <code>vsetvli	zero,zero,e64,m1,tu,mu</code></li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> Determine why the <code>isa_ext</code> Ghidra branch fails to disassemble the <code>bext</code> instruction in <code>b-ext-64.o</code> and <code>b-ext.o</code>
<ul>
<li>that regression was do to an accidental typo</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> Determine why <code>zvbc.o</code> won&rsquo;t disassemble
<ul>
<li>These are compressed (16 bit) vector multiply instructions not currently defined in <code>isa_ext</code></li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> Determine why <code>unknown.o</code> won&rsquo;t disassemble or reference where we found these instructions
<ul>
<li>These instructions include <code>sfence``, </code>hinval_vvma<code>, </code>hinval_gvma<code>, </code>orc.b<code>, </code>cbo.clean<code>, </code>cbo.inval<code>, </code>cbo.flush<code>. </code>orc.b` is handled properly, the others are not implemented.</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> Clarify python scripts to show more of the directory context</li>
</ul>
<h2 id="experiments">Experiments</h2>
<h3 id="how-much-ghidra-complexity-does-gcc-14-introduce-in-a-full-build">how much Ghidra complexity does gcc-14 introduce in a full build?</h3>
<p>Assume a vendor generates a new toolchain with multiple extensions enabled by default.  What fraction of the compiled functions would
contain extensions unrecognized by Ghidra 11.0?  Since THead has supplied most of the vendor-specific extensions known to binutils 2-41,
we&rsquo;ll use that as a reference.  The architecture name will be something like</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>-march=rv64gv_zba_zbb_zbc_zbkb_zbkc_zbkx_zvbc_xtheadba_xtheadbb_xtheadbs_xtheadcmo_xtheadcondmov_xtheadmac_xtheadfmemidx_xtheadmempair_xtheadsync
</span></span></code></pre></div><p>Add some C++ code to exercise libstdc++ ordered maps (based on red-black trees?), unordered maps (hash table based), and the Murmur hash function.</p>
<p>There are a few places where THead customized instructions are used.  The Murmur hash function uses vector load and store instructions to implement 8 byte unaligned
reads.  Bit manipulation extension instructions are not yet used.</p>
<p>Initial results suggest the largest complexity impact will be gcc rewriting of memory and structure copies with vector code.  This may be
especially true for hardware requiring aligned integers where alignment can not be guaranteed.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-219885af892566c9bd30c77d9270a0dc">8.1 - Hardware Availability</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>When will RISCV-64 cores be deployed into systems needing reverse-engineering?</p>

</div>

<h2 id="general-purpose-systems">General purpose systems</h2>
<p><a href="https://www.cnx-software.com/2022/11/02/sifive-p670-and-p470-risc-v-processors-add-risc-v-vector-extensions/">https://www.cnx-software.com/2022/11/02/sifive-p670-and-p470-risc-v-processors-add-risc-v-vector-extensions/</a></p>
<p><a href="https://www.cnx-software.com/2023/08/30/sifive-unveils-p870-high-performance-core-discusses-future-of-risc-v">https://www.cnx-software.com/2023/08/30/sifive-unveils-p870-high-performance-core-discusses-future-of-risc-v</a></p>
<p><a href="https://github.com/riscv/riscv-profiles/blob/main/rva23-profile.adoc">https://github.com/riscv/riscv-profiles/blob/main/rva23-profile.adoc</a></p>
<p><a href="https://www.scmp.com/tech/tech-trends/article/3232686/chinas-top-chip-designers-form-risc-v-patent-alliance-promote-semiconductor-self-sufficiency">https://www.scmp.com/tech/tech-trends/article/3232686/chinas-top-chip-designers-form-risc-v-patent-alliance-promote-semiconductor-self-sufficiency</a></p>
<blockquote>
<p>Note: the general SiFive SDK boards might have been deprioritized in favor of specific licensing agreements.
<a href="https://www.sifive.com/boards/hifive-pro-p550">https://www.sifive.com/boards/hifive-pro-p550</a></p>
</blockquote>
<p><a href="https://liliputing.com/sifive-hifive-pro-p550-dev-board-coming-this-summer-with-intel-horse-creek-risc-v-chip/">https://liliputing.com/sifive-hifive-pro-p550-dev-board-coming-this-summer-with-intel-horse-creek-risc-v-chip/</a></p>
<p>We might expect to see high performance network appliances in 2026 using chip architectures like the SiFive 670 or 870,
or from one of the alternative Chinese vendors.  Chips with vector extensions are due soon, with crypto extensions coming shortly after.
A network appliance development board might have two P670 class sockets and four to eight 10 GbE network interfaces.</p>
<p>To manage scope, we won&rsquo;t be worrying about instructions supporting AI or complex virtualization.  Custom instructions that might be used
in network appliances are definitely in scope, while custom instructions for nested virtualization are not.  Possibly in scope are new instructions
that help manage or synchronize multi-socket cache memory.</p>
<p>Let&rsquo;s set a provocative long term goal: How will Ghidra analyze a future network appliance that combines Machine Learning with self-modifying code
to accelerate network routing and forwarding?  Such a device might generate fast-path code sequences to sessionize incoming packets and deliver them with
minimal cache flushes or branches taken.</p>
<p>A RISCV-64 implementation of the Marvell Octeon 10 might be a feasible future hardware component.</p>
<h2 id="portable-appliances">Portable appliances</h2>
<p>This might include cell phones or voice-recognition apps.  Things that today might use an Arm core set but be implemented with RISC-V cores in the future.</p>
<h2 id="role-of-mixed-32-and-64-bit-cores">role of mixed 32 and 64 bit cores</h2>
<p>Consider a midpoint network appliance (router or firewall) sitting near the Provider-Customer demarcation.  What might be an appealing RISCV processor look like?
This kind of appliance likely handles a mix of link layer protocols with an optimization for low energy dissipation and low latency per packet.  A fast and simple
serializer/deserializer feeding a RISCV classifier and forwarding engine makes sense here.  You don&rsquo;t want to do network or application layer processing unless the appliance
has a firewall role.</p>
<p>Link layer processing means a packet mix of stacked MPLS and VLAN tags with IPv4 and IPv6 network layers underneath.  Packet header processing won&rsquo;t need 32 bit addressing,
but might benefit from the high memory bandwidth of a 64 bit core.  Fast header hashing combined with fast hashmap session lookups (for MPLS, VLAN, and selected IP) or
fast trie session lookups (for IPv4 and IPv6).  Network stacks can have a lot of branches, creating pipeline stalls, so hyperthreading may make sense.</p>
<p>Denial of Service and overload protections make fast analytics necessary at the session level.  That&rsquo;s where a 64 bit core with vector and other extensions can be useful.</p>
<p>This all suggests we might see more hybrid RISCV designs, with a mix of many lean 32 bit cores supported by one or two 64 bit cores.  The 32 bit cores handle fast link layer processing
and the 64 bit cores handle background analytics and control.</p>
<p>In the extreme case, the 64 bit analytics engine rewrites link layer code for the 32 bit cores continuously, optimizing code paths depending on what the link layer classifiers
determine the most common packet types to be for each physical port.  Cache management and branch prediction hints might drive new instruction additions.</p>
<p>Code rewriting could start as simple updates to RISCV hint branch instructions and possibly prefetch instructions, so it isn&rsquo;t necessarily as radical as it sounds.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-11f98830a63a9bc25c2bc8239212c99f">8.2 - Network Appliances</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>What will RISCV-64 cores offer networking?</p>

</div>

<h2 id="will-vector-instructions-be-useful-in-network-appliances">will vector instructions be useful in network appliances?</h2>
<p>Network kernel code has lots of conditional branches and very few loops.  This suggests RISCV vector instructions won&rsquo;t be
found in network appliances anytime soon, other than <code>memmove</code> or similar simple contexts.  Gather-scatter, bit manipulation, and
crypto instruction extensions are likely to be useful in networking much sooner.  Ghidra will have a much easier time generating
pcode for those instructions than the 25K+ RISCV vector intrinsic C functions covering all combinations of vector instructions and
vector processing modes.</p>
<p>What should Ghidra do when faced with a counter-example, say a network appliance that aggressively moves vector analytics into network processing?
Such an appliance - perhaps a smart edge router or a zero-trust gateway device - might combine the following:</p>
<ul>
<li>64 RISCV cores with no floating point or vector capability, optimized for traditional network ingress processing.  These cores are
designed to cope with the many branches of network packet processing, possibly including better branch prediction and hyperthreading.</li>
<li>2 or more RISCV cores with full floating point and vector capability, optimized for performing analytics on the inbound packet stream.
These analytics can range from simple statistics generation to heuristic sessionization to self-modifying code generation.
The self-modifying code may be either eBPF code or native RISCV instructions, depending on how aggressive the designers may be.</li>
</ul>
<p>In the extreme case, this might be a generative AI subsystem trained on inbound packets and emitting either optimized packet handling code or
threat-detection indicators.  How would a Ghidra analyst look for malware in such a system?</p>
<h3 id="midpoint-versus-endpoint-network-appliances">midpoint versus endpoint network appliances</h3>
<p>We need to be clearer about what kind of network code we might find in different contexts:</p>
<ul>
<li>midpoint equipment like network-edge routers and switches, optimized for maximum throughput</li>
<li>endpoint equipment like host computers, web servers, and database servers where applications take up the bulk of the CPU cycles</li>
</ul>
<p>For each of these contexts we have at least two topology variants:</p>
<ul>
<li>Inline network code through which packets must transit, generally optimized for low latency and high throughput</li>
<li>Tapped network code (e.g., wireshark or port-mirrored accesses) observing copies of packets for session and endpoint analytics.
Latency is not an issue here.</li>
</ul>
<p>Midpoint network appliances may need to track session state.  A simple network switch is close to stateless.  A real-world network switch
has a lot of session state to manage if it supports:</p>
<ul>
<li>denial of service overload detection or other flow control</li>
<li>link bonding or equal-weight multipath routing</li>
</ul>
<p>The key point here is that midpoint network appliances may benefit from instruction set extensions that enable faster packet classification, hashing, and cached session lookup.
An adaptive midpoint network appliance might adjust the packet classification code in real-time, based on the mix of MPLS, VLAN, IPv4, IPv6, and VPN traffic most often seen on
any given network interface.  ISA extensions supporting gather, hash, vector comparison, and find-first operations are good candidates here.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6b7b30f5489c07a9a0381508ed048f39">8.3 - A vectorization case study</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Compare and debug human and gcc vectorization</p>

</div>

<p>This case study compares human and compiler vectorization of a simple ML quantization algorithm.  We&rsquo;ll assume we need to inspect the code to understand why these two
binaries sometimes produce different results.  Our primary goal is to see whether we can improve Ghidra&rsquo;s RISCV pcode generation to make such analyses easier.  A  secondary
goal is to collect generated instruction patterns that may help Ghidra users understand what optimizing vectorizing compilers can do to source code.</p>
<p>The ML algorithm under test comes from <a href="https://github.com/ggerganov/llama.cpp">https://github.com/ggerganov/llama.cpp</a>.  It packs an array of 32 bit floats into a set of q8_0 blocks to condense large
model files.  The q8_0 quantization reduces 32 32 bit floating point numbers to 32 8 bit integers with an associated 16 bit floating point scale factor.</p>
<p>The <code>ggml-quants.c</code> file in the <code>llama.cpp</code> repo provides both scalar source code (<code>quantize_row_q8_0_reference</code>) and hand-generated vectorized source code (<code>quantize_row_q8_0</code>).</p>
<ul>
<li>The <code>quantize_row_q8_0</code> function has several <code>#ifdef</code> sections providing hand-generated vector intrinsics for riscv, avx2, arm/neon, and wasm.</li>
<li>The <code>quantize_row_q8_0_reference</code> function source uses more loops but no vector instructions.  GCC-14 will autovectorize the scalar <code>quantize_row_q8_0_reference</code>,
producing vector code that is quite different from the hand-generated vector intrinsics.</li>
</ul>
<p>The notional AI development shop wants to use Ghidra to inspect generated assembly instructions for both <code>quantize_row_q8_0</code> and <code>quantize_row_q8_0_reference</code> to track down
reported quirks.  On some systems they produce identical results, on others the results differ.  The test framework includes:</p>
<ul>
<li>A target RISCV-64 processor supporting vector and compressed instructions.</li>
<li>GCC-14 developmental (pending release) compiler toolchain for native x86_64 builds</li>
<li>GCC-14 developmental (pending release) RISCV-64 cross-compiler toolchain with standard options <code>-march=rv64gcv</code>, <code>-O3</code>, and <code>-ffast-math</code>.</li>
<li><code>qemu-riscv64-static</code> emulated execution of user space RISCV-64 applications on an x86_64 Linux test server.</li>
<li>A generic unit testing framework like <code>gtest</code>.</li>
<li>Ghidra 11+ with the <code>isa_ext</code> branch supporting  RISCV 1.0 vector instructions.</li>
</ul>
<p>The unit test process involves three unit test executions:</p>
<ul>
<li>a reference x86_64 execution to test the logic on a common platform.</li>
<li>within a <code>qemu-riscv64-static</code> environment with an emulated VLEN=256 bits</li>
<li>within a <code>qemu-riscv64-static</code> environment with an emulated VLEN=128 bits</li>
</ul>
<blockquote>
<p>Note: This exercise uses whisper C and C++ source code as &lsquo;ground truth&rsquo;, coupled with a C++ test framework.
If we didn&rsquo;t have source code, we would have to reconstruct key library source files based
on Ghidra inspection, then refine those reconstructions until Ghidra and unit testing shows that our
reconstructions behave the same as the original binaries.</p>
</blockquote>
<p>As setup to the Ghidra inspection, we will build and run all three and expect
to see three PASSED notifications:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel run -platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:x86_64 case_studies:unitTests
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">INFO: Analyzed target //case_studies:unitTests (0 packages loaded, 0 targets configured).
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Found 1 target...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Target //case_studies:unitTests up-to-date:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  bazel-bin/case_studies/unitTests
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Elapsed time: 21.065s, Critical Path: 20.71s
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: 37 processes: 2 internal, 35 linux-sandbox.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Build completed successfully, 37 total actions
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Running command line: bazel-bin/case_studies/unitTests
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] Running 2 tests from 1 test suite.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] Global test environment set-up.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32Reference
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32Reference (0 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32VectorIntrinsics
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32VectorIntrinsics (0 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16 (0 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">[----------] Global test environment tear-down
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] 2 tests from 1 test suite ran. (0 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  PASSED  ] 2 tests.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> bazel build --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector case_studies:unitTests
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector --define <span style="color:#000">__riscv_v_intrinsics</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span> case_studies:unitTests
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">WARNING: Build option --platforms has changed, discarding analysis cache (this can be expensive, see https://bazel.build/advanced/performance/iteration-speed).
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Analyzed target //case_studies:unitTests (0 packages loaded, 1904 targets configured).
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Found 1 target...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Target //case_studies:unitTests up-to-date:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  bazel-bin/case_studies/unitTests
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Elapsed time: 22.265s, Critical Path: 22.07s
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: 37 processes: 2 internal, 35 linux-sandbox.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Build completed successfully, 37 total actions
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> <span style="color:#204a87">export</span> <span style="color:#000">QEMU_CPU</span><span style="color:#ce5c00;font-weight:bold">=</span>rv64,zba<span style="color:#ce5c00;font-weight:bold">=</span>true,zbb<span style="color:#ce5c00;font-weight:bold">=</span>true,v<span style="color:#ce5c00;font-weight:bold">=</span>true,vlen<span style="color:#ce5c00;font-weight:bold">=</span>256,vext_spec<span style="color:#ce5c00;font-weight:bold">=</span>v1.0,rvv_ta_all_1s<span style="color:#ce5c00;font-weight:bold">=</span>true,rvv_ma_all_1s<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> qemu-riscv64-static -L /opt/riscvx -E <span style="color:#000">LD_LIBRARY_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx/riscv64-unknown-linux-gnu/lib/ bazel-bin/case_studies/unitTests
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] Running 2 tests from 1 test suite.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] Global test environment set-up.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32Reference
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32Reference (1 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32VectorIntrinsics
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32VectorIntrinsics (0 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16 (2 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">[----------] Global test environment tear-down
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] 2 tests from 1 test suite ran. (6 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  PASSED  ] 2 tests.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Target //case_studies:unitTests up-to-date:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  bazel-bin/case_studies/unitTests
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Elapsed time: 8.984s, Critical Path: 8.88s
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: 29 processes: 2 internal, 27 linux-sandbox.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Build completed successfully, 29 total actions
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> <span style="color:#000">QEMU_CPU</span><span style="color:#ce5c00;font-weight:bold">=</span>rv64,zba<span style="color:#ce5c00;font-weight:bold">=</span>true,zbb<span style="color:#ce5c00;font-weight:bold">=</span>true,v<span style="color:#ce5c00;font-weight:bold">=</span>true,vlen<span style="color:#ce5c00;font-weight:bold">=</span>256,vext_spec<span style="color:#ce5c00;font-weight:bold">=</span>v1.0,rvv_ta_all_1s<span style="color:#ce5c00;font-weight:bold">=</span>true,rvv_ma_all_1s<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> qemu-riscv64-static -L /opt/riscvx -E <span style="color:#000">LD_LIBRARY_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx/riscv64-unknown-linux-gnu/lib/ bazel-bin/case_studies/unitTests
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] Running 2 tests from 1 test suite.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] Global test environment set-up.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32Reference
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32Reference (1 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32VectorIntrinsics
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32VectorIntrinsics (0 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16 (2 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">[----------] Global test environment tear-down
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] 2 tests from 1 test suite ran. (6 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  PASSED  ] 2 tests.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> <span style="color:#204a87">export</span> <span style="color:#000">QEMU_CPU</span><span style="color:#ce5c00;font-weight:bold">=</span>rv64,zba<span style="color:#ce5c00;font-weight:bold">=</span>true,zbb<span style="color:#ce5c00;font-weight:bold">=</span>true,v<span style="color:#ce5c00;font-weight:bold">=</span>true,vlen<span style="color:#ce5c00;font-weight:bold">=</span>128,vext_spec<span style="color:#ce5c00;font-weight:bold">=</span>v1.0,rvv_ta_all_1s<span style="color:#ce5c00;font-weight:bold">=</span>true,rvv_ma_all_1s<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> qemu-riscv64-static -L /opt/riscvx -E <span style="color:#000">LD_LIBRARY_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx/riscv64-unknown-linux-gnu/lib/ bazel-bin/case_studies/unitTests
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] Running 2 tests from 1 test suite.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] Global test environment set-up.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32Reference
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32Reference (1 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32VectorIntrinsics
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">case_studies/unitTests.cpp:55: Failure
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Expected equality of these values:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  dest[0].d
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    Which is: 12175
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  fp16_test_array.d
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    Which is: 13264
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">fp16 scale factor is correct
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">case_studies/unitTests.cpp:57: Failure
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Expected equality of these values:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  comparison
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    Which is: -65
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">entire fp16 block is converted correctly
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  FAILED  ] FP16.convertFromFp32VectorIntrinsics (8 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16 (10 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">[----------] Global test environment tear-down
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] 2 tests from 1 test suite ran. (14 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  PASSED  ] 1 test.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  FAILED  ] 1 test, listed below:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  FAILED  ] FP16.convertFromFp32VectorIntrinsics
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic"> 1 FAILED TEST
</span></span></span></code></pre></div><p>These results imply:</p>
<ul>
<li>The hand-vectorized <code>quantize_row_q8_0</code> test passes on harts with VLEN=256 but fails when
executed on harts with VLEN=128.  Further tracing suggests that <code>quantize_row_q8_0</code> only processes the
first 16 floats, not the 32 floats that should be processed in each block.</li>
<li>The gcc autovectorized <code>quantize_row_q8_0_reference</code> passes on both types of harts.</li>
</ul>
<p>Now we need to import the riscv-64 <code>unitTests</code> program into Ghidra and examine the compiled differences between
<code>quantize_row_q8_0</code> and <code>quantize_row_q8_0_reference</code>.</p>
<blockquote>
<p>Note: Remember that our real integration test goal is to look for new problems or regressions in Ghidra&rsquo;s
decompiler presentation of functions like these, and then to look for ways to improve that presentation.</p>
</blockquote>
<h2 id="original-source-code">Original Source Code</h2>
<p>The goal of both <code>quantize_row_q8_0*</code> routines is a lossy compression of 32 bit floats into blocks of 8 bit scaled values.
The routines should return identical results, with <code>quantize_row_q8_0</code> invoked on architectures with vector acceleration
and <code>quantize_row_q8_0_reference</code> for all other architectures.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">QK8_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// reference implementation for deterministic creation of model files
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">quantize_row_q8_0_reference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">QK8_0</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nb</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">amax</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0f</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// absolute max
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">QK8_0</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">amax</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MAX</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">amax</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fabsf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">amax</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#0000cf;font-weight:bold">1.0f</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f57900">d</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.0f</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">GGML_FP32_TO_FP16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">x0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">QK8_0</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">roundf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">quantize_row_q8_0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">QK8_0</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">QK8_0</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#if defined(__ARM_NEON)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#elif defined(__wasm_simd128__)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#elif defined(__AVX2__) || defined(__AVX__)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#elif defined(__riscv_v_intrinsic)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">vl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsetvl_e32m4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nb</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// load elements
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vfloat32m4_t</span> <span style="color:#000">v_x</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vle32_v_f32m4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vfloat32m4_t</span> <span style="color:#000">vfabs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfabs_v_f32m4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v_x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vfloat32m1_t</span> <span style="color:#000">tmp</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfmv_v_f_f32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0.0f</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vfloat32m1_t</span> <span style="color:#000">vmax</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfredmax_vs_f32m4_f32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vfabs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">amax</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfmv_f_s_f32m1_f32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vmax</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">amax</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#0000cf;font-weight:bold">1.0f</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f57900">d</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.0f</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">GGML_FP32_TO_FP16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vfloat32m4_t</span> <span style="color:#000">x0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfmul_vf_f32m4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v_x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// convert to integer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vint16m2_t</span>   <span style="color:#000">vi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfncvt_x_f_w_i16m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8m1_t</span>    <span style="color:#000">vs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vncvt_x_x_w_i8m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vi</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// store result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">__riscv_vse8_v_i8m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span> <span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">GGML_UNUSED</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// scalar
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">quantize_row_q8_0_reference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The reference version has an outer loop iterating over scalar 32 bit floats, with two inner loops operating on blocks of 32
of those floats.  The first inner loop accumulates the maximum of absolute values within the block to generate a scale factor,
while the second inner loop applies that scale factor to each 32 bit float in the block and then converts the scaled value to an 8 bit integer.
Each output block is then a 16 bit floating point scale factor plus 32 8 bit scaled integers.</p>
<p>The code includes some distractions that complicate Ghidra analysis:</p>
<ul>
<li>The k input parameter is signed, making the integer division by 32 more complicated than it needs to be.</li>
<li>The <code>GGML_FP32_TO_FP16(d)</code> conversion might be a single instruction on some architectures, but it requires branch evaluation
on our RISCV-64 target architecture.  GCC may elect to duplicate code in order to minimize the number of branches needed.</li>
</ul>
<p>The hand-optimized <code>quantize_row_q8_0</code> has similar distractions, plus a few more:</p>
<ul>
<li>The two inner loops have been converted into RISCV vector intrinsics, such that each iteration processes 32 4 byte floats into
a single 34 byte <code>block_q8_0</code> struct.</li>
<li>Four adjacent vector registers are grouped with the <code>m4</code> setting.  On architectures with a vector length VLEN=256, that means
all 32 4 byte floats per block will fit nicely and can be processed in parallel.  If the architecture only supports a vector length of
VLEN=128, then only half of each block will be processed in every iteration.  That accounts for the unit test failure.</li>
<li>The code uses standard riscv_intrinsics - of which there are nearly 40,000 variants.  The root of each intrinsic is generally a
single vector instruction, then extended with information on the expected vector context (from vset* instructions) and the expected
return type of the result.  There is no C header file providing signatures for all possible variants, so nothing Ghidra can import
and use in the decompiler view.</li>
<li>The <code>__riscv_vle32_v_f32m4</code> intrinsic is likely the slowest of the set, as this 32 bit instruction will require a 128 byte memory read,
stalling the instruction pipeline for some number of cycles.</li>
</ul>
<h2 id="ghidra-inspection">Ghidra inspection</h2>
<h3 id="inspecting-the-hand-vectorized-quantizer">inspecting the hand-vectorized quantizer</h3>
<p>Load <code>unitTest</code> into Ghidra and inspect <code>quantize_row_q8_0</code>.  We know the correct signature so we can override what Ghidra has inferred,
then name the parameters so that they look more like the source code.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">quantize_row_q8_0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">block_q0_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">fVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pcVar3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint</span> <span style="color:#000">uVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iVar6</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ulong</span> <span style="color:#000">uVar7</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar8</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar9</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar10</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsetvli_e8m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x106c50</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">iVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(((</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1f</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span><span style="color:#000;font-weight:bold">(</span> <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli_e32m4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfredmax_vs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmv_fs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">fVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar8</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">0.007874016</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">fVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">fVar1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#0000cf;font-weight:bold">127.0</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar8</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0xff000001</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">uVar7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli_e16m2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">((</span><span style="color:#000">block_q0_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x7e00</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfncvt_xfw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli_e8m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x22</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iVar2</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">iVar6</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">uVar7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16m2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfncvt_xfw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xfff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">((</span><span style="color:#000">block_q0_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">short</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x22</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">iVar2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p>Note: an earlier run showed several pcode errors in <code>riscv-rvv.sinc</code>, which have been fixed as of this run.</p>
</blockquote>
<p>Red herrings - none of these have anything to do with RISCV or vector intrinsics</p>
<ul>
<li><code>uVar5 = 0x106c50;</code> - there is no uVar5 variable, just a shared upper immediate load register.</li>
<li><code>iVar2 = (int)(((uint)((int)k &gt;&gt; 0x1f) &gt;&gt; 0x1b) + (int)k) &gt;&gt; 5;</code> - since k is a signed long and not unsigned, the compiler
has to implement the divide by 32 with rounding adjustments for negative numbers.\</li>
<li><code>fVar1 = (float)uVar8 * 0.007874016;</code> - the compiler changed a division by 127.0 into a multiplication by 0.007874016.</li>
<li><code>((block_q0_0 *)(pcVar3 + -2))-&gt;d</code> - the compiler has set pcVar3 to point to an element within the block, so it uses negative
offsets to address preceding elements.</li>
<li>duplicate code blocks - the conversion from a 32 bit float to the 16 bit float involves some branches.  The compiler has decided
that duplicating following code for at least one branch will be faster.</li>
<li>Decompiler handling of <code>fmv.x.w</code> instructions looks odd. fmv.x.w moves the single-precision value in ﬂoating-point register rs1
represented in IEEE 754-2008 encoding to the lower 32 bits of integer register rd.  This works fine when the source
is zero, but it has no clear C-like representation otherwise.  These may better be replaced with specialized pcode operations.</li>
</ul>
<p>There is one discrepancy that does involve the vectorization code.  The source code uses a standard RISCV vector intrinsic function
to store data:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">__riscv_vse8_v_i8m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Ghidra pcode for this instruction after renaming operands is (currently):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>The order of the first two parameters is swapped.  We should probably align the pcode to avoid deviations from the
standard intrinsic signature as much as possible.  Those intrinsics have context and type information encoded into their
name, which Ghidra does not currently have, so we can&rsquo;t exactly match.</p>
<h3 id="inspecting-the-auto-vectorized-quantizer">inspecting the auto-vectorized quantizer</h3>
<p>Load <code>unitTest</code> into Ghidra and inspect <code>quantize_row_q8_0_reference</code>.  We know the correct signature so we can override what
Ghidra has inferred, then name the parameters so that they look more like the source code.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">quantize_row_q8_0_reference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">block_q0_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">fVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pcVar4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ushort</span> <span style="color:#000">uVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iVar6</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ulong</span> <span style="color:#000">uVar7</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar8</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar9</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar10</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar11</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar12</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar13</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar14</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v7</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar15</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar16</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar17</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar18</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar19</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar15</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmv_sf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xff800000</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar13</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">in_v7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar12</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x30</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x40</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar18</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x50</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar16</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar16</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar16</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar18</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar18</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar16</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar17</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x60</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar16</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x70</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar19</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar17</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar17</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar19</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar19</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar16</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar16</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar19</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfredmax_vs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar15</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">uVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmv_fs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar8</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">0.007874016</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">uVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">fVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fVar1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">LAB_00076992</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">ushort</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xfff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">ushort</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0xd</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x7c00</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#0000cf;font-weight:bold">127.0</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x7e00</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0xff000001</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">LAB_00076992</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmv_vf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar13</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar13</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar12</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar12</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">((</span><span style="color:#000">block_q0_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ushort</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x8000</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">uVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar13</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar12</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar18</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0xc</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar17</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x14</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x18</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar16</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x1c</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x80</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x22</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(((</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1f</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">iVar6</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span><span style="color:#000;font-weight:bold">(</span> <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Some of the previous red herrings show up here too.  Things to note:</p>
<ul>
<li><code>undefined auVar19 [256];</code> - something in <code>riscv-rvv.sinc</code> is claiming vector registers are 256 bits long - that&rsquo;s not generally
true, so hunt down the confusion.
<ul>
<li><code>riscv.reg.sinc</code> is the root of this, with <code>@define VLEN &quot;256&quot;</code> and <code>define register offset=0x4000 size=$(VLEN) [ v0  ...]</code>.
What should Ghidra believe the size of vector registers to be?  More generally, should the size and element type of vector
registers be mutable?</li>
</ul>
</li>
<li>the autovectorizer has correctly decided VLEN=128 architectures must be supported, and has dedicated 8 vector registers to
hold all 32 floats required per loop iteration.  Unlike the hand-optimized solution, the 8 vector registers are handled
by 8 interleaved sequences of vector instructions.  This roughly doubles the instruction count, but provides good distribution
of load and store memory operations across the loop, likely minimizing execution stalls.</li>
</ul>
<p>RISCV vector instruction execution engines - and autovectorization passes in gcc - are both so immature we have no idea of which
implementation performs better.  At best we can guess that autovectorization will be good enough to make hand optimized coding
with riscv intrinsic functions rarely needed.</p>
<h2 id="vectorized-function-analysis-without-source-code">Vectorized function analysis without source code</h2>
<p>Now try using Ghidra to inspect a function that dominates execution time in the whisper.cpp demo - <code>ggml_vec_dot_16</code>.  We&rsquo;ll do this
without first checking the source code.  We&rsquo;ll make a few reasonable assumptions:</p>
<ul>
<li>this is likely a vector dot product</li>
<li>the vector elements are 16 bit floating point values of the type we&rsquo;ve seen already.</li>
</ul>
<p>A quick inspection lets us rewrite the function signature as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">ggml_vec_dot_f16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sum</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">fp16</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">fp16</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{...}</span>
</span></span></code></pre></div><p>That quick inspection also shows a glaring error - the pcode semantics for <code>vluxei64.v</code> has left out a critical parameter.  It&rsquo;s present in the
listing view but missing in the pcode semantics view.  Fix this and move on.</p>
<p>After tinkering with variable names and signatures, we get:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">ggml_vec_dot_q8_0_q8_0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sum</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pbVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">px_qs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">py_qs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">partial_sum</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar5</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar6</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v5</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">partial_sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsetvli_e8m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x1f</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">px_qs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">py_qs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v5</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">pbVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">px_qs</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli_e8m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">px_qs</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">py_qs</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vwmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli_e16m2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vwredsum_vs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar5</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">in_v5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetivli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vmv_x_s</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">iVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iVar2</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">px_qs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">px_qs</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x22</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">partial_sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar3</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ggml_table_f32_f16</span><span style="color:#000;font-weight:bold">)[((</span><span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">py_qs</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">field0_0x0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ggml_table_f32_f16</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#000">pbVar1</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">field0_0x0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">partial_sum</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">py_qs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">py_qs</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x22</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iVar2</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(((</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1f</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">partial_sum</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>That&rsquo;s fairly clear - the two vectors are presented as arrays of <code>block_q8_0</code> structs, each with
32 entries and a scale factor <code>d</code>.  An earlier run showed another error, now fixed, with the pcode for
<code>vmv_x_s</code>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3a91620b69f843cc0ecd1d5560adadf5">8.4 - Pcode testing</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Ghidra testing of semantic pcode.</p>

</div>

<blockquote>
<p>Note: paths and names are likely to change here.  Use these notes just as a guide.</p>
</blockquote>
<p>The Ghidra 11 <code>isa_ext</code> branch makes heavy use of user-defined pcode (aka Sleigh semantics).  Much of that pcode is arbitrarily defined, adding more confusion to an
already complex field.  Can we build a testing framework to highlight problem areas in pcode semantics?</p>
<p>For example, let&rsquo;s look at Ghidra&rsquo;s decompiler rendering of two RISCV-64 vector instructions <code>vmv.s.x</code> and <code>vmv.x.s</code>.  These instructions move a single element between an
integer scalar register and the first element of a vector register.  The <a href="https://github.com/riscv/riscv-v-spec/blob/master/v-spec.adoc">RISCV</a>
vector definition says:</p>
<ul>
<li>The vmv.x.s instruction copies a single SEW-wide element from index 0 of the source vector register to a destination integer register.</li>
<li>The vmv.s.x instruction copies the scalar integer register to element 0 of the destination vector register.</li>
</ul>
<p>These instructions have a lot of symmetry, but the current isa_ext branch doesn&rsquo;t render them symmetrically.  Let&rsquo;s build a sample function
that uses both instructions followed by an assertion of what we expect to see.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">test_integer_scalar_vector_move</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">///@ exercise integer scalar moves into and out of a vector register
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// set vector mode to something simple
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__asm__</span> <span style="color:#000">__volatile__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;vsetivli zero,1,e32,m1,ta,ma</span><span style="color:#4e9a06">\n\t</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// execute both instructions to set y:= x
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__asm__</span> <span style="color:#000">__volatile__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;vmv.s.x  v1, %1</span><span style="color:#4e9a06">\n\t</span><span style="color:#4e9a06">&#34;</span> <span style="color:#4e9a06">&#34;vmv.x.s  %0, v1&#34;</span>\
</span></span><span style="display:flex;"><span>                          <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;=r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> \
</span></span><span style="display:flex;"><span>                          <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This function should return the boolean value True.  It&rsquo;s defined in the file <code>failing_tests/pcodeSamples.cpp</code> and
compiled into the library <code>libsamples.so</code>.  The function is executed within the test harness <code>failing_tests/pcodeTests.cpp</code>.</p>
<p>Build (with O3 optimization) and execute the test harness with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel clean
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Starting clean (this may take a while). Consider using --async if the clean takes more than several minutes.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> bazel build -s -c opt  --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector failing_tests:samples
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> cp -f bazel-bin/failing_tests/libsamples.so /tmp
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build -s -c opt  --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector failing_tests:pcodeTests
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> <span style="color:#204a87">export</span> <span style="color:#000">QEMU_CPU</span><span style="color:#ce5c00;font-weight:bold">=</span>rv64,zba<span style="color:#ce5c00;font-weight:bold">=</span>true,zbb<span style="color:#ce5c00;font-weight:bold">=</span>true,v<span style="color:#ce5c00;font-weight:bold">=</span>true,vlen<span style="color:#ce5c00;font-weight:bold">=</span>128,vext_spec<span style="color:#ce5c00;font-weight:bold">=</span>v1.0,rvv_ta_all_1s<span style="color:#ce5c00;font-weight:bold">=</span>true,rvv_ma_all_1s<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> qemu-riscv64-static -L /opt/riscvx -E <span style="color:#000">LD_LIBRARY_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx/riscv64-unknown-linux-gnu/lib/ bazel-bin/failing_tests/pcodeTests
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] Running 1 test from 1 test suite.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] Global test environment set-up.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 1 test from VectorMove
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] VectorMove.vmv_s_x
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] VectorMove.vmv_s_x (0 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 1 test from VectorMove (0 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">[----------] Global test environment tear-down
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] 1 test from 1 test suite ran. (3 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  PASSED  ] 1 test.
</span></span></span></code></pre></div><p>Now import /tmp/libsamples.so into Ghidra and look for test* functions.  The decompilation is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">test_integer_scalar_vector_move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vmv_s_x</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vmv_x_s</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This shows two issues:</p>
<ul>
<li>Ghidra believes vector v1 is 256 bits long, when in fact it is unknown at compile and link time.  That&rsquo;s
probably OK for now, as it provides a hint that this is a vector register.</li>
<li>The treatment of instruction output is inconsistent.  For <code>vmv_s_x</code>, the output is the first element of <code>in_v1</code>.
For <code>vmv_x_s</code>, the output is the scalar register <code>uVar1</code>.  That <em>might</em> be OK, since we don&rsquo;t specify what
happens to other elements of <code>in_v1</code>.</li>
</ul>
<p>The general question raised by this example is how to treat pcode output - as an output parameter or as
a returned result?  The sleigh pcode documentation suggests that parameters are assumed to be input parameters,
with the only output register the one returned by the pcode operation.  A quick glance at the ARM Neon and AARCH64 SVE
vector sleigh files suggests that this is the convention, but perhaps not a requirement.</p>
<p>Let&rsquo;s try adding some more test cases before taking any action.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6f0fcd5d8c6b80f713f332dab5590581">8.5 - Tracking Convergence</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>We can track external events to plan future integration test effort.</p>

</div>

<p>This project gets more relevant when RISCV-64 processors start appearing in appliances with more instruction set extensions and
with code compiled by newer compiler toolchains.</p>
<p>The project results get easier to integrate if and when more development effort is applied to specific Ghidra components.</p>
<p>This page collects external sites to track for convergence.</p>
<h2 id="toolchains-and-platforms">Toolchains and platforms</h2>
<h3 id="binutils">binutils</h3>
<p>New instruction extensions often appear here as the first public implementation.  Check out the opcodes, aliases, and disassembly
patterns found in the test suite.</p>
<ul>
<li>track the <a href="https://sourceware.org/git/binutils-gdb.git">source</a></li>
<li>inspect <code>git log include/opcode/|grep riscv|head</code></li>
<li>inspect <code>git log gas/testsuite/gas/riscv</code></li>
</ul>
<h4 id="sample-log">sample log</h4>
<ul>
<li>28 Feb 2024 - <a href="mailto:jiawei@iscas.ac.cn">jiawei@iscas.ac.cn</a> added support for Zabha riscv extension (atomic byte and half-word memory ops)</li>
<li>4 Jan 2024 - <a href="mailto:jinma@linux.alibaba.com">jinma@linux.alibaba.com</a> fixed th.vsetvli for T-Head extensions</li>
</ul>
<h3 id="compilers">compilers</h3>
<ul>
<li>track the <a href="git://gcc.gnu.org/git/gcc.git">source</a></li>
<li>inspect <code>git log gcc/testsuite/gcc.target/riscv</code></li>
</ul>
<h4 id="log">log</h4>
<p>Look for commits indicating the stability of vectorization or new compound loop types that now allow auto vectorization.</p>
<h3 id="libraries">libraries</h3>
<ul>
<li>track the <a href="git://sourceware.org/git/glibc.git">source</a></li>
<li>track the <a href="https://github.com/openssl/openssl">source</a></li>
</ul>
<h4 id="log-1">log</h4>
<ul>
<li>glibc
<ul>
<li>Not much specific to RISC-V</li>
</ul>
</li>
<li>openssl (in master, not released as of openssl 3.2)
<ul>
<li><a href="mailto:phoebe.chen@sifive.com">phoebe.chen@sifive.com</a> added vector crypto implementations of AES-CBC mode,  AES-128/192/256-CTR, AES-128/256-XTS</li>
<li><a href="mailto:jerry.shih@sifive.com">jerry.shih@sifive.com</a> added Zvksh support for sm3</li>
</ul>
</li>
</ul>
<h3 id="kernels">kernels</h3>
<ul>
<li>track the <a href="https://github.com/torvalds/linux.git">source</a></li>
<li>inspect <code>git log arch/riscv</code></li>
</ul>
<blockquote>
<p>Note: the Linux kernel just added vector crypto support, derived from the openssl crypto routines.  This <em>appears</em> to mostly
be in support of encrypted file systems.</p>
</blockquote>
<h3 id="system-images">system images</h3>
<ul>
<li>Fedora</li>
<li>Ubuntu</li>
</ul>
<h3 id="cloud-instances">cloud instances</h3>
<ul>
<li><a href="https://www.scaleway.com/en/news/scaleway-launches-its-risc-v-servers-in-the-cloud-a-world-first-and-a-firm-commitment-to-technological-independence/">Scaleway risc-v servers</a>
<ul>
<li>with the T-HEAD TH1520 SoC, 16GB RAM and 128GB</li>
</ul>
</li>
</ul>
<h2 id="isa-extensions">ISA Extensions</h2>
<ul>
<li>profiles and individual standards-tracked extensions</li>
<li>vendor-specific extensions</li>
<li>gcc intrinsics</li>
</ul>
<h2 id="applications">applications</h2>
<ul>
<li>track <a href="https://github.com/ggerganov/whisper.cpp.git">source</a></li>
<li>Look for use of riscv intrinsics with arm/Neon and avx2 equivalents as opposed to allowing compiler autovectorization.</li>
<li>Watch for standardization of 16 bit floating point</li>
</ul>
<h2 id="ghidra">Ghidra</h2>
<h3 id="similar-vector-instruction-suites">similar vector instruction suites</h3>
<p><code>Ghidra/Processors/AARCH64/data/languages/AARCH64sve.sinc</code> defines the instructions used by the AARCH64 Scalable Vector Extensions package.
This suite is similar to the RISCV vector suite in that it is vector register length agnostic.  It was added in March of 2019 and not updated since.</p>
<h3 id="pcode-extensions">pcode extensions</h3>
<p><code>Ghidra/Features/Decompiler/src/decompile/cpp</code> holds much of the existing Ghidra code for system and user defined pcodes.
<code>userop.h</code> and <code>userop.cc</code> look relevant, with <code>caheckman</code> a common contributor.</p>
<h2 id="community">Community</h2>
<ul>
<li><a href="https://riscv.org/">RISCV Organization</a></li>
<li><a href="https://www.reddit.com/r/RISCV/">reddit discussion group</a>
<ul>
<li>new RISCV products are often discussed here.</li>
</ul>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f22421eca6cb396b0451315422c932fa">8.6 - Deep Dive Openssl</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Openssl configuration for ISA Extensions provides a good example.</p>

</div>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">/home2/build_openssl$ ../vendor/openssl/Configure linux64-riscv64 --cross-compile-prefix=/opt/riscvx/bin/riscv64-unknown-linux-gnu- -march=rv64gcv_zkne_zknd_zknh_zvkng_zvksg
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> perl configdata.pm --dump
</span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Command line (with current working directory = .):
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    /usr/bin/perl ../vendor/openssl/Configure linux64-riscv64 --cross-compile-prefix=/opt/riscvx/bin/riscv64-unknown-linux-gnu- -march=rv64gcv_zkne_zknd_zknh_zvkng_zvksg
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Perl information:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    /usr/bin/perl
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    5.38.2 for x86_64-linux-thread-multi
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Enabled features:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    afalgeng
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    apps
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    argon2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    aria
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    asm
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    async
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    atexit
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    autoalginit
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    autoerrinit
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    autoload-config
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    bf
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    blake2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    bulk
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cached-fetch
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    camellia
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    capieng
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cast
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    chacha
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cmac
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cmp
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cms
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    comp
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ct
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    default-thread-pool
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    deprecated
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    des
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dgram
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dh
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    docs
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dsa
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dso
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dtls
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dynamic-engine
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ec
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ec2m
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ecdh
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ecdsa
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ecx
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    engine
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    err
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    filenames
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    gost
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    http
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    idea
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    legacy
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    loadereng
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    makedepend
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    md4
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    mdc2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    module
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    multiblock
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    nextprotoneg
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ocb
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ocsp
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    padlockeng
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    pic
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    pinshared
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    poly1305
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    posix-io
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    psk
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    quic
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    unstable-qlog
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    rc2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    rc4
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    rdrand
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    rfc3779
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    rmd160
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    scrypt
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    secure-memory
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    seed
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    siphash
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    siv
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sm2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sm2-precomp
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sm3
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sm4
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sock
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    srp
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    srtp
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sse2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ssl
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ssl-trace
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    static-engine
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    stdio
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tests
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    thread-pool
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    threads
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ts
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ui-console
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    whirlpool
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1-method
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1_1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1_1-method
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1_2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1_2-method
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1_3
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dtls1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dtls1-method
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dtls1_2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dtls1_2-method
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Disabled features:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    acvp-tests          [cascade]        OPENSSL_NO_ACVP_TESTS
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    asan                [default]        OPENSSL_NO_ASAN
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    brotli              [default]        OPENSSL_NO_BROTLI
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    brotli-dynamic      [default]        OPENSSL_NO_BROTLI_DYNAMIC
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    buildtest-c++       [default]        
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    winstore            [not-windows]    OPENSSL_NO_WINSTORE
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    crypto-mdebug       [default]        OPENSSL_NO_CRYPTO_MDEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    devcryptoeng        [default]        OPENSSL_NO_DEVCRYPTOENG
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ec_nistp_64_gcc_128 [default]        OPENSSL_NO_EC_NISTP_64_GCC_128
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    egd                 [default]        OPENSSL_NO_EGD
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    external-tests      [default]        OPENSSL_NO_EXTERNAL_TESTS
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    fips                [default]        
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    fips-securitychecks [cascade]        OPENSSL_NO_FIPS_SECURITYCHECKS
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    fuzz-afl            [default]        OPENSSL_NO_FUZZ_AFL
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    fuzz-libfuzzer      [default]        OPENSSL_NO_FUZZ_LIBFUZZER
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ktls                [default]        OPENSSL_NO_KTLS
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    md2                 [default]        OPENSSL_NO_MD2 (skip crypto/md2)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    msan                [default]        OPENSSL_NO_MSAN
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    rc5                 [default]        OPENSSL_NO_RC5 (skip crypto/rc5)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sctp                [default]        OPENSSL_NO_SCTP
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tfo                 [default]        OPENSSL_NO_TFO
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    trace               [default]        OPENSSL_NO_TRACE
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ubsan               [default]        OPENSSL_NO_UBSAN
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    unit-test           [default]        OPENSSL_NO_UNIT_TEST
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    uplink              [no uplink_arch] OPENSSL_NO_UPLINK
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    weak-ssl-ciphers    [default]        OPENSSL_NO_WEAK_SSL_CIPHERS
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    zlib                [default]        OPENSSL_NO_ZLIB
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    zlib-dynamic        [default]        OPENSSL_NO_ZLIB_DYNAMIC
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    zstd                [default]        OPENSSL_NO_ZSTD
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    zstd-dynamic        [default]        OPENSSL_NO_ZSTD_DYNAMIC
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ssl3                [default]        OPENSSL_NO_SSL3
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ssl3-method         [default]        OPENSSL_NO_SSL3_METHOD
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Config target attributes:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    AR =&gt; &#34;ar&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ARFLAGS =&gt; &#34;qc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CC =&gt; &#34;gcc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CFLAGS =&gt; &#34;-Wall -O3&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CXX =&gt; &#34;g++&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CXXFLAGS =&gt; &#34;-Wall -O3&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    HASHBANGPERL =&gt; &#34;/usr/bin/env perl&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RANLIB =&gt; &#34;ranlib&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RC =&gt; &#34;windres&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    asm_arch =&gt; &#34;riscv64&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    bn_ops =&gt; &#34;SIXTY_FOUR_BIT_LONG RC4_CHAR&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    build_file =&gt; &#34;Makefile&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    build_scheme =&gt; [ &#34;unified&#34;, &#34;unix&#34; ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cflags =&gt; &#34;-pthread&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cppflags =&gt; &#34;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cxxflags =&gt; &#34;-std=c++11 -pthread&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    defines =&gt; [ &#34;OPENSSL_BUILDING_OPENSSL&#34; ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    disable =&gt; [  ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dso_ldflags =&gt; &#34;-Wl,-z,defs&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dso_scheme =&gt; &#34;dlfcn&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    enable =&gt; [ &#34;afalgeng&#34; ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ex_libs =&gt; &#34;-ldl -pthread&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    includes =&gt; [  ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    lflags =&gt; &#34;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    lib_cflags =&gt; &#34;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    lib_cppflags =&gt; &#34;-DOPENSSL_USE_NODELETE&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    lib_defines =&gt; [  ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    module_cflags =&gt; &#34;-fPIC&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    module_cxxflags =&gt; undef,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    module_ldflags =&gt; &#34;-Wl,-znodelete -shared -Wl,-Bsymbolic&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    perl_platform =&gt; &#34;Unix&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    perlasm_scheme =&gt; &#34;linux64&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_cflag =&gt; &#34;-fPIC&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_defflag =&gt; &#34;-Wl,--version-script=&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_defines =&gt; [  ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_ldflag =&gt; &#34;-Wl,-znodelete -shared -Wl,-Bsymbolic&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_rcflag =&gt; &#34;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_sonameflag =&gt; &#34;-Wl,-soname=&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_target =&gt; &#34;linux-shared&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    thread_defines =&gt; [  ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    thread_scheme =&gt; &#34;pthreads&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    unistd =&gt; &#34;&lt;unistd.h&gt;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Recorded environment:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    AR = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    BUILDFILE = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CC = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CPPFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CROSS_COMPILE = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CXX = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CXXFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    HASHBANGPERL = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    LDFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    LDLIBS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    OPENSSL_LOCAL_CONFIG_DIR = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    PERL = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RANLIB = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RC = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RCFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    WINDRES = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_CFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_CPPDEFINES = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_CPPFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_CPPINCLUDES = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_CXXFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_LDFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_LDLIBS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Makevars:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    AR              = /opt/riscvx/bin/riscv64-unknown-linux-gnu-ar
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ARFLAGS         = qc
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ASFLAGS         = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CC              = /opt/riscvx/bin/riscv64-unknown-linux-gnu-gcc
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CFLAGS          = -Wall -O3 -march=rv64gcv_zkne_zknd_zknh_zvkng_zvksg
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CPPDEFINES      = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CPPFLAGS        = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CPPINCLUDES     = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CROSS_COMPILE   = /opt/riscvx/bin/riscv64-unknown-linux-gnu-
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CXX             = /opt/riscvx/bin/riscv64-unknown-linux-gnu-g++
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CXXFLAGS        = -Wall -O3 -march=rv64gcv_zkne_zknd_zknh_zvkng_zvksg
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    HASHBANGPERL    = /usr/bin/env perl
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    LDFLAGS         = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    LDLIBS          = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    PERL            = /usr/bin/perl
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RANLIB          = /opt/riscvx/bin/riscv64-unknown-linux-gnu-ranlib
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RC              = /opt/riscvx/bin/riscv64-unknown-linux-gnu-windres
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RCFLAGS         = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">NOTE: These variables only represent the configuration view.  The build file
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">template may have processed these variables further, please have a look at the
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">build file for more exact data:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    Makefile
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">build file:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    Makefile
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">build file templates:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    ../vendor/openssl/Configurations/common0.tmpl
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ../vendor/openssl/Configurations/unix-Makefile.tmpl
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> make
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">opt/riscvx/lib/gcc/riscv64-unknown-linux-gnu/14.0.1/../../../../riscv64-unknown-linux-gnu/bin/ld: cannot find -ldl: No such file or directory
</span></span></span></code></pre></div><p>The error is in the linking phase, since we did not provide the correct sysroot and path information needed by the crosscompiling linker.</p>
<p>A quick check of the object files generated includes:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span>  find . -name <span style="color:#4e9a06">\*</span>risc<span style="color:#4e9a06">\*</span>.o
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sm4/libcrypto-lib-sm4-riscv64-zvksed.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sm4/libcrypto-shlib-sm4-riscv64-zvksed.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-lib-aes-riscv64-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-shlib-aes-riscv64-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-shlib-aes-riscv64-zvbb-zvkg-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-shlib-aes-riscv64-zkn.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-lib-aes-riscv64-zkn.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-shlib-aes-riscv64-zvkb-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-shlib-aes-riscv64.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-lib-aes-riscv64-zvkb-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-lib-aes-riscv64-zvbb-zvkg-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-lib-aes-riscv64.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/chacha/libcrypto-shlib-chacha_riscv.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/chacha/libcrypto-lib-chacha_riscv.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/chacha/libcrypto-lib-chacha-riscv64-zvkb.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/chacha/libcrypto-shlib-chacha-riscv64-zvkb.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/libcrypto-shlib-riscv64cpuid.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/libcrypto-lib-riscv64cpuid.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sha/libcrypto-lib-sha_riscv.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sha/libcrypto-lib-sha256-riscv64-zvkb-zvknha_or_zvknhb.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sha/libcrypto-shlib-sha512-riscv64-zvkb-zvknhb.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sha/libcrypto-shlib-sha_riscv.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sha/libcrypto-shlib-sha256-riscv64-zvkb-zvknha_or_zvknhb.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sha/libcrypto-lib-sha512-riscv64-zvkb-zvknhb.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sm3/libcrypto-lib-sm3-riscv64-zvksh.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sm3/libcrypto-lib-sm3_riscv.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sm3/libcrypto-shlib-sm3-riscv64-zvksh.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sm3/libcrypto-shlib-sm3_riscv.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/libcrypto-shlib-riscvcap.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-shlib-ghash-riscv64.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-shlib-ghash-riscv64-zvkg.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-lib-aes-gcm-riscv64-zvkb-zvkg-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-lib-ghash-riscv64.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-shlib-ghash-riscv64-zvkb-zvbc.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-lib-ghash-riscv64-zvkg.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-shlib-aes-gcm-riscv64-zvkb-zvkg-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-lib-ghash-riscv64-zvkb-zvbc.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/libcrypto-lib-riscvcap.o
</span></span></span></code></pre></div><p>That suggests we need to cover more extensions:</p>
<ul>
<li>vbb</li>
<li>vbc</li>
<li>vkb</li>
<li>vkg</li>
<li>vkned</li>
</ul>
<p>The openssl source code conditionally defines symbols like:</p>
<ul>
<li>RISCV_HAS_V</li>
<li>RISCV_HAS_ZVBC</li>
<li>RISCV_HAS_ZVKB</li>
<li>RISCV_HAS_ZVKNHA</li>
<li>RISCV_HAS_ZVKNHB</li>
<li>RISCV_HAS_ZVKSH</li>
<li>RISCV_HAS_ZBKB</li>
<li>RISCV_HAS_ZBB</li>
<li>RISCV_HAS_ZBC</li>
<li>RISCV_HAS_ZKND</li>
<li>RISCV_HAS_ZKNE</li>
<li>RISCV_HAS_ZVKG - currently missing, or a union of zvkng and zvksg?</li>
<li>RISCV_HAS_ZVKNED - currently missing or a union of zvkned and zvksed?</li>
<li>RISCV_HAS_ZVKSED - currently missing, defined but unused?</li>
</ul>
<p>These symbols are defined in <code>crypto/riscvcap.c</code> after analyzing the <code>march</code> string passed to the compiler.</p>
<p>So the next steps include:</p>
<ul>
<li>Define <code>LDFLAGS</code> and <code>LDLIBS</code> to enable building a riscv-64 <code>openssl.so</code>.</li>
<li>add additional march elements to generate as many ISA extension exemplars as we can</li>
<li>iterate on Ghidra sinc files to define any missing instructions</li>
<li>extend riscv-64 assembly samples to include all riscv-64 ISA extensions appearing in openssl source</li>
<li>verify that we have acceptable pcode opcodes for all riscv-64 ISA extensions appearing in openssl source</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> build_openssl$../vendor/openssl/Configure linux64-riscv64 --cross-compile-prefix<span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx/bin/riscv64-unknown-linux-gnu- -march<span style="color:#ce5c00;font-weight:bold">=</span>rv64gcv_zkne_zknd_zknh_zvkng_zvbb_zvbc_zvkb_zvkg_zvkned_zvksg
</span></span></code></pre></div><p>Patch the generated Makefile to:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>&lt; CNF_EX_LIBS=-ldl -pthread
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>&gt; CNF_EX_LIBS=/opt/riscvx/lib/libdl.a -pthread
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> make
</span></span></code></pre></div><ul>
<li>open <code>libcrypto.so.3</code> and <code>libssl.so.3</code> in Ghidra.</li>
<li>analyze and open bookmarks</li>
<li>verify - in the Bookmarks window - that all instructions disassembled and no instructions lack pcode</li>
</ul>
<h2 id="integration-testing-manual">Integration testing (manual)</h2>
<p>Disassembly testing against binutils reference dumps can follow these steps:</p>
<ul>
<li>Open <code>libcrypt.so.3</code> in Ghidra</li>
<li>export as ASCII to <code>/tmp/libcrypto.so.3.txt</code></li>
<li>export as C/C++ to <code>/tmp/libcrypto.so.3.c</code></li>
<li>generate reference disassembly via
<ul>
<li><code>/opt/riscvx/bin/riscv64-unknown-linux-gnu-objdump -j .text -D libcrypto.so.3 &gt; libcrypto.so.3_ref.txt</code></li>
</ul>
</li>
<li>grep both <code>/tmp/libcrypto.so.3.txt</code> and <code>libcrypto.so.3_ref.txt</code> for <code>vset</code> instructions, comparing operands</li>
<li>optionally parse vector instructions out of both files and compare decodings</li>
</ul>
<h2 id="inspect-extension-management">inspect extension management</h2>
<p>How does Openssl manage RISCV ISA extensions?  We&rsquo;ll use the <code>gcm_ghash</code> family of functions as examples.</p>
<ul>
<li>At compile time any <code>march=rv64gcv_z...</code> arguments are processed by the Openssl configuration tool and
turned into <code>#ifdef</code> variables. These can include combinations like <code>RISCV_HAS_ZVKB_AND_ZVKSED</code>.
Multiple versions of key routines are compiled, each with different required extensions.</li>
<li>The compiler can also use any of the bit manipulation and vector extensions in local optimization.</li>
<li>At runtime the library queries the underlying system to see which extensions are supported.  The function
<code>gcm_get_funcs</code> returns the preferred set of implementing functions.  The <code>gcm_ghash</code> set can include:
<ul>
<li><code>gcm_ghash_4bit</code></li>
<li><code>gcm_ghash_rv64i_zvkb_zvbc</code></li>
<li><code>gcm_ghash_rv64i_zvkg</code></li>
<li><code>gcm_ghash_rv64i_zbc</code></li>
<li><code>gcm_ghash_rv64i_zbc__zbkb</code></li>
</ul>
</li>
</ul>
<p>The <code>gcm_ghash_4bit</code> is the default version with 412 instructions, of which 11 are vector instructions inserted by the compiler.</p>
<p>The <code>gcm_ghash_rv64i_zvkg</code> is the most advanced version with only 32 instructions.  Ghidra decompiles this as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">gcm_ghash_rv64i_zvkg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined8</span> <span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">undefined8</span> <span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">param_4</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar2</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e32m1tumu</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">param_3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param_3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">param_4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param_4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vghsh_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_4</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vse32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>That shows an error in our sinc files - several instructions use the vd register as both an input and an output, so our
pcode semantics need updating.  Do this and inspect the Ghidra output again:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">gcm_ghash_rv64i_zvkg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined8</span> <span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">undefined8</span> <span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">param_4</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar2</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar3</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e32m1tumu</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">param_3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param_3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">param_4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param_4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vghsh_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_4</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vse32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>That&rsquo;s better - commit and push.</p>

</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2023&ndash;2024
    <span class="td-footer__authors">Thixotropist | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span><span class="ms-2"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/ghidra_import_tests/js/main.min.f72b476219d6d29836acbc4e4f93cc4044a1d1e59172fa1e7c4dc32313e85efe.js" integrity="sha256-9ytHYhnW0pg2rLxOT5PMQESh0eWRcvoefE3DIxPoXv4=" crossorigin="anonymous"></script>
<script defer src="/ghidra_import_tests/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/ghidra_import_tests/js/tabpane-persist.js'></script>

  </body>
</html>
