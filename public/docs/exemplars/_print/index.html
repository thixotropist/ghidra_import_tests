<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head><script src="/ghidra_import_tests/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=ghidra_import_tests/livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="http://localhost:1313/ghidra_import_tests/docs/exemplars/">
<link rel="alternate" type="application/rss&#43;xml" href="http://localhost:1313/ghidra_import_tests/docs/exemplars/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/ghidra_import_tests/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/ghidra_import_tests/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-192x192.png" sizes="192x192">

<title>Exemplars | Ghidra Import Testing</title>
<meta name="description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins.">
<meta property="og:url" content="http://localhost:1313/ghidra_import_tests/docs/exemplars/">
  <meta property="og:site_name" content="Ghidra Import Testing">
  <meta property="og:title" content="Exemplars">
  <meta property="og:description" content="List the current importable and buildable exemplars, their origins, and the Ghidra features they are intended to validate or stress.
Overview Exemplars suitable for Ghidra import are generally collected by platform architecture, such as riscv64/exemplars or x86_64/exemplars. Some are imported from system disk images. Others are locally built from small source code files and an appropriate compiler toolchain. The initial scope includes Linux-capable RISCV 64 bit systems that might be found in network appliances or ML inference engines.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="Exemplars">
  <meta itemprop="description" content="List the current importable and buildable exemplars, their origins, and the Ghidra features they are intended to validate or stress.
Overview Exemplars suitable for Ghidra import are generally collected by platform architecture, such as riscv64/exemplars or x86_64/exemplars. Some are imported from system disk images. Others are locally built from small source code files and an appropriate compiler toolchain. The initial scope includes Linux-capable RISCV 64 bit systems that might be found in network appliances or ML inference engines.">
  <meta itemprop="dateModified" content="2024-04-04T08:51:19-04:00">
  <meta itemprop="wordCount" content="1941"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Exemplars">
<meta name="twitter:description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins.">





<link href="/ghidra_import_tests/scss/main.css" rel="stylesheet">

<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/ghidra_import_tests/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">Ghidra Import Testing</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/ghidra_import_tests/about/"><span>About</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/ghidra_import_tests/docs/"><span>Docs</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/ghidra_import_tests/docs/exemplars/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Exemplars</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-288264c1b3d511c2f537720546ab0d1d">Whisper_cpp</a></li>


    
  
    
    
	
<li>2: <a href="#pg-82e1212fbf9a7e85bfc9498444b73578">Data Plane Development Kit</a></li>


    
  

    </ul>


<div class="content">
      

<div class="pageinfo pageinfo-primary">
<p>List the current importable and buildable exemplars, their origins, and the Ghidra features they are intended to validate or stress.</p>

</div>

<h2 id="overview">Overview</h2>
<p>Exemplars suitable for Ghidra import are generally collected by platform architecture, such as <code>riscv64/exemplars</code> or <code>x86_64/exemplars</code>.
Some are imported from system disk images.  Others are locally built from small source code files and an appropriate compiler toolchain.
The initial scope includes Linux-capable RISCV 64 bit systems that might be found in network appliances or ML inference engines.  That makes for a local
bias towards privileged code, concurrency management, and performance optimization.  That scope expands slightly to x86_64 exemplars that
may help triage issues that show up first in RISCV 64 exemplars.</p>
<p>You can get decent exemplar coverage with this set of exemplars:</p>
<ul>
<li>from a general purpose RISCV-64 disk image:
<ul>
<li>kernel - a RISCV-64 kernel built with a recent Linux release</li>
<li>kernel load module - an ELF binary intended to be loaded into a running kernel</li>
<li>system library - libc.so or libssl.so copied from a generic Linux disk image</li>
<li>system application - a user application linking against system libraries and running over a Linux kernel</li>
</ul>
</li>
<li>built from source, with the development tip of the gcc toolchain and many explicit ISA extensions:
<ul>
<li>binutils assembly test suite - ISA extensions usually show up here first, along with preferred disassembly patterns</li>
<li>memcpy and other libc replacements coded with RISCV-64 ISA intrinsic extensions</li>
<li><code>libssl.so</code> and <code>libcrypt.so</code> built from source and configured for all standard and frozen crypto, vector, and bit manipulation
instruction extensions.</li>
<li>DPDK network appliance source code, <code>l3fwd</code> and <code>l2fwd</code>.</li>
</ul>
</li>
</ul>
<p>In general, visual inspection of these exemplars after importing into Ghidra should show:</p>
<ul>
<li>no failed constructors, so all instructions are recognized by Ghidra during disassembly</li>
<li>no missing pcode</li>
<li>all vector vset* instructions are unwrapped to show selected element width, multiplier, tail and mask handling</li>
</ul>
<p>Ghidra will in a few cases disassemble an instruction differently than binutils&rsquo; <code>objdump</code>.  That&rsquo;s fine, if it is due to a limitation
of Ghidra&rsquo;s SLEIGH language. If alignment to <code>objdump</code> is possible, that&rsquo;s preferable.</p>
<h2 id="imported-exemplars">Imported exemplars</h2>
<p>Most of the imported large binary exemplars are broken out of current Fedora disk images.  The top level <code>acquireExternalExemplars.py</code>
script controls this process, sometimes with some manual intervention to handle image mounting.  Selection of the imported disk image
is controlled with text like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#000">LOGLEVEL</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">logging</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">WARN</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FEDORA_RISCV_SITE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;http://fedora.riscv.rocks/kojifiles/work/tasks/6900/1466900&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FEDORA_RISCV_IMAGE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Fedora-Developer-39-20230927.n.0-sda.raw&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FEDORA_KERNEL</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;vmlinuz-6.5.4-300.0.riscv64.fc39.riscv64&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FEDORA_KERNEL_OFFSET</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">40056</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FEDORA_KERNEL_DECOMPRESSED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;vmlinux-6.5.4-300.0.riscv64.fc39.riscv64&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">FEDORA_SYSMAP</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;System.map-6.5.4-300.0.riscv64.fc39.riscv64&#34;</span>
</span></span></code></pre></div><h3 id="fedora-kernel">Fedora kernel</h3>
<p>This exemplar kernel is not an ELF file, so analysis of the import process will need
help.</p>
<ul>
<li>The import process explicitly sets the processor on the command line: <code>-processor RISCV:LE:64:RV64IC</code>.
This will likely be the same as the processor determined from imported kernel load modules.</li>
<li>Ghidra recognizes three sections, one text and two data.  All three need to be moved
to the offset suggested in the associated <code>System.map</code> file.  For example, <code>.text</code> moves from
0x1000 to 0x80001000.  Test this by verifying function start addresses identified in <code>System.map</code>
look like actual RISCV-64 kernel functions.  Most begin with 16 bytes of no-op instructions
to support debugging and tracing operations.</li>
<li>Mark <code>.text</code> as code by selecting from 0x80001000 to 0x80dfffff and hitting the <code>D</code> key.</li>
</ul>
<h4 id="verification">Verification</h4>
<p>Verify that kernel code correctly references data:</p>
<ol>
<li>locate the address of <code>panic</code> in <code>System.map</code>: ffffffff80b6b188</li>
<li>go to 0x80b6b188 in Ghidra and verify that this is a function</li>
<li>display references to <code>panic</code> and examine the decompiler window.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span> <span style="color:#8f5902;font-style:italic">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s_Fatal_exception_in_interrupt_813f84f8</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><h4 id="notes">Notes</h4>
<p>This kernel includes 149 strings including <code>sifive</code>, most of which appear in <code>System.map</code>.  It&rsquo;s not immediately clear whether these
indicate kernel mods by SiFive or an SiFive SDK kernel module compiled into the kernel.</p>
<p>The kernel currently includes a few RISCV instruction set extensions not handled by Ghidra, and possibly not even by <code>binutils</code> and the <code>gas</code>
RISCV assembler.  Current Linux kernels can bypass the standard assembler to insert custom or obscure privileged instructions.</p>
<p>This Linux kernel explicitly includes ISA extension code for processors that support those extensions.  For example, if the kernel boots
up on a processor supporting the <code>_zbb</code> bit manipulation instruction extensions, then the vanilla <code>strlen</code>, <code>strcmp</code>, and <code>strncmp</code> kernel
functions are patched out to invoke <code>strlen_zbb</code>, <code>strcmp_zbb</code>, and <code>strncmp_zbb</code> respectively.</p>
<p>This kernel can support up to 64 discrete ISA extensions, of which about 30 are currently defined.  It has some support for hybrid processors,
where each of the hardware threads (aka &lsquo;harts&rsquo;) can support a different mix of ISA extensions.</p>
<blockquote>
<p>Note: The combination of instruction set extensions and self-modifying privileged code makes for a fertile ground for Ghidra research.
We can expect vector variants of <code>memcpy</code> inline expansion sometime in 2024, significantly complicating cyberanalysis of
even the simplest programs.</p>
</blockquote>
<h3 id="fedora-kernel-modules">Fedora kernel modules</h3>
<p>Kernel modules are typically ELF files compiled as Position Independent Code, often using more varied Elf relocation types
for dynamically loading and linking into kernel memory space.  This study looks at the <code>igc.ko</code> kernel module for a type
of Intel network interface device.  Network device drivers can have some of the most time-critical and race-condition-rich
behavior, making this class of driver a good exemplar.</p>
<p>RISCV relocation types found in this exemplar include:</p>
<p>R_RISCV_64(2), R_RISCV_BRANCH(16), R_RISCV_JAL(17), R_RISCV_CALL(18), R_RISCV_PCREL_HI20(23), R_RISCV_PCREL_LO12_I(24),
R_RISCV_ADD32(35), R_RISCV_ADD64(36), R_RISCV_SUB32(39), R_RISCV_SUB64(40), R_RISCV_RVC_BRANCH(44), and R_RISCV_RVC_JUMP(45)</p>
<h4 id="verification-1">Verification</h4>
<p>Open Ghidra&rsquo;s Relocation Table window and verify that all relocations were applied.</p>
<p>Go to <code>igc_poll</code>, open a decompiler window, and export the function as <code>igc_poll.c</code>.  Compare this file with the
provided <code>igc_poll_decompiled.c</code> in the visual difftool of your choice (e.g. <code>meld</code>) and check for the presence of lines
like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">netdev_printk</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">_LC7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined8</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">lVar33</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">),</span><span style="color:#4e9a06">&#34;Unknown Tx buffer type</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>This statement generates - and provides tests for - at least four relocation types.</p>
<h4 id="notes-1">Notes</h4>
<p>The decompiler translates <em>all</em> fence instructions as <code>fence()</code>.  This kernel module uses 8 distinct <code>fence</code> instructions
to request memory barriers.  The sleigh files should probably be extended to show either <code>fence(1,5)</code> or the Linux macro names
given in <code>linux/arch/riscv/include/asm/barrier.h</code>.</p>
<h3 id="fedora-system-libraries">Fedora system libraries</h3>
<p>System libraries like <code>libc.so</code> and <code>libssl.so</code> typically link to versioned shareable object libraries like <code>libc.so.6</code> and <code>libssl.so.3.0.5</code>.  Ghidra imports
RISCV system libraries well.</p>
<p>Relocation types observed include:</p>
<p>R_RISCV_64(2), R_RISCV_RELATIVE(3), R_RISCV_JUMP_SLOT(5), and R_RISCV_TLS_TPREL64(11)</p>
<p>R_RISCV_TLS_TPREL64 is currently unsupported by Ghidra, appearing in the <code>libc.so.6</code> .got section about 15 times.  This relocation type does not appear
in <code>libssl.so.3.0.5</code>.  It appears in multithreaded applications that use thread-local storage.</p>
<h3 id="fedora-system-executables">Fedora system executables</h3>
<p>The <code>ssh</code> utility imports cleanly into Ghidra.</p>
<p>Relocation types observed include:</p>
<p>R_RISCV_64(2), R_RISCV_RELATIVE(3), R_RISCV_JUMP_SLOT(5)</p>
<p>Function thunks referencing external library functions do not automatically get the name of the external function propagated into the name of the thunk.</p>
<h2 id="locally-built-exemplars">Locally built exemplars</h2>
<p>Imported binaries are generally locked into a single platform and a single toolchain.  The imported binaries above are built for an SiFive
development board, a 64 bit RISCV processor with support for Integer and Compressed instruction sets, and a gcc-13 toolchain.  If we want some
variation on that, say to look ahead at challenges a gcc-14 toolchain might throw our way, we need to build our own exemplars.</p>
<p>Open source test suites can be a good source for feature-focused importable exemplars.  If we want to test Ghidra&rsquo;s ability to import RISCV instruction
set extensions, we want to import many of the files from <a href="https://sourceware.org/git?p=binutils-gdb.git;a=tree;f=gas/testsuite/gas/riscv;hb=HEAD">binutils-gdb/gas/testsuite/gas/riscv</a>.</p>
<p>For example, most of the ratified set of RISCV vector instructions are used in <code>vector-insns.s</code>.
If we assemble this with a <code>gas</code> assembler compatible with the <code>-march=rv32ifv</code> architecture
we get an importable binary exemplar for those instructions.
Even better, we can disassemble that exemplar with a compatible <code>objdump</code> and get the reference disassembly to compare against Ghidra&rsquo;s disassembly.
This gives us three kinds of insights into Ghidra&rsquo;s import capabilities:</p>
<ol>
<li>When new instructions appear in the <code>binutils</code> <code>gas</code> main branch, they are good candidates for implementation in Ghidra within the next 12 months.
This currently includes vector, bit manipulation, cache management, and crypto approved extensions plus about a dozen vendor-specific extensions
from AliBaba&rsquo;s THead RISCV server initiative.</li>
<li>These exemplars drive extension of Ghidra&rsquo;s RISCV sleigh files, both as new instruction definitions and as pcode semantics for display in the decompiler window.</li>
<li>Disassembly of those exemplars with a current <code>binutils</code> <code>objdump</code> utility gives us a reference disassembly to compare with Ghidra&rsquo;s.
We can minimize arbitrary or erroneous Ghidra disassembly by comparing the two disassembler views.
Ghidra and <code>objdump</code> have different goals, so we don&rsquo;t need strict alignment of Ghidra with <code>objdump</code>.</li>
</ol>
<p>Most exemplars appear as four related files.  We can use the <code>vector</code> exemplar as an example.</p>
<ul>
<li>The source file is <code>riscv64/toolchain/assemblySamples/vector.S</code>, copied from <code>binutils-gdb/gas/testsuite/gas/riscv/vector-insns.s</code>.</li>
<li><code>vector.S</code> is assembled into <code>riscv64/exemplars/vector.o</code></li>
<li>That assembly run generates the assembly output listing <code>riscv64/exemplars/vector.log</code>.</li>
<li><code>riscv64/exemplars/vector.o</code> is finally processed by <code>binutils</code> <code>objdump</code> to generate the reference disassembly <code>riscv64/exemplars/vector.objdump</code>.</li>
</ul>
<p>The <code>riscv64/exemplars/vector.o</code> is then imported into the Ghidra <code>exemplars</code> project, where we can evaluate the import and disassembly results.</p>
<p>Assembly language exemplars usually don&rsquo;t have any sensible decompilation.  C or C++ language exemplars usually do, so that gives the test analyst more to work with.</p>
<p>Another example shows Ghidra&rsquo;s difficulty with vector optimized code.  Compile this C code for the <code>rv64gcv</code> architecture (RISCV-64 with vector extensions), using the
gcc-14 toolchain due for mid 2024 release.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;stdio.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1320</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;\0&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Ghidra&rsquo;s 11.0 release decompiles this into:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>/* WARNING: Control flow encountered unimplemented instructions */
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>void main(void)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  gp = &amp;__global_pointer$;
</span></span><span style="display:flex;"><span>                    /* WARNING: Unimplemented instruction - Truncating control flow here */
</span></span><span style="display:flex;"><span>  halt_unimplemented();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Try the import again with the <code>isa_ext</code> experimental branch of Ghidra:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>undefined8 main(void)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  undefined auVar1 [64];
</span></span><span style="display:flex;"><span>  undefined8 uVar2;
</span></span><span style="display:flex;"><span>  undefined (*pauVar3) [64];
</span></span><span style="display:flex;"><span>  long lVar4;
</span></span><span style="display:flex;"><span>  long lVar5;
</span></span><span style="display:flex;"><span>  undefined auVar6 [256];
</span></span><span style="display:flex;"><span>  undefined auVar7 [256];
</span></span><span style="display:flex;"><span>  char local_540 [1319];
</span></span><span style="display:flex;"><span>  undefined uStack_19;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  gp = &amp;__global_pointer$;
</span></span><span style="display:flex;"><span>  pauVar3 = (undefined (*) [64])local_540;
</span></span><span style="display:flex;"><span>  lVar4 = 0x527;
</span></span><span style="display:flex;"><span>  vsetvli_e32m1tama(0);
</span></span><span style="display:flex;"><span>  auVar7 = vid_v();
</span></span><span style="display:flex;"><span>  do {
</span></span><span style="display:flex;"><span>    lVar5 = vsetvli(lVar4,0xcf);
</span></span><span style="display:flex;"><span>    auVar6 = vmv1r_v(auVar7);
</span></span><span style="display:flex;"><span>    lVar4 = lVar4 - lVar5;
</span></span><span style="display:flex;"><span>    auVar6 = vncvt_xxw(auVar6);
</span></span><span style="display:flex;"><span>    vsetvli(0,0xc6);
</span></span><span style="display:flex;"><span>    auVar6 = vncvt_xxw(auVar6);
</span></span><span style="display:flex;"><span>    auVar6 = vadd_vi(auVar6,1);
</span></span><span style="display:flex;"><span>    auVar1 = vse8_v(auVar6);
</span></span><span style="display:flex;"><span>    *pauVar3 = auVar1;
</span></span><span style="display:flex;"><span>    uVar2 = vsetvli_e32m1tama(0);
</span></span><span style="display:flex;"><span>    pauVar3 = (undefined (*) [64])(*pauVar3 + lVar5);
</span></span><span style="display:flex;"><span>    auVar6 = vmv_v_x(lVar5);
</span></span><span style="display:flex;"><span>    auVar7 = vadd_vv(auVar7,auVar6);
</span></span><span style="display:flex;"><span>  } while (lVar4 != 0);
</span></span><span style="display:flex;"><span>  uStack_19 = 0;
</span></span><span style="display:flex;"><span>  printf(local_540,uVar2);
</span></span><span style="display:flex;"><span>  return 0;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>That Ghidra branch decompiles, but the decompilation listing only resembles the C source code if you are familiar with RISCV vector extension instructions.</p>
<p>Repeat the example, this time building with a gcc-13 toolchain.  Ghidra 11.0 does a fine job of decompiling this.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">undefined8</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">acStack_541</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1320</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">uStack_19</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">acStack_541</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">lVar1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">char</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar1</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar1</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0x528</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uStack_19</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">acStack_541</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="x86_64-exemplars">x86_64 exemplars</h3>
<p>A few x86_64 exemplars exist to explore the scope of issues raised by RISCV exemplars.  The <code>x86_64/exemplars</code> directory
shows how optimizing gcc-14 compilations handle simple loops and built-ins like <code>memcpy</code> for various microarchitectures.</p>
<p>Intel microarchitectures can be grouped into common profiles like <code>x86-64-v2</code>, <code>x86-64-v3</code>, and <code>x86-64-v4</code>.  Each has its own set of
instruction set extensions, so an optimizing compiler like gcc-14 will autovectorize loops and built-ins differently for each microarchitecture.</p>
<p>The <code>memcpy</code> exemplar set includes source code and three executables compiled from that source code with <code>-march=x86-64-v2</code>, <code>-march=x86-64-v3</code>, and
<code>-march=x86-64-v4</code>.  The binutils-2.41 <code>objdump</code> disassembly is provided for each executable, for comparison with Ghidra&rsquo;s disassembly window.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">x86_64/exemplars$ ls memcpy*
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">memcpy.c  memcpy_x86-64-v2  memcpy_x86-64-v2.objdump  memcpy_x86-64-v3  memcpy_x86-64-v3.objdump  memcpy_x86-64-v4  memcpy_x86-64-v4.objdump
</span></span></span></code></pre></div><p>These exemplars suggest several Ghidra issues:</p>
<ul>
<li>Ghidra&rsquo;s disassembler is generally unable to recognize many vector instructions generated by gcc-14 with <code>-march=x86-64-v4</code> and <code>-O3</code>.</li>
<li>Ghidra&rsquo;s decompiler provides the user little help in recognizing the semantics of <code>memcpy</code> or many simple loops with <code>-march=x86-64-v2</code> or <code>-march=x86-64-v3</code>.</li>
<li>Ghidra users should be prepared for wide variety in vector optimized instruction sequences.  Pattern recognition will be difficult.</li>
</ul>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-288264c1b3d511c2f537720546ab0d1d">1 - Whisper_cpp</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Explore analysis of a machine learning application built with large language model techniques.  What Ghidra gaps does such an analysis reveal?</p>

</div>

<p>How might we inspect a machine-learning application for malware? For example, suppose someone altered the automatic speech recognition library <a href="https://github.com/ggerganov/whisper.cpp">whisper.cpp</a>.  Would Ghidra be able to cope with the instruction set extensions used to accelerate ML inference engines?  What might be added to Ghidra to help the human analyst in this kind of inspection?</p>
<p>Components for this exercise:</p>
<ul>
<li>A Linux x86_64 Fedora 39 base system</li>
<li>Ghidra 11.0 public</li>
<li>Ghidra 11.1-DEV with the <code>isa_ext</code> branch for RISCV-64 support</li>
<li>A stripped target binary <code>whisper_cpp_vendor</code> built with RISCV-64 gcc-14 toolchain and the whisper.cpp 1.5.4 release.
<ul>
<li>RISCV-64 vector and other approved extensions are enabled for this build</li>
<li>published binutils-2.41 vendor-specific extensions are enabled for this build</li>
<li>whisper library components are statically linked, while system libraries are dynamically linked</li>
</ul>
</li>
<li>Reference binaries <code>whisper_cpp_*</code> built locally with other RISCV-64 gcc toolchains</li>
<li>Ghidra&rsquo;s BSIM binary similarities plugins and analytics</li>
</ul>
<p>Questions to address:</p>
<ul>
<li>does the presence of vector and other ISA extensions in <code>whisper_cpp_vendor</code> materially hurt Ghidra 11.0 analysis?</li>
<li>can BSIM analytics still find similarities between <code>whisper_cpp_vendor</code> and the non-vector build <code>whisper_cpp_default</code></li>
<li>are there recurring vector instruction patterns present in <code>whisper_cpp_vendor</code> that Ghidra users should be able to recognize?</li>
<li>are there additional instructions or instruction-semantics that we should add to the <code>isa_ext</code> branch?</li>
<li>if the vendor adds Link Time Optimization to their <code>whisper_cpp_vendor</code> build, does this materially hurt Ghidra 11.0 analysis?</li>
</ul>
<p>There are a lot of variables in this exercise.  Some are important, most are not.</p>
<h2 id="baseline-ghidra-analysis">Baseline Ghidra analysis</h2>
<p>Starting with the baseline Ghidra 11.0, examine a locally built <code>whisper_cpp_default</code>, an ELF 64-bit LSB executable built with gcc-13.2.1.
Import and perform standard analyses to get these statistics:</p>
<ul>
<li>186558 instructions recognized</li>
<li>text segment size 0x8678a</li>
<li>12 bad instruction errors, all of which appear to be the <code>fence.tso</code> instruction extension</li>
</ul>
<p>Now examine <code>whisper_cpp_vendor</code> (built with gcc 14 rather than gcc 13) with the baseline Ghidra 11.0:</p>
<ul>
<li>100521 instructions recognized</li>
<li>text segment size 0xb93cc</li>
<li>4299 bad instruction errors</li>
</ul>
<p>Examine <code>whisper_cpp_vendor</code> with the <code>isa_ext</code> branch of 11.1-DEV:</p>
<ul>
<li>169813 instructions recognized</li>
<li>text segment size 0xb93cc</li>
<li>17 bad instruction errors, all of which appear to be the <code>fence.tso</code> instruction extension</li>
</ul>
<p>Next apply a manual correction to <code>whisper_cpp_vendor</code>, selecting the entire <code>.text</code> segment and
forcing disassembly, then clearing any unreachable 0x00 bytes.</p>
<ul>
<li>190311 instructions recognized</li>
<li>17 bad instruction errors</li>
<li>4138 <code>vset*</code> instructions usually found in vector code</li>
<li>946 <code>gather</code> instructions</li>
<li>3562 <code>custom</code> instructions</li>
</ul>
<p>Finally, reset the &rsquo;language&rsquo; of <code>whisper_cpp_vendor</code> to match the vendor (THead, for this exercise).</p>
<p>The 3562 custom instructions resolve to:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Instruction</th>
<th style="text-align:right">Count</th>
<th style="text-align:left">Semantics</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">th.ext*</td>
<td style="text-align:right">151</td>
<td style="text-align:left">Sign extract and extend</td>
</tr>
<tr>
<td style="text-align:left">th.ldd</td>
<td style="text-align:right">1719</td>
<td style="text-align:left">Load 2 doublewords</td>
</tr>
<tr>
<td style="text-align:left">th.lwd</td>
<td style="text-align:right">10</td>
<td style="text-align:left">Load 2 words</td>
</tr>
<tr>
<td style="text-align:left">th.sdd</td>
<td style="text-align:right">1033</td>
<td style="text-align:left">store 2 doublewords</td>
</tr>
<tr>
<td style="text-align:left">th.swd</td>
<td style="text-align:right">16</td>
<td style="text-align:left">store 2 words</td>
</tr>
<tr>
<td style="text-align:left">th.mula</td>
<td style="text-align:right">284</td>
<td style="text-align:left">Multiply-add</td>
</tr>
<tr>
<td style="text-align:left">th.muls</td>
<td style="text-align:right">67</td>
<td style="text-align:left">Multiply-subtract</td>
</tr>
<tr>
<td style="text-align:left">th.mveqz</td>
<td style="text-align:right">127</td>
<td style="text-align:left">Move if == 0</td>
</tr>
<tr>
<td style="text-align:left">th.mvneqz</td>
<td style="text-align:right">154</td>
<td style="text-align:left">Move if != 0</td>
</tr>
</tbody>
</table>
<p>This leads to some tentative next steps:</p>
<ol>
<li>Adding <code>fence.tso</code> to Ghidra looks like a simple small win, and a perfect place to start.</li>
<li>The THead vendor-specific extensions look like simple peep-hole optimizations.  The semantics could
easily be added to Ghidra as compositions of two original instruction semantics.  Slightly less than 2% of the total instructions are THead vendor customizations.</li>
<li>The baseline Ghidra 11.0 stalls out very quickly on the vector instructions, making an early switch
to the <code>isa_ext</code> branch necessary.</li>
<li>The vector <code>gather</code> instructions are unexpectedly prevalent.</li>
<li>Manual inspection and sampling of the 4138 <code>vset*</code> instruction blocks may reveal some key patterns to
recognize first.</li>
</ol>
<blockquote>
<p>Note: <code>fence.tso</code> is now recognized in the Ghidra 11.1-DEV branch <code>isa_ext</code>,
clearing the <code>bad instruction errors</code>.</p>
</blockquote>
<h2 id="a-top-down-assessment">A top-down assessment</h2>
<p>At the highest level, what features of <code>whisper.cpp</code> generate vector instructions?</p>
<ul>
<li>There are about 400 invocations of RISCV vector intrinsic within <code>ggml-quants.c</code>.  In these cases the developer
has explicitly managed the vectorization.</li>
<li>There are an unknown number of automatic loop vectorizations, where gcc-14 has replaced simple scalar loops with
vector-based loops.  This vectorization will generally reduce the number of loop iterations, but may not always reduce
the number of instructions executed.</li>
<li>Gcc expansions of <code>memcpy</code> or structure copies into vector load-store loops.</li>
</ul>
<p>Much of <code>whisper.cpp</code> involves vector, matrix, or tensor math using <code>ggml</code> math functions.  This is also where most
of the explicit RISCV vector intrinsic C functions appear, and likely the code the developer believes is most in need
of vector performance enhancements.</p>
<h3 id="example-dot-product">Example: dot product</h3>
<p><code>ggml_vec_dot_f32(n, sum, x, y)</code> generates the vector dot product of two vectors x and y of length n with the result
stored to <code>*sum</code>.  In the absence of vector or SIMD support the source code is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// scalar
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">sumf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sumf</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>   <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sumf</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>GCC-14 will autovectorize this into something Ghidra decompiles like this (comments added after <code>//</code>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">ggml_vec_dot_f32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">step</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">dVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar2</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v2</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar3</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e64m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>                  <span style="color:#8f5902;font-style:italic">// v2 = 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">step</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x97</span><span style="color:#000;font-weight:bold">);</span>          <span style="color:#8f5902;font-style:italic">// vsetvli a5,a0,e32,mf2,tu,ma
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">step</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">);</span>             <span style="color:#8f5902;font-style:italic">// v3 = *x (slice of size step)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">);</span>             <span style="color:#8f5902;font-style:italic">// v1 = *y (slice of size step)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">sh2add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">step</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">);</span>      <span style="color:#8f5902;font-style:italic">// x = x + step
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar3</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// v1 = v1 * v3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">sh2add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">step</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">);</span>      <span style="color:#8f5902;font-style:italic">// y = y + step
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">in_v2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfwadd_wv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// v2 = v1 + v2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e64m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmv_sf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>                 <span style="color:#8f5902;font-style:italic">// v1[0] = 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfredusum_vs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// v1[0] = sum(v2)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">dVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">vfmv_fs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">);</span>     <span style="color:#8f5902;font-style:italic">// dvar1 = v1[0]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">dVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Inspecting this disassembly and decompilation suggests several top down issues:</p>
<ul>
<li>The semantics for <code>shadd2</code> are simple and should be explicit <code>sh2add(a, b) = a&gt;&gt;2 + b</code>
<ul>
<li>This is now implemented in Ghidra 11.1-DEV isa_ext.</li>
</ul>
</li>
<li>The <code>vsetvli(n,0x97)</code> instruction should be expanded to show semantics as <code>vsetvli_e32m2ftuma</code>
<ul>
<li>Running the binary through a RISCV objdump program gives us this formal expansion.  This instruction
says that the selected element width is 32 bits with a LMUL multiplication factor of 1/2.  This means that only
half of the vector register is used to allow for 64 bit arithmetic output.</li>
<li>This is now implemented in Ghidra 11.1-DEV isa_ext.</li>
</ul>
</li>
<li>The semantics for vector results need clarification</li>
<li>The loop accumulates 64 bit double values with 32 bit input values.  If the vector length is 256 bits, that means
the step size is 4 not 8</li>
<li>A capability to generate processor-specific inline hints or comments in the decompiler may be useful, especially if
there were a typographic way to distinguish vector and scalar objects.</li>
<li>If vector registers were infinitely long the loop might become <code>v2 = x * y</code> and the reduction <code>dvar1 = reduce(+, v2)</code></li>
</ul>
<p>The path forward may be to manually analyze several examples from <code>whisper.cpp</code>, extending and revising Ghidra&rsquo;s semantics
and decompiler to add a bit of clarity each time.</p>
<h3 id="example-auto-vectorization-makes-the-simple-complicated">Example: auto-vectorization makes the simple complicated</h3>
<p>Autovectorization can generate complicated code when the compiler has no knowledge of the number of elements in
a vector or the number of elements that can fit within single vector register.</p>
<p>A good example is from:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">ggml_tensor</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ggml_new_tensor_impl</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ggml_context</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">enum</span>   <span style="color:#000">ggml_type</span>      <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span>                   <span style="color:#000">n_dims</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int64_t</span>       <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ne</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">ggml_tensor</span>  <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">view_src</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">size_t</span>                <span style="color:#000">view_offs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ggml_row_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ne</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>         <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n_dims</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">*=</span> <span style="color:#000">ne</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>         <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The <code>ne</code> vector typically has up to 4 elements, so this loop will be executed at most once.  The compiler doesn&rsquo;t know this so it
autovectorizes the loop into something more complex:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">undefined4</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ggml_new_tensor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ggml_context</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">undefined8</span> <span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">ndims</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">int64_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ne</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ggml_row_size</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ne</span><span style="color:#000;font-weight:bold">);</span>              <span style="color:#8f5902;font-style:italic">// get the first dimension ne[0]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">lVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">ndims</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">uVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ndims</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">ndims</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">2U</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>                      <span style="color:#8f5902;font-style:italic">// if ndims &gt; 3 process two at a time
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">piVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ne</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>                              <span style="color:#8f5902;font-style:italic">// starting with ne[1] and ne[2]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">piVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">piVar7</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">uVar2</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetivli_e64m1tamu</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>                        <span style="color:#8f5902;font-style:italic">//vector length = 2, 64 bit element, tail agnostic mask unchanged
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>                             <span style="color:#8f5902;font-style:italic">// v1 = (1,1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle64_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">piVar7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">piVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">piVar7</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">in_v1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>              <span style="color:#8f5902;font-style:italic">// v1 = v1 * ne[slice]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">piVar4</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">piVar7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vid_v</span><span style="color:#000;font-weight:bold">();</span>                             <span style="color:#8f5902;font-style:italic">// v2 = (0,1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>                              <span style="color:#8f5902;font-style:italic">// v4 = (0,0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vadd_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>                  <span style="color:#8f5902;font-style:italic">// v2 = v2 + 1 = (1,2)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vmsgtu_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>                <span style="color:#8f5902;font-style:italic">// v0 = (v2 &gt; 1) = (0, 1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">vrgather_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>                    <span style="color:#8f5902;font-style:italic">// v3 = gather(v1, v2) =&gt; v3=v1[v2] = (v1[1], 0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vadd_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xfffffffffffffffe</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// v2 = v2 - 2 = (-1,0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vrgather_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>  <span style="color:#8f5902;font-style:italic">// v3 = gather_masked(v4,v2,v0.t) = (v3[0], v4[0])
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">);</span>              <span style="color:#8f5902;font-style:italic">// v3 = v3 * v1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">vmv_x_s</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v14</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>                       <span style="color:#8f5902;font-style:italic">// a4 = v3[0]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">piVar4</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">// data_size = data_size * a4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">uVar2</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">LAB_00074a80</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">lVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#000">uVar2</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xfffffffe</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">plVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">sh3add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">ne</span><span style="color:#000;font-weight:bold">);</span>               <span style="color:#8f5902;font-style:italic">// multiply by one or two 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">plVar5</span><span style="color:#000;font-weight:bold">;</span>                 <span style="color:#8f5902;font-style:italic">// 
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar6</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">ndims</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">data_size</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">plVar5</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>That&rsquo;s a very confusing way to multiply at most four integers.  If ne has 1, 2, or 3 elements then no vector instructions are processed at all.
If it has 4 elements then the first and last one or two are handled with scalar math while pairs of elements are accumulated in the loop.
The gather instructions are used together to generate a mask and then multiply the two elements of vector v1, leaving the result in the first
element slot of vector v4.</p>
<p>This particular loop vectorization is likely to change a lot in future releases.  The performance impact is negligible either way.  The analyst may
look at code like this and decide to ignore the ndims&gt;3 case along with <em>all</em> of the vector instructions used within it.  Alternatively, we could
look at the gcc vectorization code handling the general vector reduction meta operation, then see if this pattern is a macro of some sort within it.</p>
<p>Take a step back and look at the gcc RISCV autovectorization code.  It&rsquo;s changing quite frequently, so it&rsquo;s probably premature to try and abstract out
loop reduction models that we can get Ghidra to recognize.  When that happens we might draw source exemplars from
<code>gcc/gcc/testsuite/gcc.target/riscv/rvv/autovec</code> and build a catalog of source pattern to instruction pattern expansions.</p>
<h3 id="example-source-code-use-of-riscv-vector-intrinsics">Example: source code use of RISCV vector intrinsics</h3>
<p>The previous example showed an overly aggressive autovectorization of a simple loop.  Here we look at source code that the developer has decided is important enough
to directly code in RISCV intrinsic C functions.  The function <code>ggml_vec_dot_q5_0_q8_0</code> is one such function, with separate implementations for <code>ARM_NEON</code>, <code>wasm_simd128</code>,
<code>AVX2</code>, <code>AVX</code>, and <code>riscv_v_intrinsic</code>.  If none of those accelerators are available a scalar implementation is used instead:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">ggml_vec_dot_q5_0_q8_0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">vx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">qk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">qk</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">qk</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">qk</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">QK5_0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">block_q5_0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vx</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// scalar
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">sumf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nb</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">uint32_t</span> <span style="color:#000">qh</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">qh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">qh</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sumi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">qk</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">uint8_t</span> <span style="color:#000">xh_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">qh</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1u</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">)))</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">uint8_t</span> <span style="color:#000">xh_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">qh</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1u</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">)))</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int32_t</span> <span style="color:#000">x0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x0F</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">xh_0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int32_t</span> <span style="color:#000">x1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span>   <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">xh_1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">sumi</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">x0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">x1</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">qk</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sumf</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">GGML_FP16_TO_FP32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">GGML_FP16_TO_FP32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">sumi</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sumf</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The RISCV intrinsic source is:</p>
<blockquote>
<p>Note: added comments are flagged with <code>///</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">ggml_vec_dot_q5_0_q8_0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">vx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">qk</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">/// QK8_0 = 32
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">qk</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">qk</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">qk</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">QK5_0</span><span style="color:#000;font-weight:bold">);</span>   <span style="color:#8f5902;font-style:italic">/// QK5_0 = 32
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">block_q5_0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vx</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">sumf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">uint32_t</span> <span style="color:#000">qh</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">vl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsetvl_e8m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">qk</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// These temporary registers are for masking and shift operations
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">vt_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vid_v_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">vt_2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsll_vv_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__riscv_vmv_v_x_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">vt_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">vt_3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsll_vx_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vt_2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">vt_4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vadd_vx_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vt_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nb</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">memcpy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">qh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">uint32_t</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// ((qh &amp; (1u &lt;&lt; (j + 0 ))) &gt;&gt; (j + 0 )) &lt;&lt; 4;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">xha_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vand_vx_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vt_2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">qh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">xhr_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsrl_vv_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xha_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vt_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">xhl_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsll_vx_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xhr_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// ((qh &amp; (1u &lt;&lt; (j + 16))) &gt;&gt; (j + 12));
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">xha_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vand_vx_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vt_3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">qh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint32m2_t</span> <span style="color:#000">xhl_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsrl_vv_u32m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xha_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vt_4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// narrowing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vuint16m1_t</span> <span style="color:#000">xhc_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vncvt_x_x_w_u16m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xhl_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">xh_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vncvt_x_x_w_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xhc_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint16m1_t</span> <span style="color:#000">xhc_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vncvt_x_x_w_u16m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xhl_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">xh_1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vncvt_x_x_w_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xhc_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// load
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">tx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vle8_v_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8mf2_t</span> <span style="color:#000">y0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vle8_v_i8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8mf2_t</span> <span style="color:#000">y1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vle8_v_i8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">x_at</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vand_vx_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x0F</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">x_lt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsrl_vx_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0x04</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">x_a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vor_vv_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_at</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xh_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vuint8mf2_t</span> <span style="color:#000">x_l</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vor_vv_u8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_lt</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">xh_1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8mf2_t</span> <span style="color:#000">x_ai</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vreinterpret_v_u8mf2_i8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_a</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8mf2_t</span> <span style="color:#000">x_li</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vreinterpret_v_u8mf2_i8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_l</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8mf2_t</span> <span style="color:#000">v0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsub_vx_i8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_ai</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8mf2_t</span> <span style="color:#000">v1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsub_vx_i8mf2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x_li</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint16m1_t</span> <span style="color:#000">vec_mul1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vwmul_vv_i16m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint16m1_t</span> <span style="color:#000">vec_mul2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vwmul_vv_i16m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint32m1_t</span> <span style="color:#000">vec_zero</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vmv_v_x_i32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint32m1_t</span> <span style="color:#000">vs1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vwredsum_vs_i16m1_i32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vec_mul1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vec_zero</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint32m1_t</span> <span style="color:#000">vs2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vwredsum_vs_i16m1_i32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vec_mul2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vs1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sumi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vmv_x_s_i32m1_i32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vs2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sumf</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">GGML_FP16_TO_FP32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">GGML_FP16_TO_FP32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">sumi</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sumf</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Ghidra&rsquo;s 11.1 isa_ext rendering of this is (after minor parameter name propagation):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">ggml_vec_dot_q5_0_q8_0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">vx</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">vy</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ushort</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">puVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar6</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">fVar7</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar8</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar9</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar10</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar11</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v7</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v8</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar12</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar13</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar14</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar15</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar16</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iStack_4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsetivli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xc0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar13</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vid_v</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar15</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vadd_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xc</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar12</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsll_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsll_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x1f</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar6</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">vx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">vy</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetivli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xc6</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">iStack_4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">puVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ushort</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vand_vx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iStack_4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsrl_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vand_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsll_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsrl_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar16</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vand_vx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">,(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">iStack_4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vor_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsrl_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar15</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vadd_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xfffffffffffffff0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vwmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar16</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">lVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vwredsum_vs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">in_v7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">199</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vor_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vadd_vi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xfffffffffffffff0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vwmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vwredsum_vs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetivli</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0xd0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vmv_x_s</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar15</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x22</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">fVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ggml_table_f32_f16</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">puVar1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>              <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ggml_table_f32_f16</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ushort</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)]</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar5</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">fVar7</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x16</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(((</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1f</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fVar7</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>It looks like the developer unrolled an inner loop and used the LMUL multiplier to help reduce the loop iterations.  The immediate action item for us may be to
add more explicit decodings for <code>vsetvli</code> and <code>vsetivli</code>, or look for existing processor-specific decoders in the Ghidra decompiler.</p>
<h3 id="x86_64-whisper">x86_64 whisper</h3>
<p>Let&rsquo;s take a glance at the x86_64 build of <code>whisper</code>.  First copy <code>whisper-cpp.BUILD</code> into the x86_64 workspace then build the executable with two architectures:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:x86_64_default --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-march=x86-64-v3&#34;</span> @whisper_cpp//:main
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> cp bazel-bin/external/whisper_cpp/main ../exemplars/whisper_cpp_x86-64-v3
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> bazel build --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:x86_64_default --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-march=x86-64-v4&#34;</span> @whisper_cpp//:main
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> cp bazel-bin/external/whisper_cpp/main ../exemplars/whisper_cpp_x86-64-v4
</span></span></code></pre></div><p>Load these into Ghidra 11.1-DEV.  The <code>x86-64-v4</code> build is useless in Ghidra, since a different class of x86_64 vector extensions is used in that newer microarchitecture
and Ghidra doesn&rsquo;t recognize it.  The <code>x86-64-v3</code> build looks accessible.</p>
<p>Try an x86_64 build with the local compiler (Fedora 39 default compiler) and Link Time Optimization enabled:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build  --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-march=x86-64-v3&#34;</span> --copt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-flto&#34;</span>  --linkopt<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-Wl,-flto&#34;</span> @whisper_cpp//:main
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> cp bazel-bin/external/whisper_cpp/main ../exemplars/whisper_cpp_x86-64-v3-lto
</span></span></code></pre></div><p>We&rsquo;ll leave the differential analysis of link time optimization for another day.  A couple of quick notes are worthwhile here:</p>
<ul>
<li>The function <code>ggml_new_tensor</code> no longer exists in the binary.  Instead we get <code>ggml_new_tensor_impl.constprop.0</code>
<code>ggml_new_tensor_impl.constprop.0</code>, <code>ggml_new_tensor_impl.constprop.2</code>, and <code>ggml_new_tensor_impl.constprop.3</code>.
This suggests BSIM could get confused with intermediate functions if trying to connect binaries built with and without LTO.</li>
<li><em>None</em> of the hermetic toolchains appear to work when link time optimization is requested.  There appears to be at least one missing
LTO plugin from the gcc-14 toolchain packaging.  We&rsquo;ll try and find such for the next snapshot of gcc-14.</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-82e1212fbf9a7e85bfc9498444b73578">2 - Data Plane Development Kit</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Intel&rsquo;s DPDK framework supports some Intel and Arm Neon vector instructions.  What does it for RISCV extensions?
Are ISA extensions materially useful to a network appliance?</p>

</div>

<p>Check out DPDK from GitHub, patch the RISCV configuration with <code>riscv64/toolchains/dpdk/dpdk.pat</code>, and crosscompile with <code>meson</code>
and <code>ninja</code>.  Copy some of the examples into <code>riscv64/exemplars</code> and examine them in Ghidra.</p>
<ul>
<li>for this we use as many standard extensions as we can, excluding vendor-specific extensions.</li>
</ul>
<p>Configure a build directory:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> patch -p1 &lt; .../riscv64/toolchains/dpdk/dpdk.pat
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> meson setup build --cross-file config/riscv/riscv64_linux_gcc -Dexamples<span style="color:#ce5c00;font-weight:bold">=</span>all
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> <span style="color:#204a87">cd</span> build
</span></span></code></pre></div><p>Edit <code>build/build.ninja</code>:</p>
<ul>
<li>replace all occurrences of <code>-ldl</code> with <code>/opt/riscvx/lib/libdl.a</code> - you should see about 235 replacements</li>
</ul>
<p>Build with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> ninja -C build
</span></span></code></pre></div><p>Check the cross-compilation with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> readelf -A build/examples/dpdk-l3fwd
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Attribute Section: riscv
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">File Attributes
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_stack_align: 16-bytes
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_arch: &#34;rv64i2p1_m2p0_a2p1_f2p2_d2p2_c2p0_v1p0_zicsr2p0_zifencei2p0_zmmul1p0_zba1p0_zbb1p0_zbc1p0_zbkb1p0_zbkc1p0_zbkx1p0_zvbb1p0_zvbc1p0_zve32f1p0_zve32x1p0_zve64d1p0_zve64f1p0_zve64x1p0_zvkb1p0_zvl128b1p0_zvl32b1p0_zvl64b1p0&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_priv_spec: 1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  Tag_RISCV_priv_spec_minor: 11
</span></span></span></code></pre></div><p>Import into Ghidra 11.1-DEV(isa_ext), noting multiple import messages similar to:</p>
<ul>
<li>Unsupported Thread-Local Symbol not loaded</li>
<li>ELF Relocation Failure: R_RISCV_COPY (4, 0x4) at 00f0c400 (Symbol = stdout) - Runtime copy not supported</li>
</ul>
<h2 id="analysis">Analysis</h2>
<h3 id="source-code-examination">source code examination</h3>
<h4 id="explicit-vectorization">explicit vectorization</h4>
<p>The source code has explicit parallel coding for Intel and Arm/Neon architectures, for instance within
the basic layer 3 forwarding example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">acl_algorithms</span> <span style="color:#000">acl_alg</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;scalar&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_SCALAR</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;sse&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_SSE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;avx2&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_AVX2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;neon&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_NEON</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;altivec&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_ALTIVEC</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;avx512x16&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_AVX512X16</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;avx512x32&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">.</span><span style="color:#000">alg</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RTE_ACL_CLASSIFY_AVX512X32</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>If avx512x32 is selected, then basic trie search and other operations can proceed across 32 flows in parallel.
Other examples exist within the code.  For more information, search the <code>doc</code> directory for <code>SIMD</code>.  Check out <code>lib/fib/trie_avx512.c</code>
and the function <code>trie_vec_lookup_x16x2</code> for an AVX manual vectorization of a trie address to next hop lookup.</p>
<blockquote>
<p>Note: It won&rsquo;t be clear for some time which vectorization transforms actually improve performance on specific processors.  Vector
support adds a lot of local register space but vector loads and stores can saturate memory bandwidth and drive up processor
temperature.  We might see earlier adoption in contexts that tolerate higher latency, like firewalls, rather than low-latency
switches and routers.</p>
</blockquote>
<h4 id="explicit-ml-support">explicit ML support</h4>
<p>DPDK includes ML contributions from Marvell.  See <code>doc/guides/mldevs/cnxk.rst</code> for more information and references to the cnxk support.
Source code support exists under <code>drivers/ml/cnxk</code> and <code>lib/mldev</code>.  <code>lib/mldev/rte_mldev.c</code> may provide some insight into how
Marvell expects DPDK users to apply their component.
See the Marvell Octeon 10 <a href="https://www.marvell.com/content/dam/marvell/en/public-collateral/embedded-processors/marvell-octeon-10-dpu-platform-white-paper.pdf">white paper</a> for some possible applications.</p>
<h3 id="ghidra-analysis">Ghidra analysis</h3>
<p>The DPDK exemplars stress test Ghidra in multiple ways:</p>
<ul>
<li>When compiled with RISCV-64 vector and bit manipulation extension support you get a good mix of autovectorization instructions.</li>
<li>There are a number of unsupported thread-local relocations requested</li>
<li>ELF replication failures are reported for <code>R_RISCV_COPY</code>, claiming &ldquo;Runtime copy is not supported&rdquo;.
<ul>
<li>this relocation code apparently asks for a symbol to be copied from a shareable object into an executable.</li>
</ul>
</li>
</ul>

</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2023&ndash;2024
    <span class="td-footer__authors">Thixotropist | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span><span class="ms-2"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/ghidra_import_tests/js/main.js"></script>
<script defer src="/ghidra_import_tests/js/click-to-copy.js" crossorigin="anonymous"></script>
<script src='/ghidra_import_tests/js/tabpane-persist.js'></script>

  </body>
</html>
