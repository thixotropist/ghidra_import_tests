<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="canonical" type="text/html" href="https://thixotropist.github.io/ghidra_import_tests/docs/notes/">
<link rel="alternate" type="application/rss&#43;xml" href="https://thixotropist.github.io/ghidra_import_tests/docs/notes/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/ghidra_import_tests/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/ghidra_import_tests/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/ghidra_import_tests/favicons/android-192x192.png" sizes="192x192">

<title>Notes | Ghidra Import Testing</title>
<meta name="description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins.">
<meta property="og:url" content="https://thixotropist.github.io/ghidra_import_tests/docs/notes/">
  <meta property="og:site_name" content="Ghidra Import Testing">
  <meta property="og:title" content="Notes">
  <meta property="og:description" content="Put unstructured comments here until we know what to do with them.
TODO Update the isa_ext Ghidra branch to expand vsetvli arguments vsetvli zero,zero,0xc5 ⇒ vsetvli	zero,zero,e8,mf8,ta,ma vsetvli zero,zero,0x18 ⇒ vsetvli	zero,zero,e64,m1,tu,mu Determine why the isa_ext Ghidra branch fails to disassemble the bext instruction in b-ext-64.o and b-ext.o that regression was do to an accidental typo Determine why zvbc.o won’t disassemble These are compressed (16 bit) vector multiply instructions not currently defined in isa_ext Determine why unknown.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="website">

  <meta itemprop="name" content="Notes">
  <meta itemprop="description" content="Put unstructured comments here until we know what to do with them.
TODO Update the isa_ext Ghidra branch to expand vsetvli arguments vsetvli zero,zero,0xc5 ⇒ vsetvli	zero,zero,e8,mf8,ta,ma vsetvli zero,zero,0x18 ⇒ vsetvli	zero,zero,e64,m1,tu,mu Determine why the isa_ext Ghidra branch fails to disassemble the bext instruction in b-ext-64.o and b-ext.o that regression was do to an accidental typo Determine why zvbc.o won&rsquo;t disassemble These are compressed (16 bit) vector multiply instructions not currently defined in isa_ext Determine why unknown.">
  <meta itemprop="dateModified" content="2024-03-08T08:16:34-05:00">
  <meta itemprop="wordCount" content="273"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Notes">
<meta name="twitter:description" content="Powerful, extensible, and feature-packed frontend toolkit. Build and customize with Sass, utilize prebuilt grid system and components, and bring projects to life with powerful JavaScript plugins.">




<link rel="preload" href="/ghidra_import_tests/scss/main.min.d7828a63be699f877d0f40d15fbb8ba8375c451530782351367eff6e43fbf1b2.css" as="style">
<link href="/ghidra_import_tests/scss/main.min.d7828a63be699f877d0f40d15fbb8ba8375c451530782351367eff6e43fbf1b2.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/ghidra_import_tests/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">Ghidra Import Testing</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/ghidra_import_tests/about/"><span>About</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="/ghidra_import_tests/docs/"><span>Docs</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/ghidra_import_tests/docs/notes/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Notes</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-219885af892566c9bd30c77d9270a0dc">Hardware Availability</a></li>


    
  
    
    
	
<li>2: <a href="#pg-11f98830a63a9bc25c2bc8239212c99f">Network Appliances</a></li>


    
  
    
    
	
<li>3: <a href="#pg-6b7b30f5489c07a9a0381508ed048f39">A vectorization case study</a></li>


    
  
    
    
	
<li>4: <a href="#pg-3a91620b69f843cc0ecd1d5560adadf5">Pcode testing</a></li>


    
  
    
    
	
<li>5: <a href="#pg-6f0fcd5d8c6b80f713f332dab5590581">Tracking Convergence</a></li>


    
  
    
    
	
<li>6: <a href="#pg-f22421eca6cb396b0451315422c932fa">Deep Dive Openssl</a></li>


    
  
    
    
	
<li>7: <a href="#pg-61d8d612fe445078900e0844403305ae">Building a gcc-14 toolchain</a></li>


    
  

    </ul>


<div class="content">
      

<div class="pageinfo pageinfo-primary">
<p>Put unstructured comments here until we know what to do with them.</p>

</div>

<h2 id="todo">TODO</h2>
<ul>
<li><input disabled="" type="checkbox"> Update the <code>isa_ext</code> Ghidra branch to expand <code>vsetvli</code> arguments
<ul>
<li><code>vsetvli zero,zero,0xc5</code> ⇒ <code>vsetvli	zero,zero,e8,mf8,ta,ma</code></li>
<li><code>vsetvli zero,zero,0x18</code> ⇒ <code>vsetvli	zero,zero,e64,m1,tu,mu</code></li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> Determine why the <code>isa_ext</code> Ghidra branch fails to disassemble the <code>bext</code> instruction in <code>b-ext-64.o</code> and <code>b-ext.o</code>
<ul>
<li>that regression was do to an accidental typo</li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> Determine why <code>zvbc.o</code> won&rsquo;t disassemble
<ul>
<li>These are compressed (16 bit) vector multiply instructions not currently defined in <code>isa_ext</code></li>
</ul>
</li>
<li><input checked="" disabled="" type="checkbox"> Determine why <code>unknown.o</code> won&rsquo;t disassemble or reference where we found these instructions
<ul>
<li>These instructions include <code>sfence``, </code>hinval_vvma<code>, </code>hinval_gvma<code>, </code>orc.b<code>, </code>cbo.clean<code>, </code>cbo.inval<code>, </code>cbo.flush<code>. </code>orc.b` is handled properly, the others are not implemented.</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> Clarify python scripts to show more of the directory context</li>
</ul>
<h2 id="experiments">Experiments</h2>
<h3 id="how-much-ghidra-complexity-does-gcc-14-introduce-in-a-full-build">how much Ghidra complexity does gcc-14 introduce in a full build?</h3>
<p>Assume a vendor generates a new toolchain with multiple extensions enabled by default.  What fraction of the compiled functions would
contain extensions unrecognized by Ghidra 11.0?  Since THead has supplied most of the vendor-specific extensions known to binutils 2-41,
we&rsquo;ll use that as a reference.  The architecture name will be something like</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>-march=rv64gv_zba_zbb_zbc_zbkb_zbkc_zbkx_zvbc_xtheadba_xtheadbb_xtheadbs_xtheadcmo_xtheadcondmov_xtheadmac_xtheadfmemidx_xtheadmempair_xtheadsync
</span></span></code></pre></div><p>Add some C++ code to exercise libstdc++ ordered maps (based on red-black trees?), unordered maps (hash table based), and the Murmur hash function.</p>
<p>There are a few places where THead customized instructions are used.  The Murmur hash function uses vector load and store instructions to implement 8 byte unaligned
reads.  Bit manipulation extension instructions are not yet used.</p>
<p>Initial results suggest the largest complexity impact will be gcc rewriting of memory and structure copies with vector code.  This may be
especially true for hardware requiring aligned integers where alignment can not be guaranteed.</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-219885af892566c9bd30c77d9270a0dc">1 - Hardware Availability</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>When will RISCV-64 cores be deployed into systems needing reverse-engineering?</p>

</div>

<h2 id="general-purpose-systems">General purpose systems</h2>
<p><a href="https://www.cnx-software.com/2022/11/02/sifive-p670-and-p470-risc-v-processors-add-risc-v-vector-extensions/">https://www.cnx-software.com/2022/11/02/sifive-p670-and-p470-risc-v-processors-add-risc-v-vector-extensions/</a></p>
<p><a href="https://www.cnx-software.com/2023/08/30/sifive-unveils-p870-high-performance-core-discusses-future-of-risc-v">https://www.cnx-software.com/2023/08/30/sifive-unveils-p870-high-performance-core-discusses-future-of-risc-v</a></p>
<p><a href="https://github.com/riscv/riscv-profiles/blob/main/rva23-profile.adoc">https://github.com/riscv/riscv-profiles/blob/main/rva23-profile.adoc</a></p>
<p><a href="https://www.scmp.com/tech/tech-trends/article/3232686/chinas-top-chip-designers-form-risc-v-patent-alliance-promote-semiconductor-self-sufficiency">https://www.scmp.com/tech/tech-trends/article/3232686/chinas-top-chip-designers-form-risc-v-patent-alliance-promote-semiconductor-self-sufficiency</a></p>
<blockquote>
<p>Note: the general SiFive SDK boards might have been deprioritized in favor of specific licensing agreements.
<a href="https://www.sifive.com/boards/hifive-pro-p550">https://www.sifive.com/boards/hifive-pro-p550</a></p>
</blockquote>
<p><a href="https://liliputing.com/sifive-hifive-pro-p550-dev-board-coming-this-summer-with-intel-horse-creek-risc-v-chip/">https://liliputing.com/sifive-hifive-pro-p550-dev-board-coming-this-summer-with-intel-horse-creek-risc-v-chip/</a></p>
<p>We might expect to see high performance network appliances in 2026 using chip architectures like the SiFive 670 or 870,
or from one of the alternative Chinese vendors.  Chips with vector extensions are due soon, with crypto extensions coming shortly after.
A network appliance development board might have two P670 class sockets and four to eight 10 GbE network interfaces.</p>
<p>To manage scope, we won&rsquo;t be worrying about instructions supporting AI or complex virtualization.  Custom instructions that might be used
in network appliances are definitely in scope, while custom instructions for nested virtualization are not.  Possibly in scope are new instructions
that help manage or synchronize multi-socket cache memory.</p>
<p>Let&rsquo;s set a provocative long term goal: How will Ghidra analyze a future network appliance that combines Machine Learning with self-modifying code
to accelerate network routing and forwarding?  Such a device might generate fast-path code sequences to sessionize incoming packets and deliver them with
minimal cache flushes or branches taken.</p>
<p>A RISCV-64 implementation of the Marvell Octeon 10 might be a feasible future hardware component.</p>
<h2 id="portable-appliances">Portable appliances</h2>
<p>This might include cell phones or voice-recognition apps.  Things that today might use an Arm core set but be implemented with RISC-V cores in the future.</p>
<h2 id="role-of-mixed-32-and-64-bit-cores">role of mixed 32 and 64 bit cores</h2>
<p>Consider a midpoint network appliance (router or firewall) sitting near the Provider-Customer demarcation.  What might be an appealing RISCV processor look like?
This kind of appliance likely handles a mix of link layer protocols with an optimization for low energy dissipation and low latency per packet.  A fast and simple
serializer/deserializer feeding a RISCV classifier and forwarding engine makes sense here.  You don&rsquo;t want to do network or application layer processing unless the appliance
has a firewall role.</p>
<p>Link layer processing means a packet mix of stacked MPLS and VLAN tags with IPv4 and IPv6 network layers underneath.  Packet header processing won&rsquo;t need 32 bit addressing,
but might benefit from the high memory bandwidth of a 64 bit core.  Fast header hashing combined with fast hashmap session lookups (for MPLS, VLAN, and selected IP) or
fast trie session lookups (for IPv4 and IPv6).  Network stacks can have a lot of branches, creating pipeline stalls, so hyperthreading may make sense.</p>
<p>Denial of Service and overload protections make fast analytics necessary at the session level.  That&rsquo;s where a 64 bit core with vector and other extensions can be useful.</p>
<p>This all suggests we might see more hybrid RISCV designs, with a mix of many lean 32 bit cores supported by one or two 64 bit cores.  The 32 bit cores handle fast link layer processing
and the 64 bit cores handle background analytics and control.</p>
<p>In the extreme case, the 64 bit analytics engine rewrites link layer code for the 32 bit cores continuously, optimizing code paths depending on what the link layer classifiers
determine the most common packet types to be for each physical port.  Cache management and branch prediction hints might drive new instruction additions.</p>
<p>Code rewriting could start as simple updates to RISCV hint branch instructions and possibly prefetch instructions, so it isn&rsquo;t necessarily as radical as it sounds.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-11f98830a63a9bc25c2bc8239212c99f">2 - Network Appliances</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>What will RISCV-64 cores offer networking?</p>

</div>

<h2 id="will-vector-instructions-be-useful-in-network-appliances">will vector instructions be useful in network appliances?</h2>
<p>Network kernel code has lots of conditional branches and very few loops.  This suggests RISCV vector instructions won&rsquo;t be
found in network appliances anytime soon, other than <code>memmove</code> or similar simple contexts.  Gather-scatter, bit manipulation, and
crypto instruction extensions are likely to be useful in networking much sooner.  Ghidra will have a much easier time generating
pcode for those instructions than the 25K+ RISCV vector intrinsic C functions covering all combinations of vector instructions and
vector processing modes.</p>
<p>What should Ghidra do when faced with a counter-example, say a network appliance that aggressively moves vector analytics into network processing?
Such an appliance - perhaps a smart edge router or a zero-trust gateway device - might combine the following:</p>
<ul>
<li>64 RISCV cores with no floating point or vector capability, optimized for traditional network ingress processing.  These cores are
designed to cope with the many branches of network packet processing, possibly including better branch prediction and hyperthreading.</li>
<li>2 or more RISCV cores with full floating point and vector capability, optimized for performing analytics on the inbound packet stream.
These analytics can range from simple statistics generation to heuristic sessionization to self-modifying code generation.
The self-modifying code may be either eBPF code or native RISCV instructions, depending on how aggressive the designers may be.</li>
</ul>
<p>In the extreme case, this might be a generative AI subsystem trained on inbound packets and emitting either optimized packet handling code or
threat-detection indicators.  How would a Ghidra analyst look for malware in such a system?</p>
<h3 id="midpoint-versus-endpoint-network-appliances">midpoint versus endpoint network appliances</h3>
<p>We need to be clearer about what kind of network code we might find in different contexts:</p>
<ul>
<li>midpoint equipment like network-edge routers and switches, optimized for maximum throughput</li>
<li>endpoint equipment like host computers, web servers, and database servers where applications take up the bulk of the CPU cycles</li>
</ul>
<p>For each of these contexts we have at least two topology variants:</p>
<ul>
<li>Inline network code through which packets must transit, generally optimized for low latency and high throughput</li>
<li>Tapped network code (e.g., wireshark or port-mirrored accesses) observing copies of packets for session and endpoint analytics.
Latency is not an issue here.</li>
</ul>
<p>Midpoint network appliances may need to track session state.  A simple network switch is close to stateless.  A real-world network switch
has a lot of session state to manage if it supports:</p>
<ul>
<li>denial of service overload detection or other flow control</li>
<li>link bonding or equal-weight multipath routing</li>
</ul>
<p>The key point here is that midpoint network appliances may benefit from instruction set extensions that enable faster packet classification, hashing, and cached session lookup.
An adaptive midpoint network appliance might adjust the packet classification code in real-time, based on the mix of MPLS, VLAN, IPv4, IPv6, and VPN traffic most often seen on
any given network interface.  ISA extensions supporting gather, hash, vector comparison, and find-first operations are good candidates here.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6b7b30f5489c07a9a0381508ed048f39">3 - A vectorization case study</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Compare and debug human and gcc vectorization</p>

</div>

<p>This case study compares human and compiler vectorization of a simple ML quantization algorithm.  We&rsquo;ll assume we need to inspect the code to understand why these two
binaries sometimes produce different results.  Our primary goal is to see whether we can improve Ghidra&rsquo;s RISCV pcode generation to make such analyses easier.  A  secondary
goal is to collect generated instruction patterns that may help Ghidra users understand what optimizing vectorizing compilers can do to source code.</p>
<p>The ML algorithm under test comes from <a href="https://github.com/ggerganov/llama.cpp">https://github.com/ggerganov/llama.cpp</a>.  It packs an array of 32 bit floats into a set of q8_0 blocks to condense large
model files.  The q8_0 quantization reduces 32 32 bit floating point numbers to 32 8 bit integers with an associated 16 bit floating point scale factor.</p>
<p>The <code>ggml-quants.c</code> file in the <code>llama.cpp</code> repo provides both scalar source code (<code>quantize_row_q8_0_reference</code>) and hand-generated vectorized source code (<code>quantize_row_q8_0</code>).</p>
<ul>
<li>The <code>quantize_row_q8_0</code> function has several <code>#ifdef</code> sections providing hand-generated vector intrinsics for riscv, avx2, arm/neon, and wasm.</li>
<li>The <code>quantize_row_q8_0_reference</code> function source uses more loops but no vector instructions.  GCC-14 will autovectorize the scalar <code>quantize_row_q8_0_reference</code>,
producing vector code that is quite different from the hand-generated vector intrinsics.</li>
</ul>
<p>The notional AI development shop wants to use Ghidra to inspect generated assembly instructions for both <code>quantize_row_q8_0</code> and <code>quantize_row_q8_0_reference</code> to track down
reported quirks.  On some systems they produce identical results, on others the results differ.  The test framework includes:</p>
<ul>
<li>A target RISCV-64 processor supporting vector and compressed instructions.</li>
<li>GCC-14 developmental (pending release) compiler toolchain for native x86_64 builds</li>
<li>GCC-14 developmental (pending release) RISCV-64 cross-compiler toolchain with standard options <code>-march=rv64gcv</code>, <code>-O3</code>, and <code>-ffast-math</code>.</li>
<li><code>qemu-riscv64-static</code> emulated execution of user space RISCV-64 applications on an x86_64 Linux test server.</li>
<li>A generic unit testing framework like <code>gtest</code>.</li>
<li>Ghidra 11+ with the <code>isa_ext</code> branch supporting  RISCV 1.0 vector instructions.</li>
</ul>
<p>The unit test process involves three unit test executions:</p>
<ul>
<li>a reference x86_64 execution to test the logic on a common platform.</li>
<li>within a <code>qemu-riscv64-static</code> environment with an emulated VLEN=256 bits</li>
<li>within a <code>qemu-riscv64-static</code> environment with an emulated VLEN=128 bits</li>
</ul>
<blockquote>
<p>Note: This exercise uses whisper C and C++ source code as &lsquo;ground truth&rsquo;, coupled with a C++ test framework.
If we didn&rsquo;t have source code, we would have to reconstruct key library source files based
on Ghidra inspection, then refine those reconstructions until Ghidra and unit testing shows that our
reconstructions behave the same as the original binaries.</p>
</blockquote>
<p>As setup to the Ghidra inspection, we will build and run all three and expect
to see three PASSED notifications:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel run -platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:x86_64 case_studies:unitTests
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">INFO: Analyzed target //case_studies:unitTests (0 packages loaded, 0 targets configured).
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Found 1 target...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Target //case_studies:unitTests up-to-date:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  bazel-bin/case_studies/unitTests
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Elapsed time: 21.065s, Critical Path: 20.71s
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: 37 processes: 2 internal, 35 linux-sandbox.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Build completed successfully, 37 total actions
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Running command line: bazel-bin/case_studies/unitTests
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] Running 2 tests from 1 test suite.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] Global test environment set-up.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32Reference
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32Reference (0 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32VectorIntrinsics
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32VectorIntrinsics (0 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16 (0 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">[----------] Global test environment tear-down
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] 2 tests from 1 test suite ran. (0 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  PASSED  ] 2 tests.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> bazel build --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector case_studies:unitTests
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector --define <span style="color:#000">__riscv_v_intrinsics</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span> case_studies:unitTests
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">WARNING: Build option --platforms has changed, discarding analysis cache (this can be expensive, see https://bazel.build/advanced/performance/iteration-speed).
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Analyzed target //case_studies:unitTests (0 packages loaded, 1904 targets configured).
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Found 1 target...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Target //case_studies:unitTests up-to-date:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  bazel-bin/case_studies/unitTests
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Elapsed time: 22.265s, Critical Path: 22.07s
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: 37 processes: 2 internal, 35 linux-sandbox.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Build completed successfully, 37 total actions
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> <span style="color:#204a87">export</span> <span style="color:#000">QEMU_CPU</span><span style="color:#ce5c00;font-weight:bold">=</span>rv64,zba<span style="color:#ce5c00;font-weight:bold">=</span>true,zbb<span style="color:#ce5c00;font-weight:bold">=</span>true,v<span style="color:#ce5c00;font-weight:bold">=</span>true,vlen<span style="color:#ce5c00;font-weight:bold">=</span>256,vext_spec<span style="color:#ce5c00;font-weight:bold">=</span>v1.0,rvv_ta_all_1s<span style="color:#ce5c00;font-weight:bold">=</span>true,rvv_ma_all_1s<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> qemu-riscv64-static -L /opt/riscvx -E <span style="color:#000">LD_LIBRARY_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx/riscv64-unknown-linux-gnu/lib/ bazel-bin/case_studies/unitTests
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] Running 2 tests from 1 test suite.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] Global test environment set-up.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32Reference
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32Reference (1 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32VectorIntrinsics
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32VectorIntrinsics (0 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16 (2 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">[----------] Global test environment tear-down
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] 2 tests from 1 test suite ran. (6 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  PASSED  ] 2 tests.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Target //case_studies:unitTests up-to-date:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  bazel-bin/case_studies/unitTests
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Elapsed time: 8.984s, Critical Path: 8.88s
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: 29 processes: 2 internal, 27 linux-sandbox.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Build completed successfully, 29 total actions
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> <span style="color:#000">QEMU_CPU</span><span style="color:#ce5c00;font-weight:bold">=</span>rv64,zba<span style="color:#ce5c00;font-weight:bold">=</span>true,zbb<span style="color:#ce5c00;font-weight:bold">=</span>true,v<span style="color:#ce5c00;font-weight:bold">=</span>true,vlen<span style="color:#ce5c00;font-weight:bold">=</span>256,vext_spec<span style="color:#ce5c00;font-weight:bold">=</span>v1.0,rvv_ta_all_1s<span style="color:#ce5c00;font-weight:bold">=</span>true,rvv_ma_all_1s<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> qemu-riscv64-static -L /opt/riscvx -E <span style="color:#000">LD_LIBRARY_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx/riscv64-unknown-linux-gnu/lib/ bazel-bin/case_studies/unitTests
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] Running 2 tests from 1 test suite.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] Global test environment set-up.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32Reference
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32Reference (1 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32VectorIntrinsics
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32VectorIntrinsics (0 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16 (2 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">[----------] Global test environment tear-down
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] 2 tests from 1 test suite ran. (6 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  PASSED  ] 2 tests.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#8f5902">$</span> <span style="color:#204a87">export</span> <span style="color:#000">QEMU_CPU</span><span style="color:#ce5c00;font-weight:bold">=</span>rv64,zba<span style="color:#ce5c00;font-weight:bold">=</span>true,zbb<span style="color:#ce5c00;font-weight:bold">=</span>true,v<span style="color:#ce5c00;font-weight:bold">=</span>true,vlen<span style="color:#ce5c00;font-weight:bold">=</span>128,vext_spec<span style="color:#ce5c00;font-weight:bold">=</span>v1.0,rvv_ta_all_1s<span style="color:#ce5c00;font-weight:bold">=</span>true,rvv_ma_all_1s<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> qemu-riscv64-static -L /opt/riscvx -E <span style="color:#000">LD_LIBRARY_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx/riscv64-unknown-linux-gnu/lib/ bazel-bin/case_studies/unitTests
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] Running 2 tests from 1 test suite.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] Global test environment set-up.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32Reference
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] FP16.convertFromFp32Reference (1 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] FP16.convertFromFp32VectorIntrinsics
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">case_studies/unitTests.cpp:55: Failure
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Expected equality of these values:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  dest[0].d
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    Which is: 12175
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  fp16_test_array.d
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    Which is: 13264
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">fp16 scale factor is correct
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">case_studies/unitTests.cpp:57: Failure
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">Expected equality of these values:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  comparison
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    Which is: -65
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">  0
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">entire fp16 block is converted correctly
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  FAILED  ] FP16.convertFromFp32VectorIntrinsics (8 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 2 tests from FP16 (10 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">[----------] Global test environment tear-down
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] 2 tests from 1 test suite ran. (14 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  PASSED  ] 1 test.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  FAILED  ] 1 test, listed below:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  FAILED  ] FP16.convertFromFp32VectorIntrinsics
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic"> 1 FAILED TEST
</span></span></span></code></pre></div><p>These results imply:</p>
<ul>
<li>The hand-vectorized <code>quantize_row_q8_0</code> test passes on harts with VLEN=256 but fails when
executed on harts with VLEN=128.  Further tracing suggests that <code>quantize_row_q8_0</code> only processes the
first 16 floats, not the 32 floats that should be processed in each block.</li>
<li>The gcc autovectorized <code>quantize_row_q8_0_reference</code> passes on both types of harts.</li>
</ul>
<p>Now we need to import the riscv-64 <code>unitTests</code> program into Ghidra and examine the compiled differences between
<code>quantize_row_q8_0</code> and <code>quantize_row_q8_0_reference</code>.</p>
<blockquote>
<p>Note: Remember that our real integration test goal is to look for new problems or regressions in Ghidra&rsquo;s
decompiler presentation of functions like these, and then to look for ways to improve that presentation.</p>
</blockquote>
<h2 id="original-source-code">Original Source Code</h2>
<p>The goal of both <code>quantize_row_q8_0*</code> routines is a lossy compression of 32 bit floats into blocks of 8 bit scaled values.
The routines should return identical results, with <code>quantize_row_q8_0</code> invoked on architectures with vector acceleration
and <code>quantize_row_q8_0_reference</code> for all other architectures.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">QK8_0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// reference implementation for deterministic creation of model files
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">quantize_row_q8_0_reference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">QK8_0</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nb</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">amax</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0f</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// absolute max
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">QK8_0</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">amax</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MAX</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">amax</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fabsf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">amax</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#0000cf;font-weight:bold">1.0f</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f57900">d</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.0f</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">GGML_FP32_TO_FP16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">x0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">QK8_0</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">roundf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">quantize_row_q8_0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">QK8_0</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">QK8_0</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">restrict</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#if defined(__ARM_NEON)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#elif defined(__wasm_simd128__)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#elif defined(__AVX2__) || defined(__AVX__)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#elif defined(__riscv_v_intrinsic)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">vl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vsetvl_e32m4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nb</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// load elements
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vfloat32m4_t</span> <span style="color:#000">v_x</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vle32_v_f32m4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">QK8_0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vfloat32m4_t</span> <span style="color:#000">vfabs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfabs_v_f32m4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v_x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vfloat32m1_t</span> <span style="color:#000">tmp</span>   <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfmv_v_f_f32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0.0f</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vfloat32m1_t</span> <span style="color:#000">vmax</span>  <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfredmax_vs_f32m4_f32m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vfabs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">amax</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfmv_f_s_f32m1_f32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vmax</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">amax</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#0000cf;font-weight:bold">1.0f</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#f57900">d</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.0f</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">GGML_FP32_TO_FP16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vfloat32m4_t</span> <span style="color:#000">x0</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfmul_vf_f32m4</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v_x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// convert to integer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">vint16m2_t</span>   <span style="color:#000">vi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vfncvt_x_f_w_i16m2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">vint8m1_t</span>    <span style="color:#000">vs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">__riscv_vncvt_x_x_w_i8m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vi</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// store result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">__riscv_vse8_v_i8m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span> <span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">GGML_UNUSED</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// scalar
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">quantize_row_q8_0_reference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The reference version has an outer loop iterating over scalar 32 bit floats, with two inner loops operating on blocks of 32
of those floats.  The first inner loop accumulates the maximum of absolute values within the block to generate a scale factor,
while the second inner loop applies that scale factor to each 32 bit float in the block and then converts the scaled value to an 8 bit integer.
Each output block is then a 16 bit floating point scale factor plus 32 8 bit scaled integers.</p>
<p>The code includes some distractions that complicate Ghidra analysis:</p>
<ul>
<li>The k input parameter is signed, making the integer division by 32 more complicated than it needs to be.</li>
<li>The <code>GGML_FP32_TO_FP16(d)</code> conversion might be a single instruction on some architectures, but it requires branch evaluation
on our RISCV-64 target architecture.  GCC may elect to duplicate code in order to minimize the number of branches needed.</li>
</ul>
<p>The hand-optimized <code>quantize_row_q8_0</code> has similar distractions, plus a few more:</p>
<ul>
<li>The two inner loops have been converted into RISCV vector intrinsics, such that each iteration processes 32 4 byte floats into
a single 34 byte <code>block_q8_0</code> struct.</li>
<li>Four adjacent vector registers are grouped with the <code>m4</code> setting.  On architectures with a vector length VLEN=256, that means
all 32 4 byte floats per block will fit nicely and can be processed in parallel.  If the architecture only supports a vector length of
VLEN=128, then only half of each block will be processed in every iteration.  That accounts for the unit test failure.</li>
<li>The code uses standard riscv_intrinsics - of which there are nearly 40,000 variants.  The root of each intrinsic is generally a
single vector instruction, then extended with information on the expected vector context (from vset* instructions) and the expected
return type of the result.  There is no C header file providing signatures for all possible variants, so nothing Ghidra can import
and use in the decompiler view.</li>
<li>The <code>__riscv_vle32_v_f32m4</code> intrinsic is likely the slowest of the set, as this 32 bit instruction will require a 128 byte memory read,
stalling the instruction pipeline for some number of cycles.</li>
</ul>
<h2 id="ghidra-inspection">Ghidra inspection</h2>
<h3 id="inspecting-the-hand-vectorized-quantizer">inspecting the hand-vectorized quantizer</h3>
<p>Load <code>unitTest</code> into Ghidra and inspect <code>quantize_row_q8_0</code>.  We know the correct signature so we can override what Ghidra has inferred,
then name the parameters so that they look more like the source code.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">quantize_row_q8_0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">block_q0_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">fVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pcVar3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uint</span> <span style="color:#000">uVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iVar6</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ulong</span> <span style="color:#000">uVar7</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar8</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar9</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar10</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsetvli_e8m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x106c50</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">iVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(((</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1f</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span><span style="color:#000;font-weight:bold">(</span> <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli_e32m4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfredmax_vs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmv_fs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">fVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar8</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">0.007874016</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">fVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">fVar1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#0000cf;font-weight:bold">127.0</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar8</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0xff000001</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">uVar7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli_e16m2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">((</span><span style="color:#000">block_q0_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x7e00</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfncvt_xfw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli_e8m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x22</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iVar2</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">iVar6</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">uVar7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16m2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfncvt_xfw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xfff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">((</span><span style="color:#000">block_q0_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">short</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x22</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">iVar2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><blockquote>
<p>Note: an earlier run showed several pcode errors in <code>riscv-rvv.sinc</code>, which have been fixed as of this run.</p>
</blockquote>
<p>Red herrings - none of these have anything to do with RISCV or vector intrinsics</p>
<ul>
<li><code>uVar5 = 0x106c50;</code> - there is no uVar5 variable, just a shared upper immediate load register.</li>
<li><code>iVar2 = (int)(((uint)((int)k &gt;&gt; 0x1f) &gt;&gt; 0x1b) + (int)k) &gt;&gt; 5;</code> - since k is a signed long and not unsigned, the compiler
has to implement the divide by 32 with rounding adjustments for negative numbers.\</li>
<li><code>fVar1 = (float)uVar8 * 0.007874016;</code> - the compiler changed a division by 127.0 into a multiplication by 0.007874016.</li>
<li><code>((block_q0_0 *)(pcVar3 + -2))-&gt;d</code> - the compiler has set pcVar3 to point to an element within the block, so it uses negative
offsets to address preceding elements.</li>
<li>duplicate code blocks - the conversion from a 32 bit float to the 16 bit float involves some branches.  The compiler has decided
that duplicating following code for at least one branch will be faster.</li>
<li>Decompiler handling of <code>fmv.x.w</code> instructions looks odd. fmv.x.w moves the single-precision value in ﬂoating-point register rs1
represented in IEEE 754-2008 encoding to the lower 32 bits of integer register rd.  This works fine when the source
is zero, but it has no clear C-like representation otherwise.  These may better be replaced with specialized pcode operations.</li>
</ul>
<p>There is one discrepancy that does involve the vectorization code.  The source code uses a standard RISCV vector intrinsic function
to store data:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">__riscv_vse8_v_i8m1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vl</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>Ghidra pcode for this instruction after renaming operands is (currently):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>The order of the first two parameters is swapped.  We should probably align the pcode to avoid deviations from the
standard intrinsic signature as much as possible.  Those intrinsics have context and type information encoded into their
name, which Ghidra does not currently have, so we can&rsquo;t exactly match.</p>
<h3 id="inspecting-the-auto-vectorized-quantizer">inspecting the auto-vectorized quantizer</h3>
<p>Load <code>unitTest</code> into Ghidra and inspect <code>quantize_row_q8_0_reference</code>.  We know the correct signature so we can override what
Ghidra has inferred, then name the parameters so that they look more like the source code.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">quantize_row_q8_0_reference</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">block_q0_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">fVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">lVar3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pcVar4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ushort</span> <span style="color:#000">uVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iVar6</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">ulong</span> <span style="color:#000">uVar7</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar8</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar9</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar10</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar11</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar12</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar13</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar14</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v7</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar15</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar16</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar17</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar18</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar19</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar15</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmv_sf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0xff800000</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v7</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">lVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar13</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">in_v7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar12</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x30</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x40</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar18</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x50</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar16</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar16</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar16</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar18</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar18</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar16</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar17</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x60</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar16</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x70</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar19</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar17</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar17</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar19</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar19</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfsgnjx_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar16</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar16</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmax_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar19</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfredmax_vs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar15</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">uVar8</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmv_fs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar8</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">0.007874016</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">uVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">fVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fVar1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f57900">LAB_00076992</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">ushort</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xfff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">ushort</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0xd</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x7c00</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar7</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#0000cf;font-weight:bold">127.0</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0x7e00</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0xff000001</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">goto</span> <span style="color:#000">LAB_00076992</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmv_vf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar7</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar13</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar13</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar12</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar12</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar14</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">((</span><span style="color:#000">block_q0_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ushort</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#000">ulong</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">lVar3</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x8000</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">uVar5</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar13</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar14</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar12</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar18</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0xc</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar12</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar13</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar17</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar11</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar11</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x14</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar10</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar10</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x18</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar16</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vfcvt_xfv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e16mf2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iVar6</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e8mf4tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar9</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vncvt_xxw</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vse8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar9</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x1c</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lVar2</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x80</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pcVar4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x22</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(((</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1f</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">iVar6</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span><span style="color:#000;font-weight:bold">(</span> <span style="color:#204a87">true</span> <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Some of the previous red herrings show up here too.  Things to note:</p>
<ul>
<li><code>undefined auVar19 [256];</code> - something in <code>riscv-rvv.sinc</code> is claiming vector registers are 256 bits long - that&rsquo;s not generally
true, so hunt down the confusion.
<ul>
<li><code>riscv.reg.sinc</code> is the root of this, with <code>@define VLEN &quot;256&quot;</code> and <code>define register offset=0x4000 size=$(VLEN) [ v0  ...]</code>.
What should Ghidra believe the size of vector registers to be?  More generally, should the size and element type of vector
registers be mutable?</li>
</ul>
</li>
<li>the autovectorizer has correctly decided VLEN=128 architectures must be supported, and has dedicated 8 vector registers to
hold all 32 floats required per loop iteration.  Unlike the hand-optimized solution, the 8 vector registers are handled
by 8 interleaved sequences of vector instructions.  This roughly doubles the instruction count, but provides good distribution
of load and store memory operations across the loop, likely minimizing execution stalls.</li>
</ul>
<p>RISCV vector instruction execution engines - and autovectorization passes in gcc - are both so immature we have no idea of which
implementation performs better.  At best we can guess that autovectorization will be good enough to make hand optimized coding
with riscv intrinsic functions rarely needed.</p>
<h2 id="vectorized-function-analysis-without-source-code">Vectorized function analysis without source code</h2>
<p>Now try using Ghidra to inspect a function that dominates execution time in the whisper.cpp demo - <code>ggml_vec_dot_16</code>.  We&rsquo;ll do this
without first checking the source code.  We&rsquo;ll make a few reasonable assumptions:</p>
<ul>
<li>this is likely a vector dot product</li>
<li>the vector elements are 16 bit floating point values of the type we&rsquo;ve seen already.</li>
</ul>
<p>A quick inspection lets us rewrite the function signature as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">ggml_vec_dot_f16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sum</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">fp16</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">fp16</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{...}</span>
</span></span></code></pre></div><p>That quick inspection also shows a glaring error - the pcode semantics for <code>vluxei64.v</code> has left out a critical parameter.  It&rsquo;s present in the
listing view but missing in the pcode semantics view.  Fix this and move on.</p>
<p>After tinkering with variable names and signatures, we get:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">ggml_vec_dot_q8_0_q8_0</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sum</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">pbVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iVar2</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">px_qs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">py_qs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">partial_sum</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar5</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar6</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v5</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">gp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">__global_pointer</span><span style="color:#a40000">$</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">partial_sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0.0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uVar4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vsetvli_e8m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x20</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0x1f</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">px_qs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">py_qs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">qs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vsetvli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vmv_v_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v5</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">pbVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">px_qs</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli_e8m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">uVar4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar6</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">px_qs</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle8_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">py_qs</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vwmul_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetvli_e16m2tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">auVar5</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vwredsum_vs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar5</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">in_v5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">vsetivli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">uVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vmv_x_s</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">iVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">iVar2</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">px_qs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">px_qs</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x22</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">partial_sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar3</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ggml_table_f32_f16</span><span style="color:#000;font-weight:bold">)[((</span><span style="color:#000">block_q8_0</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">py_qs</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">field0_0x0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">*</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ggml_table_f32_f16</span><span style="color:#000;font-weight:bold">)[</span><span style="color:#000">pbVar1</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">field0_0x0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">partial_sum</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">py_qs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">py_qs</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x22</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">iVar2</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)(((</span><span style="color:#000">uint</span><span style="color:#000;font-weight:bold">)((</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1f</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">0x1b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">partial_sum</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>That&rsquo;s fairly clear - the two vectors are presented as arrays of <code>block_q8_0</code> structs, each with
32 entries and a scale factor <code>d</code>.  An earlier run showed another error, now fixed, with the pcode for
<code>vmv_x_s</code>.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3a91620b69f843cc0ecd1d5560adadf5">4 - Pcode testing</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Ghidra testing of semantic pcode.</p>

</div>

<blockquote>
<p>Note: paths and names are likely to change here.  Use these notes just as a guide.</p>
</blockquote>
<p>The Ghidra 11 <code>isa_ext</code> branch makes heavy use of user-defined pcode (aka Sleigh semantics).  Much of that pcode is arbitrarily defined, adding more confusion to an
already complex field.  Can we build a testing framework to highlight problem areas in pcode semantics?</p>
<p>For example, let&rsquo;s look at Ghidra&rsquo;s decompiler rendering of two RISCV-64 vector instructions <code>vmv.s.x</code> and <code>vmv.x.s</code>.  These instructions move a single element between an
integer scalar register and the first element of a vector register.  The <a href="https://github.com/riscv/riscv-v-spec/blob/master/v-spec.adoc">RISCV</a>
vector definition says:</p>
<ul>
<li>The vmv.x.s instruction copies a single SEW-wide element from index 0 of the source vector register to a destination integer register.</li>
<li>The vmv.s.x instruction copies the scalar integer register to element 0 of the destination vector register.</li>
</ul>
<p>These instructions have a lot of symmetry, but the current isa_ext branch doesn&rsquo;t render them symmetrically.  Let&rsquo;s build a sample function
that uses both instructions followed by an assertion of what we expect to see.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">test_integer_scalar_vector_move</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">///@ exercise integer scalar moves into and out of a vector register
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// set vector mode to something simple
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__asm__</span> <span style="color:#000">__volatile__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;vsetivli zero,1,e32,m1,ta,ma</span><span style="color:#4e9a06">\n\t</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// execute both instructions to set y:= x
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">__asm__</span> <span style="color:#000">__volatile__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;vmv.s.x  v1, %1</span><span style="color:#4e9a06">\n\t</span><span style="color:#4e9a06">&#34;</span> <span style="color:#4e9a06">&#34;vmv.x.s  %0, v1&#34;</span>\
</span></span><span style="display:flex;"><span>                          <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;=r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span> \
</span></span><span style="display:flex;"><span>                          <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;r&#34;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">x</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This function should return the boolean value True.  It&rsquo;s defined in the file <code>failing_tests/pcodeSamples.cpp</code> and
compiled into the library <code>libsamples.so</code>.  The function is executed within the test harness <code>failing_tests/pcodeTests.cpp</code>.</p>
<p>Build (with O3 optimization) and execute the test harness with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel clean
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">INFO: Starting clean (this may take a while). Consider using --async if the clean takes more than several minutes.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> bazel build -s -c opt  --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector failing_tests:samples
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> cp -f bazel-bin/failing_tests/libsamples.so /tmp
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> bazel build -s -c opt  --platforms<span style="color:#ce5c00;font-weight:bold">=</span>//platforms:riscv_vector failing_tests:pcodeTests
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> <span style="color:#204a87">export</span> <span style="color:#000">QEMU_CPU</span><span style="color:#ce5c00;font-weight:bold">=</span>rv64,zba<span style="color:#ce5c00;font-weight:bold">=</span>true,zbb<span style="color:#ce5c00;font-weight:bold">=</span>true,v<span style="color:#ce5c00;font-weight:bold">=</span>true,vlen<span style="color:#ce5c00;font-weight:bold">=</span>128,vext_spec<span style="color:#ce5c00;font-weight:bold">=</span>v1.0,rvv_ta_all_1s<span style="color:#ce5c00;font-weight:bold">=</span>true,rvv_ma_all_1s<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> qemu-riscv64-static -L /opt/riscvx -E <span style="color:#000">LD_LIBRARY_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx/riscv64-unknown-linux-gnu/lib/ bazel-bin/failing_tests/pcodeTests
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] Running 1 test from 1 test suite.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] Global test environment set-up.
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 1 test from VectorMove
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[ RUN      ] VectorMove.vmv_s_x
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[       OK ] VectorMove.vmv_s_x (0 ms)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[----------] 1 test from VectorMove (0 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">[----------] Global test environment tear-down
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[==========] 1 test from 1 test suite ran. (3 ms total)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">[  PASSED  ] 1 test.
</span></span></span></code></pre></div><p>Now import /tmp/libsamples.so into Ghidra and look for test* functions.  The decompilation is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">test_integer_scalar_vector_move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined8</span> <span style="color:#000">uVar1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">in_v1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e32m1tama</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vmv_s_x</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">uVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vmv_x_s</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in_v1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">uVar1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This shows two issues:</p>
<ul>
<li>Ghidra believes vector v1 is 256 bits long, when in fact it is unknown at compile and link time.  That&rsquo;s
probably OK for now, as it provides a hint that this is a vector register.</li>
<li>The treatment of instruction output is inconsistent.  For <code>vmv_s_x</code>, the output is the first element of <code>in_v1</code>.
For <code>vmv_x_s</code>, the output is the scalar register <code>uVar1</code>.  That <em>might</em> be OK, since we don&rsquo;t specify what
happens to other elements of <code>in_v1</code>.</li>
</ul>
<p>The general question raised by this example is how to treat pcode output - as an output parameter or as
a returned result?  The sleigh pcode documentation suggests that parameters are assumed to be input parameters,
with the only output register the one returned by the pcode operation.  A quick glance at the ARM Neon and AARCH64 SVE
vector sleigh files suggests that this is the convention, but perhaps not a requirement.</p>
<p>Let&rsquo;s try adding some more test cases before taking any action.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6f0fcd5d8c6b80f713f332dab5590581">5 - Tracking Convergence</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>We can track external events to plan future integration test effort.</p>

</div>

<p>This project gets more relevant when RISCV-64 processors start appearing in appliances with more instruction set extensions and
with code compiled by newer compiler toolchains.</p>
<p>The project results get easier to integrate if and when more development effort is applied to specific Ghidra components.</p>
<p>This page collects external sites to track for convergence.</p>
<h2 id="toolchains-and-platforms">Toolchains and platforms</h2>
<h3 id="binutils">binutils</h3>
<p>New instruction extensions often appear here as the first public implementation.  Check out the opcodes, aliases, and disassembly
patterns found in the test suite.</p>
<ul>
<li>track the <a href="https://sourceware.org/git/binutils-gdb.git">source</a></li>
<li>inspect <code>git log include/opcode/|grep riscv|head</code></li>
<li>inspect <code>git log gas/testsuite/gas/riscv</code></li>
<li>track updates to the list of <a href="https://sourceware.org/git?p=binutils-gdb.git;a=blob_plain;f=gas/testsuite/gas/riscv/march-help.l;hb=HEAD">supported extensions</a></li>
</ul>
<h4 id="sample-log">sample log</h4>
<ul>
<li>28 Feb 2024 - <a href="mailto:jiawei@iscas.ac.cn">jiawei@iscas.ac.cn</a> added support for Zabha riscv extension (atomic byte and half-word memory ops)</li>
<li>4 Jan 2024 - <a href="mailto:jinma@linux.alibaba.com">jinma@linux.alibaba.com</a> fixed th.vsetvli for T-Head extensions</li>
</ul>
<h3 id="compilers">compilers</h3>
<ul>
<li>track the <a href="git://gcc.gnu.org/git/gcc.git">source</a></li>
<li>inspect <code>git log gcc/testsuite/gcc.target/riscv</code></li>
</ul>
<h4 id="log">log</h4>
<p>Look for commits indicating the stability of vectorization or new compound loop types that now allow auto vectorization.</p>
<h3 id="libraries">libraries</h3>
<ul>
<li>track the <a href="git://sourceware.org/git/glibc.git">glibc source</a></li>
<li>track the <a href="https://github.com/openssl/openssl">openssl source</a></li>
</ul>
<h4 id="log-1">log</h4>
<ul>
<li>glibc
<ul>
<li>Not much specific to RISC-V</li>
</ul>
</li>
<li>openssl (in master, not released as of openssl 3.2)
<ul>
<li><a href="mailto:phoebe.chen@sifive.com">phoebe.chen@sifive.com</a> added vector crypto implementations of AES-CBC mode,  AES-128/192/256-CTR, AES-128/256-XTS</li>
<li><a href="mailto:jerry.shih@sifive.com">jerry.shih@sifive.com</a> added Zvksh support for sm3</li>
</ul>
</li>
</ul>
<h3 id="kernels">kernels</h3>
<ul>
<li>track the <a href="https://github.com/torvalds/linux.git">source</a></li>
<li>inspect <code>git log arch/riscv</code></li>
</ul>
<blockquote>
<p>Note: the Linux kernel just added vector crypto support, derived from the openssl crypto routines.  This <em>appears</em> to mostly
be in support of encrypted file systems.</p>
</blockquote>
<h3 id="system-images">system images</h3>
<ul>
<li>Fedora</li>
<li>Ubuntu</li>
</ul>
<h3 id="cloud-instances">cloud instances</h3>
<ul>
<li><a href="https://www.scaleway.com/en/news/scaleway-launches-its-risc-v-servers-in-the-cloud-a-world-first-and-a-firm-commitment-to-technological-independence/">Scaleway risc-v servers</a>
<ul>
<li>with the T-HEAD TH1520 SoC, 16GB RAM and 128GB</li>
</ul>
</li>
</ul>
<h2 id="riscv-international-wiki">RISCV International Wiki</h2>
<p>The RISCV International wiki <a href="https://wiki.riscv.org/">home page</a> leads to:</p>
<ul>
<li><a href="https://wiki.riscv.org/display/HOME/RISC-V+Specification+Status">Active Specification</a> updates</li>
<li><a href="https://tech.riscv.org/software-ecosystem">Software Ecosystem status</a></li>
</ul>
<h2 id="isa-extensions">ISA Extensions</h2>
<ul>
<li>profiles and individual standards-tracked extensions</li>
<li>vendor-specific extensions</li>
<li>gcc intrinsics</li>
</ul>
<h2 id="applications">Applications</h2>
<ul>
<li>track <a href="https://github.com/ggerganov/whisper.cpp.git">source</a></li>
<li>Look for use of riscv intrinsics with arm/Neon and avx2 equivalents as opposed to allowing compiler autovectorization.</li>
<li>Watch for standardization of 16 bit floating point</li>
</ul>
<h2 id="ghidra">Ghidra</h2>
<h3 id="similar-vector-instruction-suites">similar vector instruction suites</h3>
<p><code>Ghidra/Processors/AARCH64/data/languages/AARCH64sve.sinc</code> defines the instructions used by the AARCH64 Scalable Vector Extensions package.
This suite is similar to the RISCV vector suite in that it is vector register length agnostic.  It was added in March of 2019 and not updated since.</p>
<h3 id="pcode-extensions">pcode extensions</h3>
<p><code>Ghidra/Features/Decompiler/src/decompile/cpp</code> holds much of the existing Ghidra code for system and user defined pcodes.
<code>userop.h</code> and <code>userop.cc</code> look relevant, with <code>caheckman</code> a common contributor.</p>
<h2 id="community">Community</h2>
<ul>
<li><a href="https://riscv.org/">RISCV Organization</a></li>
<li><a href="https://www.reddit.com/r/RISCV/">reddit discussion group</a>
<ul>
<li>new RISCV products are often discussed here.</li>
</ul>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f22421eca6cb396b0451315422c932fa">6 - Deep Dive Openssl</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Openssl configuration for ISA Extensions provides a good example.</p>

</div>

<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#000;font-style:italic">/home2/build_openssl$ ../vendor/openssl/Configure linux64-riscv64 --cross-compile-prefix=/opt/riscvx/bin/riscv64-unknown-linux-gnu- -march=rv64gcv_zkne_zknd_zknh_zvkng_zvksg
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> perl configdata.pm --dump
</span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Command line (with current working directory = .):
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    /usr/bin/perl ../vendor/openssl/Configure linux64-riscv64 --cross-compile-prefix=/opt/riscvx/bin/riscv64-unknown-linux-gnu- -march=rv64gcv_zkne_zknd_zknh_zvkng_zvksg
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Perl information:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    /usr/bin/perl
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    5.38.2 for x86_64-linux-thread-multi
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Enabled features:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    afalgeng
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    apps
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    argon2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    aria
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    asm
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    async
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    atexit
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    autoalginit
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    autoerrinit
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    autoload-config
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    bf
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    blake2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    bulk
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cached-fetch
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    camellia
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    capieng
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cast
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    chacha
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cmac
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cmp
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cms
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    comp
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ct
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    default-thread-pool
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    deprecated
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    des
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dgram
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dh
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    docs
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dsa
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dso
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dtls
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dynamic-engine
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ec
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ec2m
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ecdh
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ecdsa
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ecx
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    engine
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    err
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    filenames
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    gost
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    http
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    idea
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    legacy
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    loadereng
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    makedepend
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    md4
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    mdc2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    module
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    multiblock
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    nextprotoneg
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ocb
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ocsp
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    padlockeng
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    pic
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    pinshared
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    poly1305
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    posix-io
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    psk
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    quic
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    unstable-qlog
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    rc2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    rc4
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    rdrand
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    rfc3779
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    rmd160
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    scrypt
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    secure-memory
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    seed
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    siphash
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    siv
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sm2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sm2-precomp
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sm3
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sm4
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sock
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    srp
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    srtp
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sse2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ssl
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ssl-trace
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    static-engine
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    stdio
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tests
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    thread-pool
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    threads
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ts
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ui-console
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    whirlpool
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1-method
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1_1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1_1-method
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1_2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1_2-method
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tls1_3
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dtls1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dtls1-method
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dtls1_2
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dtls1_2-method
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Disabled features:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    acvp-tests          [cascade]        OPENSSL_NO_ACVP_TESTS
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    asan                [default]        OPENSSL_NO_ASAN
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    brotli              [default]        OPENSSL_NO_BROTLI
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    brotli-dynamic      [default]        OPENSSL_NO_BROTLI_DYNAMIC
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    buildtest-c++       [default]        
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    winstore            [not-windows]    OPENSSL_NO_WINSTORE
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    crypto-mdebug       [default]        OPENSSL_NO_CRYPTO_MDEBUG
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    devcryptoeng        [default]        OPENSSL_NO_DEVCRYPTOENG
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ec_nistp_64_gcc_128 [default]        OPENSSL_NO_EC_NISTP_64_GCC_128
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    egd                 [default]        OPENSSL_NO_EGD
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    external-tests      [default]        OPENSSL_NO_EXTERNAL_TESTS
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    fips                [default]        
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    fips-securitychecks [cascade]        OPENSSL_NO_FIPS_SECURITYCHECKS
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    fuzz-afl            [default]        OPENSSL_NO_FUZZ_AFL
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    fuzz-libfuzzer      [default]        OPENSSL_NO_FUZZ_LIBFUZZER
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ktls                [default]        OPENSSL_NO_KTLS
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    md2                 [default]        OPENSSL_NO_MD2 (skip crypto/md2)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    msan                [default]        OPENSSL_NO_MSAN
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    rc5                 [default]        OPENSSL_NO_RC5 (skip crypto/rc5)
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    sctp                [default]        OPENSSL_NO_SCTP
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    tfo                 [default]        OPENSSL_NO_TFO
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    trace               [default]        OPENSSL_NO_TRACE
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ubsan               [default]        OPENSSL_NO_UBSAN
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    unit-test           [default]        OPENSSL_NO_UNIT_TEST
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    uplink              [no uplink_arch] OPENSSL_NO_UPLINK
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    weak-ssl-ciphers    [default]        OPENSSL_NO_WEAK_SSL_CIPHERS
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    zlib                [default]        OPENSSL_NO_ZLIB
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    zlib-dynamic        [default]        OPENSSL_NO_ZLIB_DYNAMIC
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    zstd                [default]        OPENSSL_NO_ZSTD
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    zstd-dynamic        [default]        OPENSSL_NO_ZSTD_DYNAMIC
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ssl3                [default]        OPENSSL_NO_SSL3
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ssl3-method         [default]        OPENSSL_NO_SSL3_METHOD
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Config target attributes:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    AR =&gt; &#34;ar&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ARFLAGS =&gt; &#34;qc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CC =&gt; &#34;gcc&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CFLAGS =&gt; &#34;-Wall -O3&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CXX =&gt; &#34;g++&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CXXFLAGS =&gt; &#34;-Wall -O3&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    HASHBANGPERL =&gt; &#34;/usr/bin/env perl&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RANLIB =&gt; &#34;ranlib&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RC =&gt; &#34;windres&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    asm_arch =&gt; &#34;riscv64&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    bn_ops =&gt; &#34;SIXTY_FOUR_BIT_LONG RC4_CHAR&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    build_file =&gt; &#34;Makefile&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    build_scheme =&gt; [ &#34;unified&#34;, &#34;unix&#34; ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cflags =&gt; &#34;-pthread&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cppflags =&gt; &#34;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    cxxflags =&gt; &#34;-std=c++11 -pthread&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    defines =&gt; [ &#34;OPENSSL_BUILDING_OPENSSL&#34; ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    disable =&gt; [  ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dso_ldflags =&gt; &#34;-Wl,-z,defs&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    dso_scheme =&gt; &#34;dlfcn&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    enable =&gt; [ &#34;afalgeng&#34; ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ex_libs =&gt; &#34;-ldl -pthread&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    includes =&gt; [  ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    lflags =&gt; &#34;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    lib_cflags =&gt; &#34;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    lib_cppflags =&gt; &#34;-DOPENSSL_USE_NODELETE&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    lib_defines =&gt; [  ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    module_cflags =&gt; &#34;-fPIC&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    module_cxxflags =&gt; undef,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    module_ldflags =&gt; &#34;-Wl,-znodelete -shared -Wl,-Bsymbolic&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    perl_platform =&gt; &#34;Unix&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    perlasm_scheme =&gt; &#34;linux64&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_cflag =&gt; &#34;-fPIC&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_defflag =&gt; &#34;-Wl,--version-script=&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_defines =&gt; [  ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_ldflag =&gt; &#34;-Wl,-znodelete -shared -Wl,-Bsymbolic&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_rcflag =&gt; &#34;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_sonameflag =&gt; &#34;-Wl,-soname=&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    shared_target =&gt; &#34;linux-shared&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    thread_defines =&gt; [  ],
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    thread_scheme =&gt; &#34;pthreads&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    unistd =&gt; &#34;&lt;unistd.h&gt;&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Recorded environment:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    AR = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    BUILDFILE = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CC = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CPPFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CROSS_COMPILE = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CXX = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CXXFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    HASHBANGPERL = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    LDFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    LDLIBS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    OPENSSL_LOCAL_CONFIG_DIR = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    PERL = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RANLIB = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RC = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RCFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    WINDRES = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_CFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_CPPDEFINES = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_CPPFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_CPPINCLUDES = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_CXXFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_LDFLAGS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    __CNF_LDLIBS = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">Makevars:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    AR              = /opt/riscvx/bin/riscv64-unknown-linux-gnu-ar
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ARFLAGS         = qc
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ASFLAGS         = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CC              = /opt/riscvx/bin/riscv64-unknown-linux-gnu-gcc
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CFLAGS          = -Wall -O3 -march=rv64gcv_zkne_zknd_zknh_zvkng_zvksg
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CPPDEFINES      = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CPPFLAGS        = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CPPINCLUDES     = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CROSS_COMPILE   = /opt/riscvx/bin/riscv64-unknown-linux-gnu-
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CXX             = /opt/riscvx/bin/riscv64-unknown-linux-gnu-g++
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    CXXFLAGS        = -Wall -O3 -march=rv64gcv_zkne_zknd_zknh_zvkng_zvksg
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    HASHBANGPERL    = /usr/bin/env perl
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    LDFLAGS         = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    LDLIBS          = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    PERL            = /usr/bin/perl
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RANLIB          = /opt/riscvx/bin/riscv64-unknown-linux-gnu-ranlib
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RC              = /opt/riscvx/bin/riscv64-unknown-linux-gnu-windres
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    RCFLAGS         = 
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">NOTE: These variables only represent the configuration view.  The build file
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">template may have processed these variables further, please have a look at the
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">build file for more exact data:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    Makefile
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">build file:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    Makefile
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">build file templates:
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#000;font-style:italic">    ../vendor/openssl/Configurations/common0.tmpl
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">    ../vendor/openssl/Configurations/unix-Makefile.tmpl
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> make
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">...
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">opt/riscvx/lib/gcc/riscv64-unknown-linux-gnu/14.0.1/../../../../riscv64-unknown-linux-gnu/bin/ld: cannot find -ldl: No such file or directory
</span></span></span></code></pre></div><p>The error is in the linking phase, since we did not provide the correct sysroot and path information needed by the crosscompiling linker.</p>
<p>A quick check of the object files generated includes:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span>  find . -name <span style="color:#4e9a06">\*</span>risc<span style="color:#4e9a06">\*</span>.o
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sm4/libcrypto-lib-sm4-riscv64-zvksed.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sm4/libcrypto-shlib-sm4-riscv64-zvksed.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-lib-aes-riscv64-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-shlib-aes-riscv64-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-shlib-aes-riscv64-zvbb-zvkg-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-shlib-aes-riscv64-zkn.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-lib-aes-riscv64-zkn.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-shlib-aes-riscv64-zvkb-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-shlib-aes-riscv64.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-lib-aes-riscv64-zvkb-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-lib-aes-riscv64-zvbb-zvkg-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/aes/libcrypto-lib-aes-riscv64.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/chacha/libcrypto-shlib-chacha_riscv.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/chacha/libcrypto-lib-chacha_riscv.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/chacha/libcrypto-lib-chacha-riscv64-zvkb.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/chacha/libcrypto-shlib-chacha-riscv64-zvkb.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/libcrypto-shlib-riscv64cpuid.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/libcrypto-lib-riscv64cpuid.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sha/libcrypto-lib-sha_riscv.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sha/libcrypto-lib-sha256-riscv64-zvkb-zvknha_or_zvknhb.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sha/libcrypto-shlib-sha512-riscv64-zvkb-zvknhb.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sha/libcrypto-shlib-sha_riscv.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sha/libcrypto-shlib-sha256-riscv64-zvkb-zvknha_or_zvknhb.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sha/libcrypto-lib-sha512-riscv64-zvkb-zvknhb.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sm3/libcrypto-lib-sm3-riscv64-zvksh.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sm3/libcrypto-lib-sm3_riscv.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sm3/libcrypto-shlib-sm3-riscv64-zvksh.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/sm3/libcrypto-shlib-sm3_riscv.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/libcrypto-shlib-riscvcap.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-shlib-ghash-riscv64.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-shlib-ghash-riscv64-zvkg.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-lib-aes-gcm-riscv64-zvkb-zvkg-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-lib-ghash-riscv64.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-shlib-ghash-riscv64-zvkb-zvbc.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-lib-ghash-riscv64-zvkg.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-shlib-aes-gcm-riscv64-zvkb-zvkg-zvkned.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/modes/libcrypto-lib-ghash-riscv64-zvkb-zvbc.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">./crypto/libcrypto-lib-riscvcap.o
</span></span></span></code></pre></div><p>That suggests we need to cover more extensions:</p>
<ul>
<li>vbb</li>
<li>vbc</li>
<li>vkb</li>
<li>vkg</li>
<li>vkned</li>
</ul>
<p>The openssl source code conditionally defines symbols like:</p>
<ul>
<li>RISCV_HAS_V</li>
<li>RISCV_HAS_ZVBC</li>
<li>RISCV_HAS_ZVKB</li>
<li>RISCV_HAS_ZVKNHA</li>
<li>RISCV_HAS_ZVKNHB</li>
<li>RISCV_HAS_ZVKSH</li>
<li>RISCV_HAS_ZBKB</li>
<li>RISCV_HAS_ZBB</li>
<li>RISCV_HAS_ZBC</li>
<li>RISCV_HAS_ZKND</li>
<li>RISCV_HAS_ZKNE</li>
<li>RISCV_HAS_ZVKG - currently missing, or a union of zvkng and zvksg?</li>
<li>RISCV_HAS_ZVKNED - currently missing or a union of zvkned and zvksed?</li>
<li>RISCV_HAS_ZVKSED - currently missing, defined but unused?</li>
</ul>
<p>These symbols are defined in <code>crypto/riscvcap.c</code> after analyzing the <code>march</code> string passed to the compiler.</p>
<p>So the next steps include:</p>
<ul>
<li>Define <code>LDFLAGS</code> and <code>LDLIBS</code> to enable building a riscv-64 <code>openssl.so</code>.</li>
<li>add additional march elements to generate as many ISA extension exemplars as we can</li>
<li>iterate on Ghidra sinc files to define any missing instructions</li>
<li>extend riscv-64 assembly samples to include all riscv-64 ISA extensions appearing in openssl source</li>
<li>verify that we have acceptable pcode opcodes for all riscv-64 ISA extensions appearing in openssl source</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> build_openssl$../vendor/openssl/Configure linux64-riscv64 --cross-compile-prefix<span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscvx/bin/riscv64-unknown-linux-gnu- -march<span style="color:#ce5c00;font-weight:bold">=</span>rv64gcv_zkne_zknd_zknh_zvkng_zvbb_zvbc_zvkb_zvkg_zvkned_zvksg
</span></span></code></pre></div><p>Patch the generated Makefile to:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>&lt; CNF_EX_LIBS=-ldl -pthread
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>&gt; CNF_EX_LIBS=/opt/riscvx/lib/libdl.a -pthread
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> make
</span></span></code></pre></div><ul>
<li>open <code>libcrypto.so.3</code> and <code>libssl.so.3</code> in Ghidra.</li>
<li>analyze and open bookmarks</li>
<li>verify - in the Bookmarks window - that all instructions disassembled and no instructions lack pcode</li>
</ul>
<h2 id="integration-testing-manual">Integration testing (manual)</h2>
<p>Disassembly testing against binutils reference dumps can follow these steps:</p>
<ul>
<li>Open <code>libcrypt.so.3</code> in Ghidra</li>
<li>export as ASCII to <code>/tmp/libcrypto.so.3.txt</code></li>
<li>export as C/C++ to <code>/tmp/libcrypto.so.3.c</code></li>
<li>generate reference disassembly via
<ul>
<li><code>/opt/riscvx/bin/riscv64-unknown-linux-gnu-objdump -j .text -D libcrypto.so.3 &gt; libcrypto.so.3_ref.txt</code></li>
</ul>
</li>
<li>grep both <code>/tmp/libcrypto.so.3.txt</code> and <code>libcrypto.so.3_ref.txt</code> for <code>vset</code> instructions, comparing operands</li>
<li>optionally parse vector instructions out of both files and compare decodings</li>
</ul>
<h2 id="inspect-extension-management">inspect extension management</h2>
<p>How does Openssl manage RISCV ISA extensions?  We&rsquo;ll use the <code>gcm_ghash</code> family of functions as examples.</p>
<ul>
<li>At compile time any <code>march=rv64gcv_z...</code> arguments are processed by the Openssl configuration tool and
turned into <code>#ifdef</code> variables. These can include combinations like <code>RISCV_HAS_ZVKB_AND_ZVKSED</code>.
Multiple versions of key routines are compiled, each with different required extensions.</li>
<li>The compiler can also use any of the bit manipulation and vector extensions in local optimization.</li>
<li>At runtime the library queries the underlying system to see which extensions are supported.  The function
<code>gcm_get_funcs</code> returns the preferred set of implementing functions.  The <code>gcm_ghash</code> set can include:
<ul>
<li><code>gcm_ghash_4bit</code></li>
<li><code>gcm_ghash_rv64i_zvkb_zvbc</code></li>
<li><code>gcm_ghash_rv64i_zvkg</code></li>
<li><code>gcm_ghash_rv64i_zbc</code></li>
<li><code>gcm_ghash_rv64i_zbc__zbkb</code></li>
</ul>
</li>
</ul>
<p>The <code>gcm_ghash_4bit</code> is the default version with 412 instructions, of which 11 are vector instructions inserted by the compiler.</p>
<p>The <code>gcm_ghash_rv64i_zvkg</code> is the most advanced version with only 32 instructions.  Ghidra decompiles this as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">gcm_ghash_rv64i_zvkg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined8</span> <span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">undefined8</span> <span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">param_4</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar2</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e32m1tumu</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">param_3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param_3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">param_4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param_4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vghsh_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_4</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vse32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>That shows an error in our sinc files - several instructions use the vd register as both an input and an output, so our
pcode semantics need updating.  Do this and inspect the Ghidra output again:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">gcm_ghash_rv64i_zvkg</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undefined8</span> <span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">undefined8</span> <span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">,</span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">param_4</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar1</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar2</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">undefined</span> <span style="color:#000">auVar3</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vsetivli_e32m1tumu</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">auVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vle32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">param_3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param_3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">param_4</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">param_4</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">0x10</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">auVar1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">vghsh_vv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">auVar3</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">param_4</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">vse32_v</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auVar1</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">param_1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>That&rsquo;s better - commit and push.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-61d8d612fe445078900e0844403305ae">7 - Building a gcc-14 toolchain</h1>
    
	

<div class="pageinfo pageinfo-primary">
<p>Building a new toolchain can be messy.</p>

</div>

<p>A C or C++ toolchain needs at least three components:</p>
<ul>
<li>kernel - to supply key header files and loader dependencies</li>
<li>binutils - to supply assembler and linker</li>
<li>gcc - to supply the compiler and compiler dependencies</li>
<li>glibc - to supply key libraries and header files</li>
<li>sysroot - a directory containing the libraries and resources expected for the root of the target system</li>
</ul>
<p>These components have cross-dependencies.  A full gcc build needs libc.so from glibc.  A full glibc build needs libgcc from gcc.
There are different ways to handle these cross-dependencies, such as splitting the gcc build into two phases or prepopulating
the build directories with &lsquo;close-enough&rsquo; files from a previous build.</p>
<p>The <code>sysroot</code> component is the trickiest to handle, since gcc and glibc need to pull files from the <code>sysroot</code> as they update files within <code>sysroot</code>.
You can generally start with a bootstrap <code>sysroot</code>, say from a previous toolchain, then update it with the latest binutils, gcc, and glibc.</p>
<p>Start with a released tarball for gcc and glibc.  We&rsquo;ll use the development tip of binutils for this pass.</p>
<p>Copy kernel header files into <code>/opt/riscv/sysroot/usr/include/</code>.</p>
<p>Configure and install binutils:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> /home2/vendor/binutils-gdb/configure --prefix<span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscv/sysroot --with-sysroot<span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscv/sysroot --target<span style="color:#ce5c00;font-weight:bold">=</span>riscv64-unknown-linux-gnu
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make -j4
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make install
</span></span></code></pre></div><p>Configure and install minimal gcc:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> /home2/vendor/gcc-14.1.0/configure --prefix<span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscv --enable-languages<span style="color:#ce5c00;font-weight:bold">=</span>c,c++ --disable-multilib --target<span style="color:#ce5c00;font-weight:bold">=</span>riscv64-unknown-linux-gnu --with-sysroot<span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscv/sysroot
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make all-gcc
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make install-gcc
</span></span></code></pre></div><p>Configure and install glibc</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> ../../vendor/glibc-2.39/configure --host<span style="color:#ce5c00;font-weight:bold">=</span>riscv64-unknown-linux-gnu --target<span style="color:#ce5c00;font-weight:bold">=</span>riscv64-unknown-linux-gnu --prefix<span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscv --disable-werror --enable-shared --disable-multilib --with-headers<span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscv/sysroot/usr/include
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> make install-bootstrap-headers<span style="color:#ce5c00;font-weight:bold">=</span>yes <span style="color:#000">install_root</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscv/sysroot install-headers
</span></span></code></pre></div><h2 id="cleaning-sysroot-of-bootstrap-artifacts">Cleaning sysroot of bootstrap artifacts</h2>
<p>How do we replace any older sysroot bootstrap files with their freshly built versions?  The most common problems involve libgcc*, libc*, and crt* files.
The bootstrap sysroot needs these files to exist.  The toolchain build process should replace them, but it may not replace all instances of these files.</p>
<p>Let&rsquo;s scrub the libgcc files, comparing the gcc directory in which they are built with the sysroot directories in which they will be saved.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> <span style="color:#000">B</span><span style="color:#ce5c00;font-weight:bold">=</span>/home2/build_riscv/gcc
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> <span style="color:#000">S</span><span style="color:#ce5c00;font-weight:bold">=</span>/opt/riscv/sysroot
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> find <span style="color:#000">$B</span> <span style="color:#000">$S</span> -name libgcc_s.so -ls
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940911      4 -rw-r--r--   1 ____     ____          132 May 10 12:28 /home2/build_riscv/gcc/gcc/libgcc_s.so
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940908      4 -rw-r--r--   1 ____     ____          132 May 10 12:28 /home2/build_riscv/gcc/riscv64-unknown-linux-gnu/libgcc/libgcc_s.so
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14361792      4 -rw-r--r--   1 ____     ____          132 May 10 12:32 /opt/riscv/sysroot/riscv64-unknown-linux-gnu/lib/libgcc_s.so
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14351655      4 -rw-r--r--   1 ____     ____          132 May 10 08:52 /opt/riscv/sysroot/lib/libgcc_s.so
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> $ diff /opt/riscv/sysroot/lib/libgcc_s.so /opt/riscv/sysroot/riscv64-unknown-linux-gnu/lib/libgcc_s.so
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> $ $ cat /opt/riscv/sysroot/lib/libgcc_s.so
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">/* GNU ld script
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">   Use the shared library, but some functions are only in
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">   the static library.  */
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic">GROUP ( libgcc_s.so.1 -lgcc )
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"></span><span style="color:#8f5902">$</span> 
</span></span></code></pre></div><ul>
<li><code>/opt/riscv/sysroot/lib/libgcc_s.so</code> is our bootstrap input</li>
<li><code>/home2/build_riscv/gcc/gcc/libgcc_s.so</code> and <code>/home2/build_riscv/gcc/riscv64-unknown-linux-gnu/libgcc/libgcc_s.so</code> are the generated outputs</li>
<li>the bootstrap input is identical to the generate output</li>
<li>neither input nor output contain absolute paths</li>
</ul>
<p>Now check <code>libgcc_s.so.1</code> for staleness:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> find <span style="color:#000">$B</span> <span style="color:#000">$S</span> -name libgcc_s.so.1 -ls
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940910    700 -rw-r--r--   1 ____     ____       713128 May 10 12:28 /home2/build_riscv/gcc/gcc/libgcc_s.so.1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57946454    700 -rwxr-xr-x   1 ____     ____       713128 May 10 12:28 /home2/build_riscv/gcc/riscv64-unknown-linux-gnu/libgcc/libgcc_s.so.1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14361791    700 -rw-r--r--   1 ____     ____       713128 May 10 12:32 /opt/riscv/sysroot/riscv64-unknown-linux-gnu/lib/libgcc_s.so.1
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14351656    696 -rw-r--r--   1 ____     ____       708624 May 10 08:53 /opt/riscv/sysroot/lib/libgcc_s.so.1
</span></span></span></code></pre></div><p>That looks like a potential problem.  The older bootstrap file is older and smaller than the generated files.  We need to fix that:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> rm /opt/riscv/sysroot/lib/libgcc_s.so.1
</span></span><span style="display:flex;"><span><span style="color:#8f5902">$</span> ln /opt/riscv/sysroot/riscv64-unknown-linux-gnu/lib/libgcc_s.so.1 /opt/riscv/sysroot/lib/libgcc_s.so.1
</span></span></code></pre></div><p>Next check the crt* files:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-console" data-lang="console"><span style="display:flex;"><span><span style="color:#8f5902">$</span> find <span style="color:#000">$B</span> <span style="color:#000">$S</span> -name crt<span style="color:#4e9a06">\*</span>.o -ls
</span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940817      8 -rw-r--r--   1 ____     ____         4248 May 10 12:28 /home2/build_riscv/gcc/gcc/crtbeginS.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940826      4 -rw-r--r--   1 ____     ____          848 May 10 12:28 /home2/build_riscv/gcc/gcc/crtn.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940824      4 -rw-r--r--   1 ____     ____          848 May 10 12:28 /home2/build_riscv/gcc/gcc/crti.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940827      8 -rw-r--r--   1 ____     ____         4712 May 10 12:28 /home2/build_riscv/gcc/gcc/crtbeginT.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940822      4 -rw-r--r--   1 ____     ____         1384 May 10 12:28 /home2/build_riscv/gcc/gcc/crtendS.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940823      4 -rw-r--r--   1 ____     ____         1384 May 10 12:28 /home2/build_riscv/gcc/gcc/crtend.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940815      4 -rw-r--r--   1 ____     ____         3640 May 10 12:28 /home2/build_riscv/gcc/gcc/crtbegin.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940800      8 -rw-r--r--   1 ____     ____         4248 May  9 16:00 /home2/build_riscv/gcc/riscv64-unknown-linux-gnu/libgcc/crtbeginS.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940808      4 -rw-r--r--   1 ____     ____          848 May  9 16:00 /home2/build_riscv/gcc/riscv64-unknown-linux-gnu/libgcc/crtn.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940806      4 -rw-r--r--   1 ____     ____          848 May  9 16:00 /home2/build_riscv/gcc/riscv64-unknown-linux-gnu/libgcc/crti.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940803      8 -rw-r--r--   1 ____     ____         4712 May  9 16:00 /home2/build_riscv/gcc/riscv64-unknown-linux-gnu/libgcc/crtbeginT.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940812      4 -rw-r--r--   1 ____     ____         1384 May  9 16:00 /home2/build_riscv/gcc/riscv64-unknown-linux-gnu/libgcc/crtendS.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940804      4 -rw-r--r--   1 ____     ____         1384 May  9 16:00 /home2/build_riscv/gcc/riscv64-unknown-linux-gnu/libgcc/crtend.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 57940798      4 -rw-r--r--   1 ____     ____         3640 May  9 16:00 /home2/build_riscv/gcc/riscv64-unknown-linux-gnu/libgcc/crtbegin.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14351609     16 -rw-r--r--   1 ____     ____        13848 May 10 08:48 /opt/riscv/sysroot/usr/lib/crt1.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14351614      4 -rw-r--r--   1 ____     ____          952 May 10 08:48 /opt/riscv/sysroot/usr/lib/crti.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14351623      4 -rw-r--r--   1 ____     ____          952 May 10 08:49 /opt/riscv/sysroot/usr/lib/crtn.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14361798      8 -rw-r--r--   1 ____     ____         4248 May 10 12:32 /opt/riscv/sysroot/lib/gcc/riscv64-unknown-linux-gnu/14.1.0/crtbeginS.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14361802      4 -rw-r--r--   1 ____     ____         3640 May 10 12:32 /opt/riscv/sysroot/lib/gcc/riscv64-unknown-linux-gnu/14.1.0/crtbegin.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14361803      4 -rw-r--r--   1 ____     ____         1384 May 10 12:32 /opt/riscv/sysroot/lib/gcc/riscv64-unknown-linux-gnu/14.1.0/crtend.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14361804      4 -rw-r--r--   1 ____     ____          848 May 10 12:32 /opt/riscv/sysroot/lib/gcc/riscv64-unknown-linux-gnu/14.1.0/crti.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14361805      4 -rw-r--r--   1 ____     ____          848 May 10 12:32 /opt/riscv/sysroot/lib/gcc/riscv64-unknown-linux-gnu/14.1.0/crtn.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14361806      4 -rw-r--r--   1 ____     ____         1384 May 10 12:32 /opt/riscv/sysroot/lib/gcc/riscv64-unknown-linux-gnu/14.1.0/crtendS.o
</span></span></span><span style="display:flex;"><span><span style="color:#000;font-style:italic"> 14361807      8 -rw-r--r--   1 ____     ____         4712 May 10 12:32 /opt/riscv/sysroot/lib/gcc/riscv64-unknown-linux-gnu/14.1.0/crtbeginT.o
</span></span></span></code></pre></div><p>The files in <code>/opt/riscv/sysroot/usr/lib</code> are likely the bootstrap files.  The sysroot files are identical to the build files, with exceptions:</p>
<ul>
<li><code>crt1.o</code> is not generated by the gcc compiler build process.  It <em>may</em> be something provided by the kernel build.</li>
<li><code>crti.o</code> and <code>crtn.o</code> bootstrap files and generated files are different.  If we wanted to use this updated sysroot to build a 14.2.0 toolchain,
we probably want to use the newer versions.</li>
</ul>
<p>So replace the bootstrap <code>/opt/riscv/sysroot/usr/lib/crt*.o</code> with hard links to the generated files.</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        <ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        <span class="td-footer__copyright">&copy;
    2023&ndash;2024
    <span class="td-footer__authors">Thixotropist | <a href="https://creativecommons.org/licenses/by/4.0">CC BY 4.0</a> |</span></span><span class="td-footer__all_rights_reserved">All Rights Reserved</span><span class="ms-2"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a></span>
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/ghidra_import_tests/js/main.min.88ada60cfbccfad3e369423d9ebd9f7c08c7bdde5f07d26fee1a238bb3a19184.js" integrity="sha256-iK2mDPvM&#43;tPjaUI9nr2ffAjHvd5fB9Jv7hoji7OhkYQ=" crossorigin="anonymous"></script>
<script defer src="/ghidra_import_tests/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js" integrity="sha256-c0eKfUgHaYrtfjVesj&#43;YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin="anonymous"></script>
<script src='/ghidra_import_tests/js/tabpane-persist.js'></script>

  </body>
</html>
